{"version":3,"file":"pedigreejs.v3.0.0-rc8.min.js","sources":["../es/pedcache.js","../es/utils.js","../es/zoom.js","../es/pbuttons.js","../es/canrisk_file.js","../es/io.js","../es/twins.js","../es/popup_form.js","../es/widgets.js","../es/labels.js","../es/dragging.js","../es/pedigree.js","../es/extras.js"],"sourcesContent":["/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n//store a history of pedigree\r\n\r\nlet max_limit = 25;\r\nlet dict_cache = {};\r\n\r\n// test if browser storage is supported\r\nfunction has_browser_storage(opts) {\r\n\ttry {\r\n\t\tif(opts.store_type === 'array')\r\n\t\t\treturn false;\r\n\r\n\t\tif(opts.store_type !== 'local' && opts.store_type !== 'session' && opts.store_type !== undefined)\r\n\t\t\treturn false;\r\n\r\n\t\tlet mod = 'test';\r\n\t\tlocalStorage.setItem(mod, mod);\r\n\t\tlocalStorage.removeItem(mod);\r\n\t\treturn true;\r\n\t} catch(e) {\r\n\t\treturn false;\r\n\t}\r\n}\r\n\r\nfunction get_prefix(opts) {\r\n\treturn \"PEDIGREE_\"+opts.btn_target+\"_\";\r\n}\r\n\r\n// use dict_cache to store cache as an array\r\nfunction get_arr(opts) {\r\n\treturn dict_cache[get_prefix(opts)];\r\n}\r\n\r\nfunction get_browser_store(opts, item) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.getItem(item);\r\n\telse\r\n\t\treturn sessionStorage.getItem(item);\r\n}\r\n\r\nfunction set_browser_store(opts, name, item) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.setItem(name, item);\r\n\telse\r\n\t\treturn sessionStorage.setItem(name, item);\r\n}\r\n\r\n// clear all storage items\r\nfunction clear_browser_store(opts) {\r\n\tif(opts.store_type === 'local')\r\n\t\treturn localStorage.clear();\r\n\telse\r\n\t\treturn sessionStorage.clear();\r\n}\r\n\r\n// remove all storage items with keys that have the pedigree history prefix\r\nexport function clear_pedigree_data(opts) {\r\n\tlet prefix = get_prefix(opts);\r\n\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\r\n\tlet items = [];\r\n\tfor(let i = 0; i < store.length; i++){\r\n\t\tif(store.key(i).indexOf(prefix) === 0)\r\n\t\t\titems.push(store.key(i));\r\n\t}\r\n\tfor(let i = 0; i < items.length; i++)\r\n\t\tstore.removeItem(items[i]);\r\n}\r\n\r\nexport function get_count(opts) {\r\n\tlet count;\r\n\tif (has_browser_storage(opts))\r\n\t\tcount = get_browser_store(opts, get_prefix(opts)+'COUNT');\r\n\telse\r\n\t\tcount = dict_cache[get_prefix(opts)+'COUNT'];\r\n\tif(count !== null && count !== undefined)\r\n\t\treturn count;\r\n\treturn 0;\r\n}\r\n\r\nfunction set_count(opts, count) {\r\n\tif (has_browser_storage(opts))\r\n\t\tset_browser_store(opts, get_prefix(opts)+'COUNT', count);\r\n\telse\r\n\t\tdict_cache[get_prefix(opts)+'COUNT'] = count;\r\n}\r\n\r\nexport function init_cache(opts) {\r\n\tif(!opts.dataset)\r\n\t\treturn;\r\n\tlet count = get_count(opts);\r\n\tif (has_browser_storage(opts)) {   // local storage\r\n\t\tset_browser_store(opts, get_prefix(opts)+count, JSON.stringify(opts.dataset));\r\n\t} else {   // TODO :: array cache\r\n\t\tconsole.warn('Local storage not found/supported for this browser!', opts.store_type);\r\n\t\tmax_limit = 500;\r\n\t\tif(get_arr(opts) === undefined)\r\n\t\t\tdict_cache[get_prefix(opts)] = [];\r\n\t\tget_arr(opts).push(JSON.stringify(opts.dataset));\r\n\t}\r\n\tif(count < max_limit)\r\n\t\tcount++;\r\n\telse\r\n\t\tcount = 0;\r\n\tset_count(opts, count);\r\n}\r\n\r\nexport function nstore(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tfor(let i=max_limit; i>0; i--) {\r\n\t\t\tif(get_browser_store(opts, get_prefix(opts)+(i-1)) !== null)\r\n\t\t\t\treturn i;\r\n\t\t}\r\n\t} else {\r\n\t\treturn (get_arr(opts) && get_arr(opts).length > 0 ? get_arr(opts).length : -1);\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\nexport function current(opts) {\r\n\tlet current = get_count(opts)-1;\r\n\tif(current === -1)\r\n\t\tcurrent = max_limit;\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+current));\r\n\telse if(get_arr(opts))\r\n\t\treturn JSON.parse(get_arr(opts)[current]);\r\n}\r\n\r\nexport function last(opts) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tfor(let i=max_limit; i>0; i--) {\r\n\t\t\tlet it = get_browser_store(opts, get_prefix(opts)+(i-1));\r\n\t\t\tif(it !== null) {\r\n\t\t\t\tset_count(opts, i);\r\n\t\t\t\treturn JSON.parse(it);\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tlet arr = get_arr(opts);\r\n\t\tif(arr)\r\n\t\t\treturn JSON.parse(arr(arr.length-1));\r\n\t}\r\n\treturn undefined;\r\n}\r\n\r\nexport function previous(opts, previous) {\r\n\tif(previous === undefined)\r\n\t\tprevious = get_count(opts) - 2;\r\n\r\n\tif(previous < 0) {\r\n\t\tlet nst = nstore(opts);\r\n\t\tif(nst < max_limit)\r\n\t\t\tprevious = nst - 1;\r\n\t\telse\r\n\t\t\tprevious = max_limit - 1;\r\n\t}\r\n\tset_count(opts, previous + 1);\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+previous));\r\n\telse\r\n\t\treturn JSON.parse(get_arr(opts)[previous]);\r\n}\r\n\r\nexport function next(opts, next) {\r\n\tif(next === undefined)\r\n\t\tnext = get_count(opts);\r\n\tif(next >= max_limit)\r\n\t\tnext = 0;\r\n\r\n\tset_count(opts, parseInt(next) + 1);\r\n\tif(has_browser_storage(opts))\r\n\t\treturn JSON.parse(get_browser_store(opts, get_prefix(opts)+next));\r\n\telse\r\n\t\treturn JSON.parse(get_arr(opts)[next]);\r\n}\r\n\r\nexport function clear(opts) {\r\n\tif(has_browser_storage(opts))\r\n\t\tclear_browser_store(opts);\r\n\tdict_cache = {};\r\n}\r\n\r\n// zoom - store translation coords\r\nexport function setposition(opts, x, y, zoom) {\r\n\tif(has_browser_storage(opts)) {\r\n\t\tlet store = (opts.store_type === 'local' ? localStorage : sessionStorage);\r\n\t\tif(x) {\r\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_X', x);\r\n\t\t\tset_browser_store(opts, get_prefix(opts)+'_Y', y);\r\n\t\t} else {\r\n\t\t\tstore.removeItem(get_prefix(opts)+'_X');\r\n\t\t\tstore.removeItem(get_prefix(opts)+'_Y');\r\n\t\t}\r\n\r\n\t\tlet zoomName = get_prefix(opts)+'_ZOOM';\r\n\t\tif(zoom)\r\n\t\t\tset_browser_store(opts, zoomName, zoom);\r\n\t\telse\r\n\t\t\tstore.removeItem(zoomName);\r\n\t} else {\r\n\t\t//TODO\r\n\t}\r\n}\r\n\r\nexport function getposition(opts) {\r\n\tif(!has_browser_storage(opts) ||\r\n\t\t(localStorage.getItem(get_prefix(opts)+'_X') === null &&\r\n\t\t sessionStorage.getItem(get_prefix(opts)+'_X') === null))\r\n\t\treturn [null, null];\r\n\tlet pos = [ parseInt(get_browser_store(opts, get_prefix(opts)+'_X')),\r\n\t\t\t\tparseInt(get_browser_store(opts, get_prefix(opts)+'_Y')) ];\r\n\tif(get_browser_store(opts, get_prefix(opts)+'_ZOOM') !== null)\r\n\t\tpos.push(parseFloat(get_browser_store(opts, get_prefix(opts)+'_ZOOM')));\r\n\treturn pos;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Pedigree Tree Utils\r\nimport * as pedcache from './pedcache.js';\r\n\r\n\r\nexport let roots = {};\r\n\r\nexport function isIE() {\r\n\t let ua = navigator.userAgent;\r\n\t /* MSIE used to detect old browsers and Trident used to newer ones*/\r\n\t return ua.indexOf(\"MSIE \") > -1 || ua.indexOf(\"Trident/\") > -1;\r\n}\r\n\r\nexport function isEdge() {\r\n\t return navigator.userAgent.match(/Edge/g);\r\n}\r\n\r\nexport function create_err(err) {\r\n\tconsole.error(err);\r\n\treturn new Error(err);\r\n}\r\n\r\n// validate pedigree data\r\nexport function validate_pedigree(opts){\r\n\tif(opts.validate) {\r\n\t\tif (typeof opts.validate == 'function') {\r\n\t\t\tif(opts.DEBUG)\r\n\t\t\t\tconsole.log('CALLING CONFIGURED VALIDATION FUNCTION');\r\n\t\t\treturn opts.validate.call(this, opts);\r\n\t\t}\r\n\r\n\t\t// check consistency of parents sex\r\n\t\tlet uniquenames = [];\r\n\t\tlet famids = [];\r\n\t\tlet display_name;\r\n\t\tfor(let p=0; p<opts.dataset.length; p++) {\r\n\t\t\tif(!p.hidden) {\r\n\t\t\t\tif(opts.dataset[p].mother || opts.dataset[p].father) {\r\n\t\t\t\t\tdisplay_name = opts.dataset[p].display_name;\r\n\t\t\t\t\tif(!display_name)\r\n\t\t\t\t\t\tdisplay_name = 'unnamed';\r\n\t\t\t\t\tdisplay_name += ' (IndivID: '+opts.dataset[p].name+')';\r\n\t\t\t\t\tlet mother = opts.dataset[p].mother;\r\n\t\t\t\t\tlet father = opts.dataset[p].father;\r\n\t\t\t\t\tif(!mother || !father) {\r\n\t\t\t\t\t\tthrow create_err('Missing parent for '+display_name);\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tlet midx = getIdxByName(opts.dataset, mother);\r\n\t\t\t\t\tlet fidx = getIdxByName(opts.dataset, father);\r\n\t\t\t\t\tif(midx === -1)\r\n\t\t\t\t\t\tthrow create_err('The mother (IndivID: '+mother+') of family member '+\r\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\r\n\t\t\t\t\tif(fidx === -1)\r\n\t\t\t\t\t\tthrow create_err('The father (IndivID: '+father+') of family member '+\r\n\t\t\t\t\t\t\t\t\t\t display_name+' is missing from the pedigree.');\r\n\t\t\t\t\tif(opts.dataset[midx].sex !== \"F\")\r\n\t\t\t\t\t\tthrow create_err(\"The mother of family member \"+display_name+\r\n\t\t\t\t\t\t\t\t\" is not specified as female. All mothers in the pedigree must have sex specified as 'F'.\");\r\n\t\t\t\t\tif(opts.dataset[fidx].sex !== \"M\")\r\n\t\t\t\t\t\tthrow create_err(\"The father of family member \"+display_name+\r\n\t\t\t\t\t\t\t\t\" is not specified as male. All fathers in the pedigree must have sex specified as 'M'.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\r\n\t\t\tif(!opts.dataset[p].name)\r\n\t\t\t\tthrow create_err(display_name+' has no IndivID.');\r\n\t\t\tif($.inArray(opts.dataset[p].name, uniquenames) > -1)\r\n\t\t\t\tthrow create_err('IndivID for family member '+display_name+' is not unique.');\r\n\t\t\tuniquenames.push(opts.dataset[p].name);\r\n\r\n\t\t\tif($.inArray(opts.dataset[p].famid, famids) === -1 && opts.dataset[p].famid) {\r\n\t\t\t\tfamids.push(opts.dataset[p].famid);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tif(famids.length > 1) {\r\n\t\t\tthrow create_err('More than one family found: '+famids.join(\", \")+'.');\r\n\t\t}\r\n\t\t// warn if there is a break in the pedigree\r\n\t\tlet uc = unconnected(opts.dataset);\r\n\t\tif(uc.length > 0)\r\n\t\t\tconsole.warn(\"individuals unconnected to pedigree \", uc);\r\n\t}\r\n}\r\n\r\nexport function copy_dataset(dataset) {\r\n\tif(dataset[0].id) { // sort by id\r\n\t\tdataset.sort(function(a,b){return (!a.id || !b.id ? 0: (a.id > b.id) ? 1 : ((b.id > a.id) ? -1 : 0));});\r\n\t}\r\n\r\n\tlet disallowed = [\"id\", \"parent_node\"];\r\n\tlet newdataset = [];\r\n\tfor(let i=0; i<dataset.length; i++){\r\n\t\tlet obj = {};\r\n\t\tfor(let key in dataset[i]) {\r\n\t\t\tif(disallowed.indexOf(key) === -1)\r\n\t\t\t\tobj[key] = dataset[i][key];\r\n\t\t}\r\n\t\tnewdataset.push(obj);\r\n\t}\r\n\treturn newdataset;\r\n}\r\n\r\n// check if the object contains a key with a given prefix\r\nexport function prefixInObj(prefix, obj) {\r\n\tlet found = false;\r\n\tif(obj)\r\n\t\t$.each(obj, function(k, _n){\r\n\t\t\tif(k.indexOf(prefix+\"_\") === 0 || k === prefix) {\r\n\t\t\t\tfound = true;\r\n\t\t\t\treturn found;\r\n\t\t\t}\r\n\t\t});\r\n\treturn found;\r\n}\r\n\r\n/**\r\n *  Get formatted time or data & time\r\n */\r\nexport function getFormattedDate(time){\r\n\tlet d = new Date();\r\n\tif(time)\r\n\t\treturn ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\r\n\telse\r\n\t\treturn d.getFullYear() + \"-\" + ('0' + (d.getMonth() + 1)).slice(-2) + \"-\" + ('0' + d.getDate()).slice(-2) + \" \" + ('0' + d.getHours()).slice(-2) + \":\" + ('0' + d.getMinutes()).slice(-2) + \":\" + ('0' + d.getSeconds()).slice(-2);\r\n }\r\n\r\nfunction showDialog(title, msg, onConfirm, opts, dataset) {\r\n\tconst errModalEl = document.getElementById('errModal');\r\n\tconst modalTitle = errModalEl.querySelector('.modal-title');\r\n\tconst modalBodyInput = errModalEl.querySelector('.modal-body');\r\n\tif(onConfirm) {\r\n\t\t$('#errModal button.hidden').removeClass(\"hidden\");\r\n\t\t$('#errModal button:contains(\"OK\")').on( \"click\", function() {\r\n\t\t\tonConfirm(opts, dataset);\r\n\t\t\t$('#errModal button:contains(\"OK\")').off('click');\r\n\t\t});\r\n\t} else {\r\n\t\tconst cancelBtn = $('#errModal button:contains(\"CANCEL\")');\r\n\t\tif(!cancelBtn.hasClass(\"hidden\")) cancelBtn.addClass(\"hidden\");\r\n\t\t$('#errModal button:contains(\"OK\")').off('click');\r\n\t}\r\n\r\n\tmodalTitle.textContent = title;\r\n\tmodalBodyInput.textContent = msg;\r\n\t$(\"#errModal\").modal(\"show\");\r\n}\r\n\r\n/**\r\n * Show message or confirmation dialog.\r\n * @param title\t - dialog window title\r\n * @param msg\t   - message to diasplay\r\n * @param onConfirm - function to call in a confirmation dialog\r\n * @param opts\t  - pedigreejs options\r\n * @param dataset\t- pedigree dataset\r\n */\r\nexport function messages(title, msg, onConfirm, opts, dataset) {\r\n\ttry {\r\n\t\tif(onConfirm) {\r\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\r\n\t\t\t\t\tmodal: true,\r\n\t\t\t\t\ttitle: title,\r\n\t\t\t\t\twidth: 350,\r\n\t\t\t\t\tbuttons: {\r\n\t\t\t\t\t\t\"Sì\": function () {\r\n\t\t\t\t\t\t\t$(this).dialog('close');\r\n\t\t\t\t\t\t\tonConfirm(opts, dataset);\r\n\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\"No\": function () {\r\n\t\t\t\t\t\t\t$(this).dialog('close');\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t});\r\n\t\t} else {\r\n\t\t\t$('<div id=\"msgDialog\">'+msg+'</div>').dialog({\r\n\t\t\t\ttitle: title,\r\n\t\t\t\twidth: 350,\r\n\t\t\t\tbuttons: [{\r\n\t\t\t\t\ttext: \"OK\",\r\n\t\t\t\t\tclick: function() { $( this ).dialog( \"close\" );}\r\n\t\t\t\t}]\r\n\t\t\t});\r\n\t\t}\r\n\t} catch(err) {\r\n\t\tshowDialog(title, msg, onConfirm, opts, dataset);\r\n\t}\r\n}\r\n\r\n/**\r\n * Validate age and yob is consistent with current year. The sum of age and\r\n * yob should not be greater than or equal to current year. If alive the\r\n * absolute difference between the sum of age and year of birth and the\r\n * current year should be <= 1.\r\n * @param age\t- age in years.\r\n * @param yob\t- year of birth.\r\n * @param status - 0 = alive, 1 = dead.\r\n * @return true if age and yob are consistent with current year otherwise false.\r\n */\r\nexport function validate_age_yob(age, yob, status) {\r\n\tlet year = new Date().getFullYear();\r\n\tlet sum = parseInt(age) + parseInt(yob);\r\n\t// check status is an expected string\r\n\tif (status !== \"1\" && status !== \"0\")\r\n\t\treturn false\r\n\r\n\tif(status === \"1\") {   // deceased\r\n\t\treturn year >= sum;\r\n\t}\r\n\treturn Math.abs(year - sum) <= 1 && year >= sum;\r\n}\r\n\r\nexport function capitaliseFirstLetter(string) {\r\n\treturn string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n\r\n\r\nexport function makeid(len) {\r\n\tlet text = \"\";\r\n\tlet possible = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz\";\r\n\tfor( let i=0; i < len; i++ )\r\n\t\ttext += possible.charAt(Math.floor(Math.random() * possible.length));\r\n\treturn text;\r\n}\r\n\r\nexport function buildTree(opts, person, root, partnerLinks, id) {\r\n\tif (typeof person.children === typeof undefined)\r\n\t\tperson.children = getChildren(opts.dataset, person);\r\n\r\n\tif (typeof partnerLinks === typeof undefined) {\r\n\t\tpartnerLinks = [];\r\n\t\tid = 1;\r\n\t}\r\n\r\n\tlet nodes = flatten(root);\r\n\t//console.log('NAME='+person.name+' NO. CHILDREN='+person.children.length);\r\n\tlet partners = [];\r\n\t$.each(person.children, function(_i, child) {\r\n\t\t$.each(opts.dataset, function(_j, p) {\r\n\t\t\tif (((child.name === p.mother) || (child.name === p.father)) && child.id === undefined) {\r\n\t\t\t\tlet m = getNodeByName(nodes, p.mother);\r\n\t\t\t\tlet f = getNodeByName(nodes, p.father);\r\n\t\t\t\tm = (m !== undefined? m : getNodeByName(opts.dataset, p.mother));\r\n\t\t\t\tf = (f !== undefined? f : getNodeByName(opts.dataset, p.father));\r\n\t\t\t\tif(!contains_parent(partners, m, f))\r\n\t\t\t\t\tpartners.push({'mother': m, 'father': f});\r\n\t\t\t}\r\n\t\t});\r\n\t});\r\n\t$.merge(partnerLinks, partners);\r\n\r\n\t$.each(partners, function(_i, ptr) {\r\n\t\tlet mother = ptr.mother;\r\n\t\tlet father = ptr.father;\r\n\t\tmother.children = [];\r\n\t\tlet parent = {\r\n\t\t\t\tname : makeid(4),\r\n\t\t\t\thidden : true,\r\n\t\t\t\tparent : null,\r\n\t\t\t\tfather : father,\r\n\t\t\t\tmother : mother,\r\n\t\t\t\tchildren : getChildren(opts.dataset, mother, father)\r\n\t\t};\r\n\r\n\t\tlet midx = getIdxByName(opts.dataset, mother.name);\r\n\t\tlet fidx = getIdxByName(opts.dataset, father.name);\r\n\t\tif(!('id' in father) && !('id' in mother))\r\n\t\t\tid = setChildrenId(person.children, id);\r\n\r\n\t\t// look at grandparents index\r\n\t\tlet gp = get_grandparents_idx(opts.dataset, midx, fidx);\r\n\t\tif(gp.fidx < gp.midx) {\r\n\t\t\tfather.id = id++;\r\n\t\t\tparent.id = id++;\r\n\t\t\tmother.id = id++;\r\n\t\t} else {\r\n\t\t\tmother.id = id++;\r\n\t\t\tparent.id = id++;\r\n\t\t\tfather.id = id++;\r\n\t\t}\r\n\t\tid = updateParent(mother, parent, id, nodes, opts);\r\n\t\tid = updateParent(father, parent, id, nodes, opts);\r\n\t\tperson.children.push(parent);\r\n\t});\r\n\tid = setChildrenId(person.children, id);\r\n\r\n\t$.each(person.children, function(_i, p) {\r\n\t\tid = buildTree(opts, p, root, partnerLinks, id)[1];\r\n\t});\r\n\treturn [partnerLinks, id];\r\n}\r\n\r\n\r\n// update parent node and sort twins\r\nfunction updateParent(p, parent, id, nodes, opts) {\r\n\t// add to parent node\r\n\tif('parent_node' in p)\r\n\t\tp.parent_node.push(parent);\r\n\telse\r\n\t\tp.parent_node = [parent];\r\n\r\n\t// check twins lie next to each other\r\n\tif(p.mztwin || p.dztwins) {\r\n\t\tlet twins = getTwins(opts.dataset, p);\r\n\t\tfor(let i=0; i<twins.length; i++) {\r\n\t\t\tlet twin = getNodeByName(nodes, twins[i].name);\r\n\t\t\tif(twin)\r\n\t\t\t\ttwin.id = id++;\r\n\t\t}\r\n\t}\r\n\treturn id;\r\n}\r\n\r\nfunction setChildrenId(children, id) {\r\n\t// sort twins to lie next to each other\r\n\tchildren.sort(function(a, b) {\r\n\t\tif(a.mztwin && b.mztwin && a.mztwin === b.mztwin)\r\n\t\t\treturn 0;\r\n\t\telse if(a.dztwin && b.dztwin && a.dztwin === b.dztwin)\r\n\t\t\treturn 0;\r\n\t\telse if(a.mztwin || b.mztwin || a.dztwin || b.dztwin)\r\n\t\t\treturn 1;\r\n\t\treturn 0;\r\n\t});\r\n\r\n\t$.each(children, function(_i, p) {\r\n\t\tif(p.id === undefined) p.id = id++;\r\n\t});\r\n\treturn id;\r\n}\r\n\r\nexport function isProband(obj) {\r\n\treturn typeof $(obj).attr('proband') !== typeof undefined && $(obj).attr('proband') !== false;\r\n}\r\n\r\nexport function setProband(dataset, name, is_proband) {\r\n\t$.each(dataset, function(_i, p) {\r\n\t\tif (name === p.name)\r\n\t\t\tp.proband = is_proband;\r\n\t\telse\r\n\t\t\tdelete p.proband;\r\n\t});\r\n}\r\n\r\n//combine arrays ignoring duplicates\r\nfunction combineArrays(arr1, arr2) {\r\n\tfor(let i=0; i<arr2.length; i++)\r\n\t\tif($.inArray( arr2[i], arr1 ) === -1) arr1.push(arr2[i]);\r\n}\r\n\r\nfunction include_children(connected, p, dataset) {\r\n\tif($.inArray( p.name, connected ) === -1)\r\n\t\treturn;\r\n\tcombineArrays(connected, get_partners(dataset, p));\r\n\tlet children = getAllChildren(dataset, p);\r\n\t$.each(children, function( _child_idx, child ) {\r\n\t\tif($.inArray( child.name, connected ) === -1) {\r\n\t\t\tconnected.push(child.name);\r\n\t\t\tcombineArrays(connected, get_partners(dataset, child));\r\n\t\t}\r\n\t});\r\n}\r\n\r\n//get the partners for a given node\r\nexport function get_partners(dataset, anode) {\r\n\tlet ptrs = [];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet bnode = dataset[i];\r\n\t\tif(anode.name === bnode.mother && $.inArray(bnode.father, ptrs) === -1)\r\n\t\t\tptrs.push(bnode.father);\r\n\t\telse if(anode.name === bnode.father && $.inArray(bnode.mother, ptrs) === -1)\r\n\t\t\tptrs.push(bnode.mother);\r\n\t}\r\n\treturn ptrs;\r\n}\r\n\r\n//return a list of individuals that aren't connected to the target\r\nexport function unconnected(dataset){\r\n\tlet target = dataset[ getProbandIndex(dataset) ];\r\n\tif(!target){\r\n\t\tconsole.warn(\"No target defined\");\r\n\t\tif(dataset.length === 0) {\r\n\t\t\tthrow new Error(\"empty pedigree data set\");\r\n\t\t}\r\n\t\ttarget = dataset[0];\r\n\t}\r\n\tlet connected = [target.name];\r\n\tlet change = true;\r\n\tlet ii = 0;\r\n\twhile(change && ii < 200) {\r\n\t\tii++;\r\n\t\tlet nconnect = connected.length;\r\n\t\t$.each(dataset, function( _idx, p ) {\r\n\t\t\tif($.inArray( p.name, connected ) !== -1) {\r\n\t\t\t\t// check if this person or a partner has a parent\r\n\t\t\t\tlet ptrs = get_partners(dataset, p);\r\n\t\t\t\tlet has_parent = (p.name === target.name || !p.noparents);\r\n\t\t\t\tfor(let i=0; i<ptrs.length; i++){\r\n\t\t\t\t\tif(!getNodeByName(dataset, ptrs[i]).noparents)\r\n\t\t\t\t\t\thas_parent = true;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(has_parent){\r\n\t\t\t\t\tif(p.mother && $.inArray( p.mother, connected ) === -1)\r\n\t\t\t\t\t\tconnected.push(p.mother);\r\n\t\t\t\t\tif(p.father && $.inArray( p.father, connected ) === -1)\r\n\t\t\t\t\t\tconnected.push(p.father);\r\n\t\t\t\t}\r\n\t\t\t} else if( !p.noparents &&\r\n\t\t\t\t\t  ((p.mother && $.inArray( p.mother, connected ) !== -1) ||\r\n\t\t\t\t\t   (p.father && $.inArray( p.father, connected ) !== -1))){\r\n\t\t\t\tconnected.push(p.name);\r\n\t\t\t}\r\n\t\t\t// include any children\r\n\t\t\tinclude_children(connected, p, dataset);\r\n\t\t});\r\n\t\tchange = (nconnect !== connected.length);\r\n\t}\r\n\tlet names = $.map(dataset, function(val, _i){return val.name;});\r\n\treturn $.map(names, function(name, _i){return $.inArray(name, connected) === -1 ? name : null;});\r\n}\r\n\r\nexport function getProbandIndex(dataset) {\r\n\tlet proband;\r\n\t$.each(dataset, function(i, val) {\r\n\t\tif (isProband(val)) {\r\n\t\t\tproband = i;\r\n\t\t\treturn proband;\r\n\t\t}\r\n\t});\r\n\treturn proband;\r\n}\r\n\r\nexport function getChildren(dataset, mother, father) {\r\n\tlet children = [];\r\n\tlet names = [];\r\n\tif(mother.sex === 'F')\r\n\t\t$.each(dataset, function(_i, p) {\r\n\t\t\tif(mother.name === p.mother)\r\n\t\t\t\tif(!father || father.name === p.father) {\r\n\t\t\t\t\tif($.inArray(p.name, names) === -1){\r\n\t\t\t\t\t\tchildren.push(p);\r\n\t\t\t\t\t\tnames.push(p.name);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t});\r\n\treturn children;\r\n}\r\n\r\nfunction contains_parent(arr, m, f) {\r\n\tfor(let i=0; i<arr.length; i++)\r\n\t\tif(arr[i].mother === m && arr[i].father === f)\r\n\t\t\treturn true;\r\n\treturn false;\r\n}\r\n\r\n// get the mono/di-zygotic twin(s)\r\nexport function getTwins(dataset, person) {\r\n\tlet sibs = getSiblings(dataset, person);\r\n\tlet twin_type = (person.mztwin ? \"mztwin\" : \"dztwin\");\r\n\treturn $.map(sibs, function(p, _i){\r\n\t\treturn p.name !== person.name && p[twin_type] === person[twin_type] ? p : null;\r\n\t});\r\n}\r\n\r\n// get the siblings - sex is an optional parameter\r\n// for only returning brothers or sisters\r\nexport function getSiblings(dataset, person, sex) {\r\n\tif(person === undefined || !person.mother || person.noparents)\r\n\t\treturn [];\r\n\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\r\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\r\n\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the siblings + adopted siblings - sex is an optional parameter\r\n// for only returning brothers or sisters\r\nexport function getAllSiblings(dataset, person, sex) {\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn  p.name !== person.name && !('noparents' in p) && p.mother &&\r\n\t\t\t   (p.mother === person.mother && p.father === person.father) &&\r\n\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the adopted siblings of a given individual\r\nexport function getAdoptedSiblings(dataset, person) {\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn  p.name !== person.name && 'noparents' in p &&\r\n\t\t\t   (p.mother === person.mother && p.father === person.father) ? p : null;\r\n\t});\r\n}\r\n\r\nexport function getAllChildren(dataset, person, sex) {\r\n\treturn $.map(dataset, function(p, _i){\r\n\t\treturn !('noparents' in p) &&\r\n\t\t\t   (p.mother === person.name || p.father === person.name) &&\r\n\t\t\t   (!sex || p.sex === sex) ? p : null;\r\n\t});\r\n}\r\n\r\n// get the depth of the given person from the root\r\nexport function getDepth(dataset, name) {\r\n\tlet idx = getIdxByName(dataset, name);\r\n\tlet depth = 1;\r\n\r\n\twhile(idx >= 0 && ('mother' in dataset[idx] || dataset[idx].top_level)){\r\n\t\tidx = getIdxByName(dataset, dataset[idx].mother);\r\n\t\tdepth++;\r\n\t}\r\n\treturn depth;\r\n}\r\n\r\n// given an array of people get an index for a given person\r\nexport function getIdxByName(arr, name) {\r\n\tlet idx = -1;\r\n\t$.each(arr, function(i, p) {\r\n\t\tif (name === p.name) {\r\n\t\t\tidx = i;\r\n\t\t\treturn idx;\r\n\t\t}\r\n\t});\r\n\treturn idx;\r\n}\r\n\r\n// get the nodes at a given depth sorted by their x position\r\nexport function getNodesAtDepth(fnodes, depth, exclude_names) {\r\n\treturn $.map(fnodes, function(p, _i){\r\n\t\treturn p.depth === depth && !p.data.hidden && $.inArray(p.data.name, exclude_names) === -1 ? p : null;\r\n\t}).sort(function (a,b) {return a.x - b.x;});\r\n}\r\n\r\n// convert the partner names into corresponding tree nodes\r\nexport function linkNodes(flattenNodes, partners) {\r\n\tlet links = [];\r\n\tfor(let i=0; i< partners.length; i++)\r\n\t\tlinks.push({'mother': getNodeByName(flattenNodes, partners[i].mother.name),\r\n\t\t\t\t\t'father': getNodeByName(flattenNodes, partners[i].father.name)});\r\n\treturn links;\r\n}\r\n\r\n// get ancestors of a node\r\nexport function ancestors(dataset, node) {\r\n\tlet ancestors = [];\r\n\tfunction recurse(node) {\r\n\t\tif(node.data) node = node.data;\r\n\t\tif('mother' in node && 'father' in node && !('noparents' in node)){\r\n\t\t\trecurse(getNodeByName(dataset, node.mother));\r\n\t\t\trecurse(getNodeByName(dataset, node.father));\r\n\t\t}\r\n\t\tancestors.push(node);\r\n\t}\r\n\trecurse(node);\r\n\treturn ancestors;\r\n}\r\n\r\n// test if two nodes are consanguinous partners\r\nexport function consanguity(node1, node2, opts) {\r\n\tif(node1.depth !== node2.depth) // parents at different depths\r\n\t\treturn true;\r\n\tlet ancestors1 = ancestors(opts.dataset, node1);\r\n\tlet ancestors2 = ancestors(opts.dataset, node2);\r\n\tlet names1 = $.map(ancestors1, function(ancestor, _i){return ancestor.name;});\r\n\tlet names2 = $.map(ancestors2, function(ancestor, _i){return ancestor.name;});\r\n\tlet consanguity = false;\r\n\t$.each(names1, function( _index, name ) {\r\n\t\tif($.inArray(name, names2) !== -1){\r\n\t\t\tconsanguity = true;\r\n\t\t\treturn false;\r\n\t\t}\r\n\t});\r\n\treturn consanguity;\r\n}\r\n\r\n// return a flattened representation of the tree\r\nexport function flatten(root) {\r\n\tlet flat = [];\r\n\tfunction recurse(node) {\r\n\t\tif(node.children)\r\n\t\t\tnode.children.forEach(recurse);\r\n\t\tflat.push(node);\r\n\t}\r\n\trecurse(root);\r\n\treturn flat;\r\n}\r\n\r\n// Adjust D3 layout positioning.\r\n// Position hidden parent node centring them between father and mother nodes. Remove kinks\r\n// from links - e.g. where there is a single child plus a hidden child\r\nexport function adjust_coords(opts, root, flattenNodes) {\r\n\tfunction recurse(node) {\r\n\t\tif (node.children) {\r\n\t\t\tnode.children.forEach(recurse);\r\n\r\n\t\t\tif(node.data.father !== undefined) { \t// hidden nodes\r\n\t\t\t\tlet father = getNodeByName(flattenNodes, node.data.father.name);\r\n\t\t\t\tlet mother = getNodeByName(flattenNodes, node.data.mother.name);\r\n\t\t\t\tlet xmid = (father.x + mother.x) /2;\r\n\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.depth, [node.data.name])) {\r\n\t\t\t\t\tnode.x = xmid;   // centralise parent nodes\r\n\t\t\t\t\tlet diff = node.x - xmid;\r\n\t\t\t\t\tif(node.children.length === 2 && (node.children[0].data.hidden || node.children[1].data.hidden)) {\r\n\t\t\t\t\t\tif(!(node.children[0].data.hidden && node.children[1].data.hidden)) {\r\n\t\t\t\t\t\t\tlet child1 = (node.children[0].data.hidden ? node.children[1] : node.children[0]);\r\n\t\t\t\t\t\t\tlet child2 = (node.children[0].data.hidden ? node.children[0] : node.children[1]);\r\n\t\t\t\t\t\t\tif( ((child1.x < child2.x && xmid < child2.x) || (child1.x > child2.x && xmid > child2.x)) &&\r\n\t\t\t\t\t\t\t\t!overlap(opts, root.descendants(), xmid, child1.depth, [child1.data.name])){\r\n\t\t\t\t\t\t\t\tchild1.x = xmid;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else if(node.children.length === 1 && !node.children[0].data.hidden) {\r\n\t\t\t\t\t\tif(!overlap(opts, root.descendants(), xmid, node.children[0].depth, [node.children[0].data.name]))\r\n\t\t\t\t\t\t\tnode.children[0].x = xmid;\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tif(diff !== 0 && !nodesOverlap(opts, node, diff, root)){\r\n\t\t\t\t\t\t\tif(node.children.length === 1) {\r\n\t\t\t\t\t\t\t\tnode.children[0].x = xmid;\r\n\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\tlet descendants = node.descendants();\r\n\t\t\t\t\t\t\t\tif(opts.DEBUG)\r\n\t\t\t\t\t\t\t\t\tconsole.log('ADJUSTING '+node.data.name+' NO. DESCENDANTS '+descendants.length+' diff='+diff);\r\n\t\t\t\t\t\t\t\tfor(let i=0; i<descendants.length; i++) {\r\n\t\t\t\t\t\t\t\t\tif(node.data.name !== descendants[i].data.name)\r\n\t\t\t\t\t\t\t\t\t\tdescendants[i].x -= diff;\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t} else if((node.x < father.x && node.x < mother.x) || (node.x > father.x && node.x > mother.x)){\r\n\t\t\t\t\t\tnode.x = xmid;   // centralise parent nodes if it doesn't lie between mother and father\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\trecurse(root);\r\n\trecurse(root);\r\n}\r\n\r\n// test if moving siblings by diff overlaps with other nodes\r\nfunction nodesOverlap(opts, node, diff, root) {\r\n\tlet descendants = node.descendants();\r\n\tlet descendantsNames = $.map(descendants, function(descendant, _i){return descendant.data.name;});\r\n\tlet nodes = root.descendants();\r\n\tfor(let i=0; i<descendants.length; i++){\r\n\t\tlet descendant = descendants[i];\r\n\t\tif(node.data.name !== descendant.data.name){\r\n\t\t\tlet xnew = descendant.x - diff;\r\n\t\t\tif(overlap(opts, nodes, xnew, descendant.depth, descendantsNames))\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// test if x position overlaps a node at the same depth\r\nexport function overlap(opts, nodes, xnew, depth, exclude_names) {\r\n\tfor(let n=0; n<nodes.length; n++) {\r\n\t\tif(depth === nodes[n].depth && $.inArray(nodes[n].data.name, exclude_names) === -1){\r\n\t\t\tif(Math.abs(xnew - nodes[n].x) < (opts.symbol_size*1.15))\r\n\t\t\t\treturn true;\r\n\t\t}\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// given a persons name return the corresponding d3 tree node\r\nexport function getNodeByName(nodes, name) {\r\n\tfor (let i = 0; i < nodes.length; i++) {\r\n\t\tif(nodes[i].data && name === nodes[i].data.name)\r\n\t\t\treturn nodes[i];\r\n\t\telse if (name === nodes[i].name)\r\n\t\t\treturn nodes[i];\r\n\t}\r\n}\r\n\r\n// given the name of a url param get the value\r\nexport function urlParam(name){\r\n\tlet results = new RegExp('[?&]' + name + '=([^&#]*)').exec(window.location.href);\r\n\tif (results===null)\r\n\t   return null;\r\n\telse\r\n\t   return results[1] || 0;\r\n}\r\n\r\n// get grandparents index\r\nfunction get_grandparents_idx(dataset, midx, fidx) {\r\n\tlet gmidx = midx;\r\n\tlet gfidx = fidx;\r\n\twhile(  'mother' in dataset[gmidx] && 'mother' in dataset[gfidx] &&\r\n\t\t  !('noparents' in dataset[gmidx]) && !('noparents' in dataset[gfidx])){\r\n\t\tgmidx = getIdxByName(dataset, dataset[gmidx].mother);\r\n\t\tgfidx = getIdxByName(dataset, dataset[gfidx].mother);\r\n\t}\r\n\treturn {'midx': gmidx, 'fidx': gfidx};\r\n}\r\n\r\n// check by name if the individual exists\r\nexport function exists(opts, name){\r\n\treturn getNodeByName(pedcache.current(opts), name) !== undefined;\r\n}\r\n\r\n// print options and dataset\r\nexport function print_opts(opts){\r\n\t$(\"#pedigree_data\").remove();\r\n\t$(\"body\").append(\"<div id='pedigree_data'></div>\" );\r\n\tlet key;\r\n\tfor(let i=0; i<opts.dataset.length; i++) {\r\n\t\tlet person = \"<div class='row'><strong class='col-md-1 text-right'>\"+opts.dataset[i].name+\"</strong><div class='col-md-11'>\";\r\n\t\tfor(key in opts.dataset[i]) {\r\n\t\t\tif(key === 'name') continue;\r\n\t\t\tif(key === 'parent')\r\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key].name+\"; </span>\";\r\n\t\t\telse if (key === 'children') {\r\n\t\t\t\tif (opts.dataset[i][key][0] !== undefined)\r\n\t\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key][0].name+\"; </span>\";\r\n\t\t\t} else\r\n\t\t\t\tperson += \"<span>\"+key + \":\" + opts.dataset[i][key]+\"; </span>\";\r\n\t\t}\r\n\t\t$(\"#pedigree_data\").append(person + \"</div></div>\");\r\n\r\n\t}\r\n\t$(\"#pedigree_data\").append(\"<br /><br />\");\r\n\tfor(key in opts) {\r\n\t\tif(key === 'dataset') continue;\r\n\t\t$(\"#pedigree_data\").append(\"<span>\"+key + \":\" + opts[key]+\"; </span>\");\r\n\t}\r\n}\r\n\r\nexport function is_fullscreen(){\r\n\treturn (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement);\r\n}\r\n\r\n\r\nexport function get_svg_dimensions(opts) {\r\n\treturn {'width' : (is_fullscreen()? window.innerWidth  : opts.width),\r\n\t\t\t'height': (is_fullscreen()? window.innerHeight : opts.height)};\r\n}\r\n\r\nexport function get_tree_dimensions(opts) {\r\n\t// / get score at each depth used to adjust node separation\r\n\tlet svg_dimensions = get_svg_dimensions(opts);\r\n\tlet maxscore = 0;\r\n\tlet generation = {};\r\n\tfor(let i=0; i<opts.dataset.length; i++) {\r\n\t\tlet depth = getDepth(opts.dataset, opts.dataset[i].name);\r\n\t\tlet children = getAllChildren(opts.dataset, opts.dataset[i]);\r\n\r\n\t\t// score based on no. of children and if parent defined\r\n\t\tlet score = 1 + (children.length > 0 ? 0.55+(children.length*0.25) : 0) + (opts.dataset[i].father ? 0.25 : 0);\r\n\t\tif(depth in generation)\r\n\t\t\tgeneration[depth] += score;\r\n\t\telse\r\n\t\t\tgeneration[depth] = score;\r\n\r\n\t\tif(generation[depth] > maxscore)\r\n\t\t\tmaxscore = generation[depth];\r\n\t}\r\n\r\n\tlet max_depth = Object.keys(generation).length*opts.symbol_size*3.5;\r\n\tlet tree_width =  (svg_dimensions.width - opts.symbol_size > maxscore*opts.symbol_size*1.65 ?\r\n\t\t\t\t\t   svg_dimensions.width - opts.symbol_size : maxscore*opts.symbol_size*1.65);\r\n\tlet tree_height = (svg_dimensions.height - opts.symbol_size > max_depth ?\r\n\t\t\t\t\t   svg_dimensions.height - opts.symbol_size : max_depth);\r\n\treturn {'width': tree_width, 'height': tree_height};\r\n}\r\n\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {getposition, setposition} from './pedcache.js';\r\n\r\nlet zm;\r\n\r\n// initialise zoom and drag\r\nexport function init_zoom(opts, svg) {\r\n\t// offsets\r\n\tlet xi = opts.symbol_size/2;\r\n\tlet yi = -opts.symbol_size*2.5;\r\n\r\n\tzm = d3.zoom()\r\n\t  .scaleExtent([opts.zoomIn, opts.zoomOut])\r\n\t  .filter(function(e) {\r\n\t\t\tif(!opts.zoomSrc || opts.zoomSrc.indexOf('wheel') === -1) {\r\n\t\t\t\tif(e.type && e.type === 'wheel') return false\r\n\t\t\t}\r\n\t\t\t// ignore dblclick & secondary mouse buttons\r\n\t\t\treturn (e.type !== 'dblclick') && !e.button})\r\n\t  .on('zoom', function(e) { zooming(e, opts); });\r\n\tsvg.call(zm);\r\n\r\n\t// set initial position & scale\r\n\tlet xyk = getposition(opts);\t\t// cached position\r\n\tlet k = (xyk.length === 3 ? xyk[2] : 1);\r\n\tlet x = (xyk[0] !== null ? xyk[0]/k: (xi*k));\r\n\tlet y = (xyk[1] !== null ? xyk[1]/k: (yi*k));\r\n\r\n\tvar transform = d3.zoomIdentity\r\n      .scale(k)\r\n      .translate(x, y);\r\n    svg.call(zm.transform, transform);\r\n}\r\n\r\n// scale size the pedigree\r\nexport function btn_zoom(opts, scale) {\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\r\n\tsvg.transition().duration(50).call(zm.scaleBy, scale);\r\n}\r\n\r\nexport function scale_to_fit(opts) {\r\n\tlet d = get_dimensions(opts);\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv).select(\"svg\");\r\n\tlet size = get_svg_size(svg);\r\n\tlet f = 1;\r\n\tlet k = (f / Math.max(d.wid/size.w, d.hgt/size.h));\r\n\r\n\tif(k < opts.zoomIn) zm.scaleExtent([k, opts.zoomOut]);\r\n\r\n\tlet ped = get_pedigree_center(opts);\r\n\tsvg.call(zm.translateTo, ped.x-(opts.symbol_size), ped.y-(opts.symbol_size));\r\n\tsetTimeout(function(){svg.transition().duration(700).call(zm.scaleTo, k)}, 400);\r\n}\r\n\r\nfunction zooming(e, opts) {\r\n\t(opts.DEBUG && console.log(\"zoom\", e.transform));\r\n\tlet t = e.transform;\r\n\tlet k = (t.k && t.k !== 1 ? t.k : undefined);\r\n\tsetposition(opts, t.x, t.y, k);\r\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\r\n\tped.attr('transform', 'translate(' + t.x + ',' + t.y + ')' + (k ? ' scale(' + k + ')' : ''));\r\n}\r\n\r\nfunction get_pedigree_center(opts) {\r\n\tlet b = get_bounds(opts);\r\n\treturn {x: b.xmin+((b.xmax-b.xmin)/2), y: b.ymin+((b.ymax-b.ymin)/2)};\r\n}\r\n\r\n// find width/height of pedigree graphic\r\nfunction get_dimensions(opts) {\r\n\tlet b = get_bounds(opts);\r\n\treturn {wid: Math.abs(b.xmax-b.xmin), hgt: Math.abs(b.ymax-b.ymin)};\r\n}\r\n\r\n/**\r\n * Get the min/max boundary of the diagram\r\n */\r\nexport function get_bounds(opts) {\r\n\tlet ped = d3.select(\"#\"+opts.targetDiv).select(\".diagram\");\r\n\tlet xmin = Number.MAX_VALUE;\r\n\tlet xmax = -1000000;\r\n\tlet ymin = Number.MAX_VALUE;\r\n\tlet ymax = -1000000;\r\n\tlet sym = opts.symbol_size;\r\n\tped.selectAll('g').each(function(d, _i) {\r\n\t\tif(d.x && d.data.name !== 'hidden_root' && !d.data.hidden) {\r\n\t\t\tlet n = getNodeSize(opts, this, sym);\r\n\t\t\tif(d.x-sym < xmin) xmin = d.x-sym;\r\n\t\t\tif(d.x+n.w+sym > xmax) xmax = d.x+n.w+sym;\r\n\t\t\tif(d.y < ymin) ymin = d.y;\r\n\t\t\tif(d.y+n.h+sym > ymax) ymax = d.y+n.h+sym;\r\n\t\t}\r\n\t});\r\n\treturn {xmin:xmin, xmax:xmax, ymin:ymin, ymax:ymax};\r\n}\r\n\r\n/**\r\n * Get the size of an individual's graphical representation\r\n */\r\nfunction getNodeSize(opts, g_elm, sym) {\r\n\tlet node = d3.select(g_elm).node();\r\n\tlet dg = node.getBBox();\r\n\tlet w = dg.width;\r\n\tlet h = dg.height;\r\n\tif(w === 0 && h === 0) {\t// pedigree not shown yet (family history section not opened)\r\n\t\ttry {\r\n\t\t\tw = sym*2;\r\n\t\t\th = sym*2;\r\n\t\t\tlet text_elements = d3.select(g_elm).selectAll(\".indi_details\"); // get individuals details\r\n\t\t\tfor(let i=0; i<text_elements._groups[0].length; i++) {\r\n\t\t\t\tlet txt = text_elements._groups[0][i].firstChild.nodeValue;\r\n\t\t\t\tlet txtsize = getTextSize(txt, opts.font_family, opts.font_size);\r\n\t\r\n\t\t\t\tw = Math.max(txtsize.w+(sym/2), w);\r\n\t\t\t\th = Math.max((sym*2)+(i*txtsize.h), h);\r\n\t\t\t}\r\n\t\t} catch(err) {\r\n\t\t\tconsole.error(err);\r\n\t\t\tw = sym*2;\r\n\t\t\th = sym*2;\r\n\t\t}\r\n\t}\r\n\treturn {w:w, h:h};\r\n}\r\n\r\n/**\r\n * Calculate width and height of text\r\n */\r\nfunction getTextSize(txt, font, fontSize) {\r\n\t  let o = $('<div></div>')\r\n\t            .text(txt)\r\n\t            .css(\r\n\t\t\t\t\t{'position': 'absolute',\r\n\t\t\t\t\t 'float': 'left', 'white-space': 'nowrap', 'visibility': 'hidden',\r\n\t\t\t\t\t 'font': font || 'Helvetica',\r\n\t\t\t\t\t 'fontSize': fontSize || '1em'})\r\n\t            .appendTo($('body'));\r\n\t  let s = {w: o.width(), h:o.height()};\r\n\t  o.remove();\r\n\t  return s;\r\n}\r\n\r\nfunction get_svg_size(svg) {\r\n\treturn {w: svg.node().clientWidth, h:svg.node().clientHeight};\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// undo, redo, reset buttons\r\nimport * as pedcache from './pedcache.js';\r\nimport {btn_zoom, scale_to_fit} from './zoom.js';\r\nimport {copy_dataset, getProbandIndex, is_fullscreen, messages} from './utils.js';\r\n\r\nexport function addButtons(options) {\r\n\tlet opts = $.extend({\r\n        // defaults\r\n\t\tbtn_target: 'pedigree_history'\r\n    }, options );\r\n\r\n\tlet btns = [{\"fa\": \"fa-file-image\", \"title\": \"Scarica immagine PNG\"},\r\n\t\t\t\t{\"fa\": \"fa-undo\", \"title\": \"Indietro\"},\r\n\t\t\t\t{\"fa\": \"fa-redo\", \"title\": \"Avanti\"},\r\n\t\t\t\t{\"fa\": \"fa-refresh\", \"title\": \"Reimposta\"}];\r\n\r\n\tbtns.push({\"fa\": \"fa-crosshairs\", \"title\": \"Centra e adatta\"});\r\n\tif(opts.zoomSrc && (opts.zoomSrc.indexOf('button') > -1)) {\r\n\t\tif(opts.zoomOut !== 1)\r\n\t\t\tbtns.push({\"fa\": \"fa-minus-circle\", \"title\": \"Zoom out\"});\r\n\t\tif(opts.zoomIn !== 1)\r\n\t\t\tbtns.push({\"fa\": \"fa-plus-circle\", \"title\": \"Zoom in\"});\r\n\t}\r\n\tbtns.push({\"fa\": \"fa-arrows-alt\", \"title\": \"Schermo intero\"});\r\n\r\n\tlet lis = \"\";\r\n\tfor(let i=0; i<btns.length; i++) {\r\n\t\tlis += '<span>';\r\n\t\tlis += '<i class=\"fa fa-lg ' + btns[i].fa + ' pe-2\" aria-hidden=\"true\" title=\"'+ btns[i].title + '\"' +\r\n\t\t(btns[i].fa === \"fa-arrows-alt\" ? 'id=\"fullscreen\" ' : '') +\r\n\t\t'></i>';\r\n\r\n\t\tlis += '</span>';\r\n\t}\r\n\t$( \"#\"+opts.btn_target ).append(lis);\r\n\taddPbuttonEvents(opts);\r\n}\r\n\r\nfunction addPbuttonEvents(opts) {\r\n\t// fullscreen\r\n    $(document).on('webkitfullscreenchange mozfullscreenchange fullscreenchange MSFullscreenChange', function(_e)  {\r\n\t\tlet local_dataset = pedcache.current(opts);\r\n\t\tif (local_dataset !== undefined && local_dataset !== null) {\r\n\t\t\topts.dataset = local_dataset;\r\n\t\t}\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\tsetTimeout(function(){ scale_to_fit(opts); }, 500);\r\n    });\r\n\r\n\t$('#fullscreen').on('click', function(_e) {\r\n\t\t// toggle fullscreen\r\n\t\tif (!is_fullscreen()) {\r\n\t\t\tlet target = $(\"#\"+opts.targetDiv)[0];\r\n\t\t\tif (target.requestFullscreen) {\r\n                target.requestFullscreen();\r\n            } else if (document.documentElement.mozRequestFullScreen) {\r\n\t\t\t\ttarget.mozRequestFullScreen(); // Firefox\r\n            } else if (document.documentElement.webkitRequestFullscreen) {\r\n                target.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT); // Chrome and Safari\r\n            } else if (document.documentElement.msRequestFullscreen) {\r\n                target.msRequestFullscreen(); // IE\r\n            }\r\n\t\t} else {\r\n            if (document.exitFullscreen) {\r\n                document.exitFullscreen();\r\n            } else if (document.msExitFullscreen) {\r\n                document.msExitFullscreen();\r\n            } else if (document.mozCancelFullScreen) {\r\n                document.mozCancelFullScreen();\r\n            } else if (document.webkitExitFullscreen) {\r\n                document.webkitExitFullscreen();\r\n            }\r\n\t\t}\r\n\t});\r\n\r\n\t// press and hold to zoom in/out\r\n\tlet timeoutId = 0;\r\n\tfunction zoomIn() {btn_zoom(opts, 1.05);}\r\n\tfunction zoomOut() {btn_zoom(opts, 0.95);}\r\n\t$('.fa-plus-circle, .fa-minus-circle').on('mousedown', function() {\r\n\t    timeoutId = setInterval(($( this ).hasClass( \"fa-plus-circle\" ) ? zoomIn : zoomOut), 50);\r\n\t}).on('mouseup mouseleave', function() {\r\n\t    clearInterval(timeoutId);\r\n\t});\r\n\r\n\t// undo/redo/reset\r\n\t$( \"#\"+opts.btn_target ).on( \"click\", function(e) {\r\n\t\te.stopPropagation();\r\n\t\tif($(e.target).hasClass(\"fg-grey\"))\r\n\t\t\treturn false;\r\n\r\n\t\tif($(e.target).hasClass('fa-undo')) {\r\n\t\t\topts.dataset = pedcache.previous(opts);\r\n\t\t\t$(\"#\"+opts.targetDiv).empty();\r\n\t\t\t$(document).trigger('build', [opts]);\r\n\t\t} else if ($(e.target).hasClass('fa-redo')) {\r\n\t\t\topts.dataset = pedcache.next(opts);\r\n\t\t\t$(\"#\"+opts.targetDiv).empty();\r\n\t\t\t$(document).trigger('build', [opts]);\r\n\t\t} else if ($(e.target).hasClass('fa-refresh')) {\r\n\t\t\tmessages(\"Reimposta Pedigree\",\r\n\t\t\t         \"Questo può provocare la perdita di alcuni dati. Sei sicuro?\",\r\n\t\t\t         reset, opts);\r\n\t\t} else if ($(e.target).hasClass('fa-crosshairs')) {\r\n\t\t\tscale_to_fit(opts);\r\n\t\t} else if ($(e.target).hasClass('fa-file-image')) {\r\n\t\t\treturn;\r\n\t\t} \r\n\r\n\t\t// trigger fhChange event\r\n\t\t$(document).trigger('fhChange', [opts]);\r\n\t});\r\n}\r\n\r\n// reset pedigree and clear the history\r\nexport function reset(opts) {\r\n\tlet proband;\r\n\tif(opts.keep_proband_on_reset) {\r\n\t\tlet local_dataset = pedcache.current(opts);\r\n\t\tlet newdataset =  copy_dataset(local_dataset);\r\n\t\tproband = newdataset[getProbandIndex(newdataset)];\r\n\t\t//let children = pedigree_util.getChildren(newdataset, proband);\r\n\t\tproband.name = \"ch1\";\r\n\t\tproband.mother = \"f21\";\r\n\t\tproband.father = \"m21\";\r\n\t\t// clear pedigree data but keep proband data and risk factors\r\n\t\tpedcache.clear_pedigree_data(opts)\r\n\t} else {\r\n\t\tproband = {\r\n\t\t\t\"name\":\"ch1\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"proband\":true,\"status\":\"0\",\"display_name\":\"Probando\"\r\n\t\t};\r\n\t\tpedcache.clear(opts); // clear all storage data\r\n\t}\r\n\r\n\tdelete opts.dataset;\r\n\r\n\tlet selected = $(\"input[name='default_fam']:checked\");\r\n\tif(selected.length > 0 && selected.val() === 'extended2') {    // secondary relatives\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\":\"wZA\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\"},\r\n\t\t\t{\"name\":\"MAk\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\"},\r\n\t\t\t{\"name\":\"zwB\",\"sex\":\"M\",\"top_level\":true,\"status\":\"0\"},\r\n\t\t\t{\"name\":\"dOH\",\"sex\":\"F\",\"top_level\":true,\"status\":\"0\"},\r\n\t\t\t{\"name\":\"MKg\",\"sex\":\"F\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"xsm\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":\"MAk\",\"father\":\"wZA\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\"},\r\n\t\t\tproband,\r\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"Knx\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"uuc\",\"sex\":\"F\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"xIw\",\"sex\":\"M\",\"mother\":\"dOH\",\"father\":\"zwB\",\"status\":\"0\"}];\r\n\t} else if(selected.length > 0 && selected.val() === 'extended1') {    // primary relatives\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\":\"m21\",\"sex\":\"M\",\"mother\":null,\"father\":null,\"status\":\"0\",\"noparents\":true},\r\n\t\t\t{\"name\":\"f21\",\"sex\":\"F\",\"mother\":null,\"father\":null,\"status\":\"0\",\"noparents\":true},\r\n\t\t\t{\"name\":\"aOH\",\"sex\":\"F\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"Vha\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"Spj\",\"sex\":\"M\",\"mother\":\"f21\",\"father\":\"m21\",\"noparents\":true,\"status\":\"0\"},\r\n\t\t\tproband,\r\n\t\t\t{\"name\":\"zhk\",\"sex\":\"F\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"},\r\n\t\t\t{\"name\":\"Knx\",\"sex\":\"M\",\"mother\":\"ch1\",\"father\":\"Spj\",\"status\":\"0\"}];\r\n\t} else {\r\n\t\topts.dataset = [\r\n\t\t\t{\"name\": \"m21\", \"sex\": \"M\", \"top_level\": true},\r\n\t\t\t{\"name\": \"f21\", \"sex\": \"F\", \"top_level\": true},\r\n\t\t\tproband];\r\n\t}\r\n\t$(document).trigger('rebuild', [opts]);\r\n\tscale_to_fit(opts);\r\n}\r\n\r\nexport function updateButtons(opts) {\r\n\tlet current = pedcache.get_count(opts);\r\n\tlet nstore = pedcache.nstore(opts);\r\n\tlet id = \"#\"+opts.btn_target;\r\n\tif(nstore <= current)\r\n\t\t$(id+\" .fa-redo\").addClass('fg-grey');\r\n\telse\r\n\t\t$(id+\" .fa-redo\").removeClass('fg-grey');\r\n\r\n\tif(current > 1)\r\n\t\t$(id+\" .fa-undo\").removeClass('fg-grey');\r\n\telse\r\n\t\t$(id+\" .fa-undo\").addClass('fg-grey');\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport * as pedigree_util from './utils.js';\r\n\r\n// cancers, genetic & pathology tests\r\nexport let cancers = {\r\n\t\t'breast_cancer': 'breast_cancer_diagnosis_age',\r\n\t\t'breast_cancer2': 'breast_cancer2_diagnosis_age',\r\n\t\t'ovarian_cancer': 'ovarian_cancer_diagnosis_age',\r\n\t\t'prostate_cancer': 'prostate_cancer_diagnosis_age',\r\n\t\t'pancreatic_cancer': 'pancreatic_cancer_diagnosis_age'\r\n\t};\r\nexport let genetic_test1 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'rad51d', 'rad51c', 'brip1'];\r\nexport let genetic_test2 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1'];\r\nexport let genetic_test4 = ['brca1', 'brca2', 'palb2', 'atm', 'chek2', 'bard1', 'rad51d', 'rad51c', 'brip1', 'hoxb13'];\r\n\r\nexport let pathology_tests = ['er', 'pr', 'her2', 'ck14', 'ck56'];\r\n\r\n// risk factor to storage\r\nlet RISK_FACTOR_STORE = {};\r\n\r\n// get surgical ops and PRS for canrisk header\r\nexport function get_meta() {\r\n\tlet meta = get_surgical_ops();\r\n\tlet prs;\r\n\ttry {\r\n\t\tprs = get_prs_values();\r\n\t\tif(prs.breast_cancer_prs && prs.breast_cancer_prs.alpha !== 0 && prs.breast_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_BC=alpha=\"+prs.breast_cancer_prs.alpha+\",zscore=\"+prs.breast_cancer_prs.zscore;\r\n\t\t}\r\n\r\n\t\tif(prs.ovarian_cancer_prs && prs.ovarian_cancer_prs.alpha !== 0 && prs.ovarian_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_OC=alpha=\"+prs.ovarian_cancer_prs.alpha+\",zscore=\"+prs.ovarian_cancer_prs.zscore;\r\n\t\t}\r\n\r\n\t\tif(prs.prostate_cancer_prs && prs.prostate_cancer_prs.alpha !== 0 && prs.prostate_cancer_prs.zscore !== 0) {\r\n\t\t\tmeta += \"\\n##PRS_PC=alpha=\"+prs.prostate_cancer_prs.alpha+\",zscore=\"+prs.prostate_cancer_prs.zscore;\r\n\t\t}\r\n\t} catch(err) { console.warn(\"PRS\", prs); }\r\n\treturn meta;\r\n}\r\n\r\n// return a non-anonimised pedigree format\r\nexport function get_non_anon_pedigree(dataset, meta, version=2, ethnicity=undefined) {\r\n\treturn get_pedigree(dataset, undefined, meta, false, version, ethnicity);\r\n}\r\n\r\n//check if input has a value\r\nexport function hasInput(id) {\r\n\tconst v = $('#'+id).val();\r\n\treturn v && v.trim().length !== 0;\r\n}\r\n\r\n//return true if the object is empty\r\nlet isEmpty = function(myObj) {\r\n\tfor(let key in myObj) {\r\n\t\tif (Object.prototype.hasOwnProperty.call(myObj, key)) {\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\treturn true;\r\n}\r\n\r\n//get breast and ovarian PRS values\r\nexport function get_prs_values() {\r\n\tlet prs = {};\r\n\tif(hasInput(\"breast_prs_a\") && hasInput(\"breast_prs_z\")) {\r\n\t\tprs['breast_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#breast_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#breast_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#breast_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tif(hasInput(\"ovarian_prs_a\") && hasInput(\"ovarian_prs_z\")) {\r\n\t\tprs['ovarian_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#ovarian_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#ovarian_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#ovarian_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tif(hasInput(\"prostate_prs_a\") && hasInput(\"prostate_prs_z\")) {\r\n\t\tprs['prostate_cancer_prs'] = {\r\n\t\t\t'alpha': parseFloat($('#prostate_prs_a').val()),\r\n\t\t\t'zscore': parseFloat($('#prostate_prs_z').val()),\r\n\t\t\t'percent': parseFloat($('#prostate_prs_percent').val())\r\n\t\t};\r\n\t}\r\n\tconsole.log(prs);\r\n\treturn (isEmpty(prs) ? 0 : prs);\r\n}\r\n\r\nfunction get_surgical_ops() {\r\n\tlet meta = \"\";\r\n\tif(!$('#A6_4_3_check').parent().hasClass(\"off\")) {\r\n\t\tmeta += \";OVARY2=y\";\r\n\t}\r\n\tif(!$('#A6_4_7_check').parent().hasClass(\"off\")) {\r\n\t\tmeta += \";MAST2=y\";\r\n\t}\r\n\treturn meta;\r\n}\r\n\r\n/**\r\n * Get genetic test genes based on CanRisk version\r\n */\r\nfunction getGeneticTest(version) {\r\n\tversion = parseInt(version);\r\n\tif(version === 1)\r\n\t\treturn genetic_test1;\r\n\telse if(version === 2)\r\n\t\treturn genetic_test2;\r\n\telse if(version === 3)\r\n\t\treturn genetic_test2;\r\n\treturn genetic_test4;\r\n}\r\n\r\nexport function readCanRisk(boadicea_lines) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\tlet hdr = [];  // collect risk factor header lines\r\n\tconst regexp = /([0-9])/;\r\n\tlet version = 3;\r\n\tlet gt = getGeneticTest(version);\r\n\tlet ncol = [26, 27, 27, 28];\t// number of columns - v1, v2, v3, v4\r\n\t// assumes two line header\r\n\tfor(let i = 0;i < lines.length;i++){\r\n\t\tlet ln = lines[i].trim();\r\n\t\tif(ln.indexOf(\"##\") === 0) {\r\n\t\t\tif(ln.indexOf(\"##CanRisk\") === 0) {\r\n\t\t\t\tconst match = ln.match(regexp);\r\n\t\t\t\tversion = parseInt(match[1]);\r\n\t\t\t\tgt = getGeneticTest(version);\r\n\t\t\t\tconsole.log(\"CanRisk File Format version \"+version);\r\n\r\n\t\t\t\tif(ln.indexOf(\";\") > -1) {   // contains surgical op data\r\n\t\t\t\t\tlet ops = ln.split(\";\");\r\n\t\t\t\t\tfor(let j=1; j<ops.length; j++) {\r\n\t\t\t\t\t\tlet opdata = ops[j].split(\"=\");\r\n\t\t\t\t\t\tif(opdata.length === 2) {\r\n\t\t\t\t\t\t\thdr.push(ops[j]);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif(ln.indexOf(\"CanRisk\") === -1 && ln.indexOf(\"##FamID\") !== 0) {\r\n\t\t\t\thdr.push(ln.replace(\"##\", \"\"));\r\n\t\t\t}\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tlet delim = /\\t/;\r\n\t\tif(ln.indexOf('\\t') < 0) {\r\n\t\t\tdelim = /\\s+/;\r\n\t\t\tconsole.log(\"NOT TAB DELIM\");\r\n\t\t}\r\n\t\tlet attr = $.map(ln.split(delim), function(val, _i){return val.trim();});\r\n\r\n\t\tif(attr.length > 1) {\r\n\t\t\tif(attr.length !== ncol[version-1]) {\r\n\t\t\t\tconsole.error(ln, attr);\r\n\t\t\t\tthrow new Error('Found number of columns '+attr.length+'; expected '+ncol[version-1]+' for CanRisk version '+version);\r\n\t\t\t}\r\n\t\t\tlet indi = {\r\n\t\t\t\t'famid': attr[0],\r\n\t\t\t\t'display_name': attr[1],\r\n\t\t\t\t'name':\tattr[3],\r\n\t\t\t\t'sex': attr[6],\r\n\t\t\t\t'status': attr[8]\r\n\t\t\t};\r\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\r\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\r\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\r\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\r\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\r\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\r\n\r\n\t\t\tlet idx = 11;\r\n\t\t\t$.each(cancers, function(cancer, diagnosis_age) {\r\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\t\tif(attr[idx] !== \"0\") {\r\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t});\r\n\r\n\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2, .... genetic tests\r\n\t\t\t// genetic test type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t// genetic test result, 0 = untested, P = positive, N = negative\r\n\t\t\tfor(let j=0; j<gt.length; j++) {\r\n\t\t\t\tlet gene_test = attr[idx].split(\":\");\r\n\t\t\t\tif(gene_test[0] !== '0') {\r\n\t\t\t\t\tif((gene_test[0] === 'S' || gene_test[0] === 'T') && (gene_test[1] === 'P' || gene_test[1] === 'N'))\r\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + gene_test[0] + \" \" + gene_test[1]);\r\n\t\t\t\t} else {\r\n\t\t\t\t\tif(gene_test[1] === 'P' || gene_test[1] === 'N')\r\n\t\t\t\t\t\tindi[gt[j] + '_gene_test'] = {'type': gene_test[0], 'result': gene_test[1]};\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t}\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tlet path_test = attr[idx].split(\":\");\r\n\t\t\tfor(let j=0; j<path_test.length; j++) {\r\n\t\t\t\tif(path_test[j] !== '0') {\r\n\t\t\t\t\tif(path_test[j] === 'N' || path_test[j] === 'P')\r\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = path_test[j];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +path_test[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tped.push(indi);\r\n\t\t}\r\n\t}\r\n\r\n\t// group mztwins\r\n\tped.sort(function(a, b) {\r\n\t\treturn a.mztwin !== undefined ? a.mztwin.localeCompare(b.mztwin) : 0;\r\n\t});\r\n\r\n\treturn [hdr, ped];\r\n}\r\n\r\n/**\r\n * Get the mammographic density formatted CanRisk data file line\r\n */\r\nexport function get_mdensity(mdensity) {\r\n\tconst regexp = /^(birads|Volpara|Stratus)=/i;\r\n\tif(regexp.test(mdensity))\r\n\t\treturn \"\\n##\"+mdensity;\r\n\t\t\r\n\tconst birads = /^(1|2|3|4|a|b|c|d)$/i\r\n\tif(birads.test(mdensity))\r\n\t\treturn \"\\n##birads=\"+mdensity;\r\n\r\n\tconsole.error(\"Unrecognised mammographic density format :: \" + mdensity);\r\n\treturn \"\"\r\n}\r\n\r\n/**\r\n * Get CanRisk formated pedigree.\r\n */\r\nexport function get_pedigree(dataset, famid, meta, isanon, version=3, ethnicity=undefined) {\r\n\tlet v = (Number.isInteger(version) ? version+\".0\" : version.toString());\r\n\tlet msg = \"##CanRisk \" + v;\r\n\tif(!famid) {\r\n\t\tfamid = \"XXXX\";\r\n\t}\r\n\tif(meta) {\r\n\t\tmsg += meta;\r\n\t}\r\n\tif(typeof isanon === 'undefined') {\r\n\t\tisanon = true;\r\n\t}\r\n\t// array of individuals excluded from the calculation\r\n\tlet excl = $.map(dataset, function(p, _i){return 'exclude' in p && p.exclude ? p.name : null;});\r\n\r\n\t// female risk factors\r\n\tlet probandIdx  = pedigree_util.getProbandIndex(dataset);\r\n\tlet sex = 'F';\r\n\tif(probandIdx) {\r\n\t\tsex = dataset[probandIdx].sex;\r\n\t}\r\n\r\n\tif(sex !== 'M') {\r\n\t\tlet menarche    = get_risk_factor('menarche_age');\r\n\t\tlet parity      = get_risk_factor('parity');\r\n\t\tlet first_birth = get_risk_factor('age_of_first_live_birth');\r\n\t\tlet oc_use      = get_risk_factor('oral_contraception');\r\n\t\tlet mht_use     = get_risk_factor('mht');\r\n\t\tlet bmi         = get_risk_factor('bmi');\r\n\t\tlet alcohol     = get_risk_factor('alcohol_intake');\r\n\t\tlet menopause   = get_risk_factor('age_of_menopause');\r\n\t\tlet mdensity    = get_risk_factor('mammographic_density');\r\n\t\tlet hgt         = get_risk_factor('height');\r\n\t\tlet tl          = get_risk_factor('Age_Tubal_ligation');\r\n\t\tlet endo        = get_risk_factor('endometriosis');\r\n\r\n\t\tif(menarche !== undefined)\r\n\t\t\tmsg += \"\\n##menarche=\"+menarche;\r\n\t\tif(parity !== undefined)\r\n\t\t\tmsg += \"\\n##parity=\"+parity;\r\n\t\tif(first_birth !== undefined)\r\n\t\t\tmsg += \"\\n##first_live_birth=\"+first_birth;\r\n\t\tif(oc_use !== undefined)\r\n\t\t\tmsg += \"\\n##oc_use=\"+oc_use;\r\n\t\tif(mht_use !== undefined)\r\n\t\t\tmsg += \"\\n##mht_use=\"+mht_use;\r\n\t\tif(bmi !== undefined)\r\n\t\t\tmsg += \"\\n##BMI=\"+bmi;\r\n\t\tif(alcohol !== undefined)\r\n\t\t\tmsg += \"\\n##alcohol=\"+alcohol;\r\n\t\tif(menopause !== undefined)\r\n\t\t\tmsg += \"\\n##menopause=\"+menopause;\r\n\t\tif(mdensity !== undefined)\r\n\t\t\tmsg += get_mdensity(mdensity);\r\n\t\tif(hgt !== undefined)\r\n\t\t\tmsg += \"\\n##height=\"+hgt;\r\n\t\tif(tl !== undefined)\r\n\t\t\tif(tl !== \"n\" && tl !== \"N\")\r\n\t\t\t\tmsg += \"\\n##TL=Y\";\r\n\t\t\telse\r\n\t\t\t\tmsg += \"\\n##TL=N\";\r\n\r\n\t\tif(endo !== undefined)\r\n\t\t\tmsg += \"\\n##endo=\"+endo;\r\n\t}\r\n\t\r\n\tif(version > 2 && ethnicity !== undefined) {\r\n\t\tmsg += \"\\n##ethnicity=\"+ethnicity;\r\n\t}\r\n\tmsg += \"\\n##FamID\\tName\\tTarget\\tIndivID\\tFathID\\tMothID\\tSex\\tMZtwin\\tDead\\tAge\\tYob\\tBC1\\tBC2\\tOC\\tPRO\\tPAN\\tAshkn\"\r\n\r\n\tlet gt = getGeneticTest(version);\r\n\tfor(let i=0; i<gt.length; i++) {\r\n\t\tmsg += \"\\t\"+gt[i].toUpperCase();\r\n\t}\r\n\tmsg += \"\\tER:PR:HER2:CK14:CK56\";\r\n\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet p = dataset[i];\r\n\t\tif($.inArray(p.name, excl) !== -1) {\r\n\t\t\tconsole.log('EXCLUDE: '+p.name);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\r\n\t\tmsg += '\\n'+famid+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t// max 13 chars\r\n\t\tif(isanon)\r\n\t\t\tmsg += i+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// display_name (ANONIMISE) max 8 chars\r\n\t\telse\r\n\t\t\tmsg += (p.display_name ? p.display_name : \"NA\")+'\\t';\r\n\t\tmsg += ('proband' in p ? '1' : 0)+'\\t';\r\n\t\tmsg += p.name+'\\t';\t\t\t\t\t\t\t\t\t\t\t\t\t// max 7 chars\r\n\t\tmsg += ('father' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.father : 0)+'\\t';\t// max 7 chars\r\n\t\tmsg += ('mother' in p && !('noparents' in p) && ($.inArray(p.mother, excl) === -1)? p.mother : 0)+'\\t';\t// max 7 chars\r\n\t\tmsg += p.sex+'\\t';\r\n\t\tmsg += ('mztwin' in p ? p.mztwin : 0)+'\\t'; \t\t\t\t\t\t// MZtwin\r\n\t\tmsg += ('status' in p ? p.status : 0)+'\\t';\t\t\t\t\t\t\t// current status: 0 = alive, 1 = dead\r\n\t\tmsg += ('age' in p ? p.age : 0)+'\\t';\t\t\t\t\t\t\t\t// Age at last follow up or 0 = unspecified\r\n\t\tmsg += ('yob' in p ? p.yob : 0)+'\\t';\t\t\t\t\t\t\t\t// YOB or 0 = unspecified\r\n\r\n\t\tlet cmsg = \"\";\r\n\t\t$.each(cancers, function(cancer, diagnosis_age) {\r\n\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\tif(diagnosis_age in p)\r\n\t\t\t\tcmsg += (diagnosis_age in p ? p[diagnosis_age] : 'AU')+'\\t';\r\n\t\t\telse\r\n\t\t\t\tcmsg += '0\\t';\r\n\t\t});\r\n\t\tmsg+=cmsg;\r\n\r\n\t\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\t\tmsg += ('ashkenazi' in p ? p.ashkenazi : 0)+'\\t';\r\n\r\n\t\tfor(let j=0; j<gt.length; j++) {\r\n\t\t\tif(gt[j]+'_gene_test' in p &&\r\n\t\t\t   p[gt[j]+'_gene_test']['type'] !== '-' &&\r\n\t\t\t   p[gt[j]+'_gene_test']['result'] !== '-') {\r\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['type'] + ':';\r\n\t\t\t\tmsg += p[gt[j]+'_gene_test']['result'] + '\\t';\r\n\t\t\t} else {\r\n\t\t\t\tmsg += '0:0\\t';\t\t// type, 0=untested, S=mutation search, T=direct gene test\r\n\t\t\t\t\t\t\t\t\t// result, 0=untested, P=positive, N=negative\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tfor(let j=0; j<pathology_tests.length; j++) {\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tif(pathology_tests[j]+'_bc_pathology' in p) {\r\n\t\t\t\tmsg += p[pathology_tests[j]+'_bc_pathology'];\r\n\t\t\t\tconsole.log('pathology '+p[pathology_tests[j]+'_bc_pathology']+' for '+p.display_name);\r\n\t\t\t} else {\r\n\t\t\t\tmsg += '0';\r\n\t\t\t}\r\n\t\t\tif(j<(pathology_tests.length-1))\r\n\t\t\t\tmsg += \":\";\r\n\t\t}\r\n\t}\r\n\tconsole.log(msg, RISK_FACTOR_STORE);\r\n\treturn msg;\r\n}\r\n\r\nexport function show_risk_factor_store() {\r\n\tconsole.log(\"RISK_FACTOR_STORE::\");\r\n\t$.each(RISK_FACTOR_STORE, function(name, val){\r\n\t\tconsole.log(name + \" : \" + val);\r\n\t});\r\n}\r\n\r\nexport function save_risk_factor(risk_factor_name, val) {\r\n\tRISK_FACTOR_STORE[store_name(risk_factor_name)] = val;\r\n}\r\n\r\nexport function get_risk_factor(risk_factor_name) {\r\n\tlet key = store_name(risk_factor_name);\r\n\tif(key in RISK_FACTOR_STORE) {\r\n\t\treturn RISK_FACTOR_STORE[key];\r\n\t}\r\n\treturn undefined;\r\n}\r\n\r\n// remove risk factor from storage\r\nexport function remove_risk_factor(risk_factor_name) {\r\n\tdelete RISK_FACTOR_STORE[store_name(risk_factor_name)];\r\n}\r\n\r\n// prefix risk factor name with the app/page name\r\nexport function store_name(risk_factor_name) {\r\n\treturn window.location.pathname.split('/').filter(function(el){ return !!el; }).pop() +\r\n\t       '::' + risk_factor_name;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree I/O\r\nimport * as utils from './utils.js';\r\nimport * as pedcache from './pedcache.js';\r\nimport {readCanRisk, cancers, genetic_test1, pathology_tests} from './canrisk_file.js';\r\nimport {get_bounds} from './zoom.js';\r\n\r\n\r\nexport function addIO(opts) {\r\n\t$('#load').change(function(e) {\r\n\t\tload(e, opts);\r\n\t});\r\n\r\n\t$('#save').click(function(_e) {\r\n\t\tsave(opts);\r\n\t});\r\n\r\n\t$('#print').click(function(_e) {\r\n\t\tprint(get_printable_svg(opts));\r\n\t});\r\n\r\n\t$('#svg_download').click(function(_e) {\r\n\t\tsvg_download(get_printable_svg(opts));\r\n\t});\r\n\r\n\t$('#png_download, .fa-file-image').click(function(_e) {\r\n\t\tlet resolution = 4;\r\n\t\timg_download(opts, resolution, \"image/png\");\r\n\t});\r\n}\r\n\r\n/**\r\n * Get object from array by the name attribute.\r\n */\r\nfunction getByName(arr, name) {\r\n\treturn $.grep(arr, function(o){ return o && o.name === name; })[0];\r\n}\r\n\r\n/**\r\n * Provide font style to svg\r\n */\r\nfunction copyStylesInline(destinationNode, sourceNode) {\r\n\tlet containerElements = [\"svg\",\"g\"];\r\n\tlet destChildNodes = destinationNode.childNodes;\r\n\tlet srcChildNodes = sourceNode.childNodes;\r\n\tfor (let cd = 0; cd < destChildNodes.length; cd++) {\r\n\t\tlet child = destChildNodes[cd];\r\n\t\tif (containerElements.indexOf(child.tagName) !== -1) {\r\n\t\t\tcopyStylesInline(child, srcChildNodes[cd]);\r\n\t\t\tcontinue;\r\n\t\t}\r\n\t\ttry {\r\n\t\t\tlet style = srcChildNodes[cd].currentStyle || window.getComputedStyle(srcChildNodes[cd]);\r\n\t\t\tif (style === \"undefined\" || style === null) continue;\r\n\r\n\t\t\tlet styleLength = style.length;\r\n\t\t\tlet childStyle = child.style;\r\n\t\t\tfor (let st = 0; st < styleLength; st++){\r\n\t\t\t\tlet mySt = style[st];\r\n\t\t\t\tif(mySt.indexOf(\"text-\") > -1 || mySt.indexOf(\"font-\") > -1) childStyle.setProperty(mySt, style.getPropertyValue(mySt));\r\n\t\t\t}\r\n\t\t} catch(err) { continue; }\r\n   }\r\n}\r\n\r\n/**\r\n * Export pedigree as image, e.g. PNG\r\n */\r\nexport function img_download(opts, resolution, img_type) {\r\n\tlet deferred = svg2img($('#'+opts.targetDiv).find('svg'), \"pedigree\", {resolution: resolution, img_type: img_type});\r\n\t$.when.apply($,[deferred]).done(function() {\r\n\t\tlet obj = getByName(arguments, \"pedigree\");\r\n\t\tif(utils.isEdge() || utils.isIE()) {\r\n\t\t\tlet html=\"<img src='\"+obj.img+\"' alt='canvas image'/>\";\r\n\t\t\tlet newTab = window.open();\t\t// pop-ups need to be enabled\r\n\t\t\tnewTab.document.write(html);\r\n\t\t} else {\r\n\t\t\tlet a\t  = document.createElement('a');\r\n\t\t\ta.href\t = obj.img;\r\n\t\t\ta.download = 'plot.png';\r\n\t\t\ta.target   = '_blank';\r\n\t\t\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/** Get SVG data URL from svg element */\r\nfunction get_svg_as_data_url(svg) {\r\n\tlet svgCopy = svg.get(0).cloneNode(true);\r\n\t// remove unused elements\r\n\td3.select(svgCopy).selectAll(\"text\").filter(function(){\r\n\t\t return d3.select(this).text().length === 0 || \r\n\t\t        d3.select(this), d3.select(this).attr('font-family') === \"FontAwesome\"\r\n\t }).remove();\r\n\tcopyStylesInline(svgCopy, svg.get(0));\r\n\tlet svgStr = (new XMLSerializer()).serializeToString(svgCopy);\r\n\treturn 'data:image/svg+xml;base64,'+ window.btoa(unescape(encodeURIComponent(svgStr))); // convert SVG string to data URL\r\n}\r\n/**\r\n * Given a SVG document element convert to image (e.g. jpeg, png - default png).\r\n */\r\nexport function svg2img(svg, deferred_name, options) {\r\n\tlet defaults = {iscanvg: false, resolution: 1, img_type: \"image/png\"};\r\n\tif(!options) options = defaults;\r\n\t$.each(defaults, function(key, value) {\r\n\t\tif(!(key in options)) {options[key] = value;}\r\n\t});\r\n\r\n\tlet deferred = $.Deferred();\r\n\tlet imgsrc = get_svg_as_data_url(svg); // convert SVG string to data URL\r\n\tlet canvas = document.createElement(\"canvas\");\r\n\tcanvas.width = svg.width()*options.resolution;\r\n\tcanvas.height = svg.height()*options.resolution;\r\n\tlet context = canvas.getContext(\"2d\");\r\n\t// provide a white background\r\n\tcontext.fillStyle = \"white\";\r\n\tcontext.fillRect(0, 0, canvas.width, canvas.height);\r\n\t\r\n\tlet img = document.createElement(\"img\");\r\n\timg.onload = function() {\r\n\t\tcontext.drawImage(img, 0, 0, canvas.width, canvas.height);\r\n\t\tconsole.log(deferred_name, options.img_type);\r\n\t\tdeferred.resolve(\r\n\t\t\t{'name': deferred_name,\r\n\t\t\t'resolution': options.resolution,\r\n\t\t\t'img':canvas.toDataURL(options.img_type, 1),\r\n\t\t\t'w':canvas.width,\r\n\t\t\t'h':canvas.height});\r\n\t\tcontext.clearRect(0, 0, canvas.width, canvas.height);\r\n\t};\r\n\timg.src = imgsrc;\r\n\treturn deferred.promise();\r\n}\r\n\r\nfunction getMatches(str, myRegexp) {\r\n\tlet matches = [];\r\n\tlet c = 0;\r\n\tmyRegexp.lastIndex = 0;\r\n\tlet match = myRegexp.exec(str);\r\n\twhile (match) {\r\n\t\tc++;\r\n\t\tif(c > 400) {\r\n\t\t\tconsole.error(\"getMatches: counter exceeded 400\");\r\n\t\t\treturn -1;\r\n\t\t}\r\n\t\tmatches.push(match);\r\n\t\tif (myRegexp.lastIndex === match.index) {\r\n\t\t\tmyRegexp.lastIndex++;\r\n\t\t}\r\n\t\tmatch = myRegexp.exec(str);\r\n\t}\r\n\treturn matches;\r\n}\r\n\r\n// find all url's to make unique\r\nfunction unique_urls(svg_html) {\r\n\tlet matches = getMatches(svg_html, /url\\((&quot;|\"|'){0,1}#(.*?)(&quot;|\"|'){0,1}\\)/g);\r\n\tif(matches === -1)\r\n\t\treturn \"ERROR DISPLAYING PEDIGREE\"\r\n\r\n\t$.each(matches, function(_index, match) {\r\n\t\tlet quote = (match[1] ? match[1] : \"\");\r\n\t\tlet val = match[2];\r\n\t\tlet m1 = \"id=\\\"\" + val + \"\\\"\";\r\n\t\tlet m2 = \"url\\\\(\" + quote + \"#\" + val + quote + \"\\\\)\";\r\n\r\n\t\tlet newval = val+utils.makeid(2);\r\n\t\tsvg_html = svg_html.replace(new RegExp(m1, 'g'), \"id=\\\"\"+newval+\"\\\"\" );\r\n\t\tsvg_html = svg_html.replace(new RegExp(m2, 'g'), \"url(#\"+newval+\")\" );\r\n   });\r\n\treturn svg_html;\r\n}\r\n\r\n// return a copy pedigree svg\r\nexport function copy_svg(opts) {\r\n\tlet svg_node = get_printable_svg(opts);\r\n\tlet d3obj = d3.select(svg_node.get(0));\r\n\r\n\t// remove unused elements\r\n\td3obj.selectAll(\"text\")\r\n\t  .filter(function(){\r\n\t\treturn d3.select(this).text().length === 0 || d3.select(this), d3.select(this).attr('font-family') === \"FontAwesome\"\r\n\t  }).remove();\r\n\treturn $(unique_urls(svg_node.html()));\r\n}\r\n\r\n// get printable svg div, adjust size to tree dimensions and scale to fit\r\nfunction get_printable_svg(opts) {\r\n\tlet local_dataset = pedcache.current(opts); // get current dataset\r\n\tif (local_dataset !== undefined && local_dataset !== null) {\r\n\t\topts.dataset = local_dataset;\r\n\t}\r\n\r\n\tlet svg_div = $('<div></div>');  \t\t\t\t// create a new div\r\n\tlet svg = $('#'+opts.targetDiv).find('svg').clone().appendTo(svg_div);\r\n\r\n\tlet a4 = {w: (595-40), h: (842-50)};\r\n\t\r\n\tlet b = get_bounds(opts);\r\n\tlet d = {w: Math.abs(b.xmax-b.xmin), h: Math.abs(b.ymax-b.ymin)};\r\n\tlet f = 1;\r\n\tlet k = (f / Math.max(d.w/a4.w, d.h/a4.h));\r\n\r\n\tlet xi = -(b.xmin-(opts.symbol_size))*k;\r\n\tlet yi = -(b.ymin-(opts.symbol_size))*k;\r\n\r\n\tsvg.attr('width', a4.w);\r\n\tsvg.attr('height', d.h*k);\t\r\n\r\n\tsvg.find(\".diagram\").attr(\"transform\", \"translate(\"+xi+\", \"+yi+\") scale(\"+k+\")\");\r\n\treturn svg_div;\r\n}\r\n\r\n// download the SVG to a file\r\nexport function svg_download(svg){\r\n\tlet a\t   = document.createElement('a');\r\n\ta.href\t   = get_svg_as_data_url(svg);\r\n\ta.download = 'plot.svg';\r\n\ta.target   = '_blank';\r\n\tdocument.body.appendChild(a); a.click(); document.body.removeChild(a);\r\n}\r\n\r\n// open print window for a given element\r\nexport function print(el, id){\r\n\tif(el.constructor !== Array)\r\n\t\tel = [el];\r\n\r\n\tlet width = $(window).width()*0.9;\r\n\tlet height = $(window).height()-10;\r\n\tlet cssFiles = [\r\n\t\t'/static/css/canrisk.css',\r\n\t\t'https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css'\r\n\t];\r\n\tlet printWindow = window.open('', 'PrintMap', 'width=' + width + ',height=' + height);\r\n\tlet headContent = '';\r\n\tfor(let i=0; i<cssFiles.length; i++)\r\n\t\theadContent += '<link href=\"'+cssFiles[i]+'\" rel=\"stylesheet\" type=\"text/css\" media=\"all\">';\r\n\theadContent += \"<style>body {font-size: \" + $(\"body\").css('font-size') + \";}</style>\";\r\n\r\n\tlet html = \"\";\r\n\tfor(let i=0; i<el.length; i++) {\r\n\t\tif(i === 0 && id)\r\n\t\t\thtml += id;\r\n\t\thtml += $(el[i]).html();\r\n\t\tif(i < el.length-1)\r\n\t\t\thtml += '<div class=\"page-break\"> </div>';\r\n\t}\r\n\r\n\tprintWindow.document.write(headContent);\r\n\tprintWindow.document.write(html);\r\n\tprintWindow.document.close();\r\n\r\n\tprintWindow.focus();\r\n\tsetTimeout(function() {\r\n\t\tprintWindow.print();\r\n\t\tprintWindow.close();\r\n\t}, 300);\r\n}\r\n\r\n// save content to a file\r\nexport function save_file(opts, content, filename, type){\r\n\tif(opts.DEBUG)\r\n\t\tconsole.log(content);\r\n\tif(!filename) filename = \"ped.txt\";\r\n\tif(!type) type = \"text/plain\";\r\n\r\n   let file = new Blob([content], {type: type});\r\n   if (window.navigator.msSaveOrOpenBlob) \t// IE10+\r\n\t   window.navigator.msSaveOrOpenBlob(file, filename);\r\n   else { \t\t\t\t\t\t\t\t\t// other browsers\r\n\t   let a = document.createElement(\"a\");\r\n\t   let url = URL.createObjectURL(file);\r\n\t   a.href = url;\r\n\t   a.download = filename;\r\n\t   document.body.appendChild(a);\r\n\t   a.click();\r\n\t   setTimeout(function() {\r\n\t\t   document.body.removeChild(a);\r\n\t\t   window.URL.revokeObjectURL(url);\r\n\t\t}, 0);\r\n\t}\r\n}\r\n\r\nfunction save(opts){\r\n\tlet content = JSON.stringify(pedcache.current(opts));\r\n\tsave_file(opts, content);\r\n}\r\n\r\nfunction canrisk_validation(opts) {\r\n\t$.each(opts.dataset, function(_idx, p) {\r\n\t\tif(!p.hidden && p.sex === 'M' && !utils.isProband(p)) {\r\n\t\t\tif(p[cancers['breast_cancer2']]) {\r\n\t\t\t\tlet msg = 'Male family member ('+p.display_name+') with contralateral breast cancer found. '+\r\n\t\t\t\t\t\t  'Please note that as the risk models do not take this into account the second '+\r\n\t\t\t\t\t\t  'breast cancer is ignored.'\r\n\t\t\t\tconsole.error(msg);\r\n\t\t\t\tdelete p[cancers['breast_cancer2']];\r\n\t\t\t\tutils.messages(\"Warning\", msg);\r\n\t\t\t}\r\n\t\t}\r\n\t});\r\n}\r\n\r\n/** Read and load pedigree data string */\r\nexport function load_data(d, opts) {\r\n\tif(opts.DEBUG) console.log(d);\r\n\tlet risk_factors;\r\n\ttry {\r\n\t\tif(d.indexOf(\"BOADICEA import pedigree file format 4.0\") === 0) {\r\n\t\t\topts.dataset = readBoadiceaV4(d, 4);\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else if(d.indexOf(\"BOADICEA import pedigree file format 2.0\") === 0) {\r\n\t\t\topts.dataset = readBoadiceaV4(d, 2);\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else if(d.indexOf(\"##\") === 0 && d.indexOf(\"CanRisk\") !== -1) {\r\n\t\t\tlet canrisk_data = readCanRiskFile(d);\r\n\t\t\trisk_factors = canrisk_data[0];\r\n\t\t\topts.dataset = canrisk_data[1];\r\n\t\t\tcanrisk_validation(opts);\r\n\t\t} else {\r\n\t\t\ttry {\r\n\t\t\t\tlet ped = JSON.parse(d);\r\n\t\t\t\tlet to_process = true;\r\n\t\t\t\tfor(let i=0;i<ped.length;i++) {\r\n\t\t\t\t\tif(ped[i].top_level) {\r\n\t\t\t\t\t\tto_process = false;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\topts.dataset = (to_process ? process_ped(ped) : ped);\r\n\t\t\t} catch(err) {\r\n\t\t\t\topts.dataset = readLinkage(d);\r\n\t\t\t}\r\n\t\t}\r\n\t\tutils.validate_pedigree(opts);\r\n\t} catch(err1) {\r\n\t\tconsole.error(err1, d);\r\n\t\tutils.messages(\"File Error\", ( err1.message ? err1.message : err1));\r\n\t\treturn;\r\n\t}\r\n\tif(opts.DEBUG) console.log(opts.dataset);\r\n\ttry{\r\n\t\tpedcache.setposition(opts);\t\t// clear position\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\tconsole.log(risk_factors);\r\n\t\t// load risk factors - fire riskfactorChange event\r\n\t\t$(document).trigger('riskfactorChange', [opts, risk_factors]);\r\n\t\t$(document).trigger('fhChange', [opts]); \t// trigger fhChange event\r\n\t\r\n\t\ttry {\r\n\t\t\t// update FH section\r\n\t\t\tacc_FamHist_ticked();\t\t\t\t// eslint-disable-line no-undef\r\n\t\t\tacc_FamHist_Leave();\t\t\t\t// eslint-disable-line no-undef\r\n\t\t\tRESULT.FLAG_FAMILY_MODAL = true;\t// eslint-disable-line no-undef\r\n\t\t} catch(err3) {\r\n\t\t\t// ignore error\r\n\t\t}\r\n\t} catch(err2) {\r\n\t\tutils.messages(\"File Error\", ( err2.message ? err2.message : err2));\r\n\t}\r\n}\r\n\r\nfunction load(e, opts) {\r\n\tlet f = e.target.files[0];\r\n\tif(f) {\r\n\t\tlet reader = new FileReader();\r\n\t\treader.onload = function(e) {\r\n\t\t\tload_data(e.target.result, opts);\r\n\t\t};\r\n\t\treader.onerror = function() {\r\n\t\t\tutils.messages(\"File Error\", \"File could not be read! Code \" + reader.error);\r\n\t\t};\r\n\t\treader.readAsText(f);\r\n\t} else {\r\n\t\tconsole.error(\"File could not be read!\");\r\n\t}\r\n\t$(\"#load\")[0].value = ''; // reset value\r\n}\r\n\r\n//\r\n// https://www.cog-genomics.org/plink/1.9/formats#ped\r\n// https://www.cog-genomics.org/plink/1.9/formats#fam\r\n//\t1. Family ID ('FID')\r\n//\t2. Within-family ID ('IID'; cannot be '0')\r\n//\t3. Within-family ID of father ('0' if father isn't in dataset)\r\n//\t4. Within-family ID of mother ('0' if mother isn't in dataset)\r\n//\t5. Sex code ('1' = male, '2' = female, '0' = unknown)\r\n//\t6. Phenotype value ('1' = control, '2' = case, '-9'/'0'/non-numeric = missing data if case/control)\r\n//\t7. Genotypes (column 7 onwards);\r\n//\t columns 7 & 8 are allele calls for first variant ('0' = no call); colummns 9 & 10 are calls for second variant etc.\r\nexport function readLinkage(boadicea_lines) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\tlet famid;\r\n\tfor(let i = 0;i < lines.length;i++){\r\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\r\n\t   if(attr.length < 5)\r\n\t\t   throw new Error('unknown format');\r\n\t   let sex = (attr[4] === '1' ? 'M' : (attr[4] === '2' ? 'F' : 'U'));\r\n\t   let indi = {\r\n\t\t\t'famid': attr[0],\r\n\t\t\t'display_name': attr[1],\r\n\t\t\t'name':\tattr[1],\r\n\t\t\t'sex': sex\r\n\t\t};\r\n\t\tif(attr[2] !== \"0\") indi.father = attr[2];\r\n\t\tif(attr[3] !== \"0\") indi.mother = attr[3];\r\n\r\n\t\tif (typeof famid != 'undefined' && famid !== indi.famid) {\r\n\t\t\tconsole.error('multiple family IDs found only using famid = '+famid);\r\n\t\t\tbreak;\r\n\t\t}\r\n\t\tif(attr[5] === \"2\") indi.affected = 2;\r\n\t\t// add genotype columns\r\n\t\tif(attr.length > 6) {\r\n\t\t\tindi.alleles = \"\";\r\n\t\t\tfor(let j=6; j<attr.length; j+=2) {\r\n\t\t\t\tindi.alleles += attr[j] + \"/\" + attr[j+1] + \";\";\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tped.unshift(indi);\r\n\t\tfamid = attr[0];\r\n\t}\r\n\treturn process_ped(ped);\r\n}\r\n\r\nexport function readCanRiskFile(boadicea_lines) {\r\n\tlet [hdr, ped] = readCanRisk(boadicea_lines);\r\n\ttry {\r\n\t\treturn [hdr, process_ped(ped)];\r\n\t} catch(e) {\r\n\t\tconsole.error(e);\r\n\t\treturn [hdr, ped];\r\n\t}\r\n}\r\n\r\n// read boadicea format v4 & v2\r\nexport function readBoadiceaV4(boadicea_lines, version) {\r\n\tlet lines = boadicea_lines.trim().split('\\n');\r\n\tlet ped = [];\r\n\t// assumes two line header\r\n\tfor(let i = 2;i < lines.length;i++){\r\n\t   let attr = $.map(lines[i].trim().split(/\\s+/), function(val, _i){return val.trim();});\r\n\t\tif(attr.length > 1) {\r\n\t\t\tlet indi = {\r\n\t\t\t\t'famid': attr[0],\r\n\t\t\t\t'display_name': attr[1],\r\n\t\t\t\t'name':\tattr[3],\r\n\t\t\t\t'sex': attr[6],\r\n\t\t\t\t'status': attr[8]\r\n\t\t\t};\r\n\t\t\tif(attr[2] === \"1\") indi.proband = true;\r\n\t\t\tif(attr[4] !== \"0\") indi.father = attr[4];\r\n\t\t\tif(attr[5] !== \"0\") indi.mother = attr[5];\r\n\t\t\tif(attr[7] !== \"0\") indi.mztwin = attr[7];\r\n\t\t\tif(attr[9] !== \"0\") indi.age = attr[9];\r\n\t\t\tif(attr[10] !== \"0\") indi.yob = attr[10];\r\n\r\n\t\t\tlet idx = 11;\r\n\t\t\t$.each(cancers, function(_cancer, diagnosis_age) {\r\n\t\t\t\t// Age at 1st cancer or 0 = unaffected, AU = unknown age at diagnosis (affected unknown)\r\n\t\t\t\tif(attr[idx] !== \"0\") {\r\n\t\t\t\t\tindi[diagnosis_age] = attr[idx];\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t});\r\n\r\n\t\t\tif(version === 4) {\r\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t\t// BRCA1, BRCA2, PALB2, ATM, CHEK2 genetic tests\r\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t\t// result, 0 = untested, P = positive, N = negative\r\n\t\t\t\tfor(let j=0; j<5; j++) {\r\n\t\t\t\t\tidx+=2;\r\n\t\t\t\t\tif(attr[idx-2] !== '0') {\r\n\t\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T') && (attr[idx-1] === 'P' || attr[idx-1] === 'N'))\r\n\t\t\t\t\t\t\tindi[genetic_test1[j] + '_gene_test'] = {'type': attr[idx-2], 'result': attr[idx-1]};\r\n\t\t\t\t\t\telse\r\n\t\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t} else if (version === 2) {\r\n\t\t\t\t// genetic test BRCA1, BRCA2\r\n\t\t\t\t// type, 0 = untested, S = mutation search, T = direct gene test\r\n\t\t\t\t// result, 0 = untested, N = no mutation, 1 = BRCA1 positive, 2 = BRCA2 positive, 3 = BRCA1/2 positive\r\n\t\t\t\tidx+=2; \t// gtest\r\n\t\t\t\tif(attr[idx-2] !== '0') {\r\n\t\t\t\t\tif((attr[idx-2] === 'S' || attr[idx-2] === 'T')) {\r\n\t\t\t\t\t\tif(attr[idx-1] === 'N') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t} else if(attr[idx-1] === '1') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t} else if(attr[idx-1] === '2') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'N'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t} else if(attr[idx-1] === '3') {\r\n\t\t\t\t\t\t\tindi['brca1_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t\tindi['brca2_gene_test'] = {'type': attr[idx-2], 'result': 'P'};\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED GENE TEST ON LINE '+ (i+1) + \": \" + attr[idx-2] + \" \" + attr[idx-1]);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tif(attr[idx++] !== \"0\") indi.ashkenazi = 1;\r\n\t\t\t}\r\n\r\n\t\t\t// status, 0 = unspecified, N = negative, P = positive\r\n\t\t\tfor(let j=0; j<pathology_tests.length; j++) {\r\n\t\t\t\tif(attr[idx] !== '0') {\r\n\t\t\t\t\tif(attr[idx] === 'N' || attr[idx] === 'P')\r\n\t\t\t\t\t\tindi[pathology_tests[j] + '_bc_pathology'] = attr[idx];\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tconsole.warn('UNRECOGNISED PATHOLOGY ON LINE '+ (i+1) + \": \" +pathology_tests[j] + \" \" +attr[idx]);\r\n\t\t\t\t}\r\n\t\t\t\tidx++;\r\n\t\t\t}\r\n\t\t\tped.unshift(indi);\r\n\t\t}\r\n\t}\r\n\r\n\ttry {\r\n\t\treturn process_ped(ped);\r\n\t} catch(e) {\r\n\t\tconsole.error(e);\r\n\t\treturn ped;\r\n\t}\r\n}\r\n\r\nfunction process_ped(ped) {\r\n\t// find the level of individuals in the pedigree\r\n\tfor(let j=0;j<2;j++) {\r\n\t\tfor(let i=0;i<ped.length;i++) {\r\n\t\t\tgetLevel(ped, ped[i].name);\r\n\t\t}\r\n\t}\r\n\r\n\tfix_n_balance_levels(ped);\r\n\r\n\t// find the max level (i.e. top_level)\r\n\tlet max_level = 0;\r\n\tfor(let i=0;i<ped.length;i++) {\r\n\t\tif(ped[i].level && ped[i].level > max_level)\r\n\t\t\tmax_level = ped[i].level;\r\n\t}\r\n\r\n\t// identify top_level and other nodes without parents\r\n\tfor(let i=0;i<ped.length;i++) {\r\n\t\tif(utils.getDepth(ped, ped[i].name) === 1) {\r\n\t\t\tif(ped[i].level && ped[i].level === max_level) {\r\n\t\t\t\tped[i].top_level = true;\r\n\t\t\t} else {\r\n\t\t\t\tped[i].noparents = true;\r\n\r\n\t\t\t\t// 1. look for partners parents\r\n\t\t\t\tlet pidx = getPartnerIdx(ped, ped[i]);\r\n\t\t\t\tif(pidx > -1) {\r\n\t\t\t\t\tif(ped[pidx].mother) {\r\n\t\t\t\t\t\tped[i].mother = ped[pidx].mother;\r\n\t\t\t\t\t\tped[i].father = ped[pidx].father;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\t// 2. or adopt parents from level above\r\n\t\t\t\tif(!ped[i].mother){\r\n\t\t\t\t\tfor(let j=0; j<ped.length; j++) {\r\n\t\t\t\t\t\tif(ped[i].level === (ped[j].level-1)) {\r\n\t\t\t\t\t\t\tpidx = getPartnerIdx(ped, ped[j]);\r\n\t\t\t\t\t\t\tif(pidx > -1 && i !== pidx) {\r\n\t\t\t\t\t\t\t\tped[i].mother = (ped[j].sex === 'F' ? ped[j].name : ped[pidx].name);\r\n\t\t\t\t\t\t\t\tped[i].father = (ped[j].sex === 'M' ? ped[j].name : ped[pidx].name);\r\n\t\t\t\t\t\t\t\tbreak;\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tdelete ped[i].top_level;\r\n\t\t}\r\n\t}\r\n\treturn ped;\r\n}\r\n\r\n// get the partners for a given node\r\nfunction getPartnerIdx(dataset, anode) {\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet bnode = dataset[i];\r\n\t\tif(anode.name === bnode.mother)\r\n\t\t\treturn utils.getIdxByName(dataset, bnode.father);\r\n\t\telse if(anode.name === bnode.father)\r\n\t\t\treturn utils.getIdxByName(dataset, bnode.mother);\r\n\t}\r\n\treturn -1;\r\n}\r\n\r\n// for a given individual assign levels to a parents ancestors\r\nfunction getLevel(dataset, name) {\r\n\tlet idx = utils.getIdxByName(dataset, name);\r\n\tlet level = (dataset[idx].level ? dataset[idx].level : 0);\r\n\tupdate_parents_level(idx, level, dataset);\r\n}\r\n\r\n// recursively update parents levels\r\nfunction update_parents_level(idx, level, dataset) {\r\n\tlet parents = ['mother', 'father'];\r\n\tlevel++;\r\n\tfor(let i=0; i<parents.length; i++) {\r\n\t\tlet pidx = utils.getIdxByName(dataset, dataset[idx][parents[i]]);\r\n\t\tif(pidx >= 0) {\r\n\t\t\tlet ma = dataset[utils.getIdxByName(dataset, dataset[idx].mother)];\r\n\t\t\tlet pa = dataset[utils.getIdxByName(dataset, dataset[idx].father)];\r\n\t\t\tif(!dataset[pidx].level || dataset[pidx].level < level) {\r\n\t\t\t\tma.level = level;\r\n\t\t\t\tpa.level = level;\r\n\t\t\t}\r\n\r\n\t\t\tif(ma.level < pa.level) {\r\n\t\t\t\tma.level = pa.level;\r\n\t\t\t} else if(pa.level < ma.level) {\r\n\t\t\t\tpa.level = ma.level;\r\n\t\t\t}\r\n\t\t\tupdate_parents_level(pidx, level, dataset);\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// for a pedigree fix the levels of children nodes to be consistent with parent\r\nfunction fix_n_balance_levels(ped) {\r\n\tlet updated = false;\r\n\tlet l = ped.length;\r\n\r\n\tfor(let i=0;i<l;i++) {\r\n\t\tlet children = utils.getChildren(ped, ped[i]);\r\n\t\tlet prt_lvl = ped[i].level;\r\n\t\tfor(let j=0;j<children.length;j++){\r\n\t\t\tif(prt_lvl - children[j].level > 1) {\r\n\t\t\t\tchildren[j].level = prt_lvl-1;\r\n\t\t\t\tlet ptrs = utils.get_partners(ped, children[j]);\r\n\r\n\t\t\t\tfor(let k=0;k<ptrs.length;k++){\r\n\t\t\t\t\tlet p = utils.getNodeByName(ped, ptrs[k])\r\n\t\t\t\t\tp.level = prt_lvl-1;\r\n\r\n\t\t\t\t\tlet m = utils.getNodeByName(ped, p.mother);\r\n\t\t\t\t\tlet f = utils.getNodeByName(ped, p.father);\r\n\t\t\t\t\tif(m) m.level = prt_lvl;\r\n\t\t\t\t\tif(f) f.level = prt_lvl;\r\n\t\t\t\t}\r\n\t\t\t\tupdated = true;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\treturn updated;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n\r\n// set two siblings as twins\r\nexport function setMzTwin(dataset, d1, d2, twin_type) {\r\n\tif(!d1[twin_type]) {\r\n\t\td1[twin_type] = getUniqueTwinID(dataset, twin_type);\r\n\t\tif(!d1[twin_type])\r\n\t\t\treturn false;\r\n\t}\r\n\td2[twin_type] = d1[twin_type];\r\n\tif(d1.yob)\r\n\t\td2.yob = d1.yob;\r\n\tif(d1.age && (d1.status === \"0\" || !d1.status))\r\n\t\td2.age = d1.age;\r\n\treturn true;\r\n}\r\n\r\n// get a new unique twins ID, max of 10 twins in a pedigree\r\nexport function getUniqueTwinID(dataset, twin_type) {\r\n\tlet mz = [1, 2, 3, 4, 5, 6, 7, 8, 9, \"A\"];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tif(dataset[i][twin_type]) {\r\n\t\t\tlet idx = mz.indexOf(dataset[i][twin_type]);\r\n\t\t\tif (idx > -1)\r\n\t\t\t\tmz.splice(idx, 1);\r\n\t\t}\r\n\t}\r\n\tif(mz.length > 0)\r\n\t\treturn mz[0];\r\n\treturn undefined;\r\n}\r\n\r\n// sync attributes of twins\r\nexport function syncTwins(dataset, d1) {\r\n\tif(!d1.mztwin && !d1.dztwin)\r\n\t\treturn;\r\n\tlet twin_type = (d1.mztwin ? \"mztwin\" : \"dztwin\");\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tlet d2 = dataset[i];\r\n\t\tif(d2[twin_type] && d1[twin_type] === d2[twin_type] && d2.name !== d1.name) {\r\n\t\t\tif(twin_type === \"mztwin\")\r\n\t\t\t  d2.sex = d1.sex;\r\n\t\t\tif(d1.yob)\r\n\t\t\t\td2.yob = d1.yob;\r\n\t\t\tif(d1.age && (d1.status === 0 || !d1.status))\r\n\t\t\t\td2.age = d1.age;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// check integrity twin settings\r\nexport function checkTwins(dataset) {\r\n\tlet twin_types = [\"mztwin\", \"dztwin\"];\r\n\tfor(let i=0; i<dataset.length; i++) {\r\n\t\tfor(let j=0; j<twin_types.length; j++) {\r\n\t\t\tlet twin_type = twin_types[j];\r\n\t\t\tif(dataset[i][twin_type]) {\r\n\t\t\t\tlet count = 0;\r\n\t\t\t\tfor(let j=0; j<dataset.length; j++) {\r\n\t\t\t\t\tif(dataset[j][twin_type] === dataset[i][twin_type])\r\n\t\t\t\t\t\tcount++;\r\n\t\t\t\t}\r\n\t\t\t\tif(count < 2)\r\n\t\t\t\t\tdelete dataset[i][[twin_type]];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree form\r\nimport {syncTwins} from './twins.js';\r\nimport {copy_dataset, getNodeByName} from './utils.js';\r\nimport {current as pedcache_current} from './pedcache.js';\r\n\r\n\r\n// handle family history change events (undo/redo/delete)\r\n$(document).on('fhChange', function(e, opts){\r\n\ttry {\r\n\t\tlet id = $('#id_name').val();  // get name from hidden field\r\n\t\tlet node = getNodeByName(pedcache_current(opts), id)\r\n\t\tif(node === undefined)\r\n\t\t\t$('form > fieldset').prop(\"disabled\", true);\r\n\t\telse\r\n\t\t\t$('form > fieldset').prop('disabled', false);\r\n\t} catch(err) {\r\n\t\tconsole.warn(err);\r\n\t}\r\n})\r\n\r\n// update status field and age label - 0 = alive, 1 = dead\r\nexport function updateStatus(status) {\r\n\t$('#age_yob_lock').removeClass('fa-lock fa-unlock-alt');\r\n\t(status === \"1\" ? $('#age_yob_lock').addClass('fa-unlock-alt') : $('#age_yob_lock').addClass('fa-lock'));\r\n\t$('#id_age_'+status).removeClass(\"hidden\");\r\n\t$('#id_age_'+(status === \"1\" ? '0' : '1')).addClass(\"hidden\");\r\n}\r\n\r\nexport function nodeclick(node) {\r\n\t$('form > fieldset').prop('disabled', false);\r\n\t// clear values\r\n\t$('#person_details').find(\"input[type=text], input[type=number]\").val(\"\");\r\n\t$('#person_details select').val('').prop('selected', true);\r\n\r\n\t// assign values to input fields in form\r\n\tif(node.sex === 'M' || node.sex === 'F')\r\n\t\t$('input[name=sex][value=\"'+node.sex+'\"]').prop('checked', true);\r\n\telse\r\n\t\t$('input[name=sex]').prop('checked', false);\r\n\tupdate_cancer_by_sex(node);\r\n\r\n\tif(!('status' in node))\r\n\t\tnode.status = 0;\r\n\t$('input[name=status][value=\"'+node.status+'\"]').prop('checked', true);\r\n\t// show lock symbol for age and yob synchronisation\r\n\tupdateStatus(node.status);\r\n\r\n\tif('proband' in node) {\r\n\t\t$('#id_proband').prop('checked', node.proband);\r\n\t\t$('#id_proband').prop(\"disabled\", true);\r\n\t} else {\r\n\t\t$('#id_proband').prop('checked', false);\r\n\t\t$('#id_proband').prop(\"disabled\", !('yob' in node))\r\n\t}\r\n\r\n\tif('exclude' in node) {\r\n\t\t$('#id_exclude').prop('checked', node.exclude);\r\n\t} else {\r\n\t\t$('#id_exclude').prop('checked', false);\r\n\t}\r\n\r\n/*\t\tif('ashkenazi' in node) {\r\n\t\t\t$('#id_ashkenazi').prop('checked', (node.proband == 1 ? true: false));\r\n\t\t} else {\r\n\t\t\t$('#id_ashkenazi').prop('checked', false);\r\n\t\t}*/\r\n\r\n\t// year of birth\r\n\tif('yob' in node) {\r\n\t\t$('#id_yob_0').val(node.yob);\r\n\t} else {\r\n\t\t$('#id_yob_0').val('-');\r\n\t}\r\n\r\n\t// clear pathology\r\n\t$('select[name$=\"_bc_pathology\"]').val('-');\r\n\t// clear gene tests\r\n\t$('select[name*=\"_gene_test\"]').val('-');\r\n\r\n\t// disable sex radio buttons if the person has a partner\r\n\t$(\"input[id^='id_sex_']\").prop(\"disabled\", (node.parent_node && node.sex !== 'U' ? true : false));\r\n\r\n\t// disable pathology for male relatives (as not used by model)\r\n\t// and if no breast cancer age of diagnosis\r\n\t$(\"select[id$='_bc_pathology']\").prop(\"disabled\",\r\n\t\t\t(node.sex === 'M' || (node.sex === 'F' && !('breast_cancer_diagnosis_age' in node)) ? true : false));\r\n\r\n\t// approximate diagnosis age\r\n\t$('#id_approx').prop('checked', (node.approx_diagnosis_age ? true: false));\r\n\tupdate_diagnosis_age_widget();\r\n\r\n\tfor(let key in node) {\r\n\t\tif(key !== 'proband' && key !== 'sex') {\r\n\t\t\tif($('#id_'+key).length) {\t// input value\r\n\t\t\t\tif(key.indexOf('_gene_test')  !== -1 && node[key] !== null && typeof node[key] === 'object') {\r\n\t\t\t\t\t$('#id_'+key).val(node[key].type);\r\n\t\t\t\t\t$('#id_'+key+'_result').val(node[key].result);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$('#id_'+key).val(node[key]);\r\n\t\t\t\t}\r\n\t\t\t} else if(key.indexOf('_diagnosis_age') !== -1) {\r\n\t\t\t\tif($(\"#id_approx\").is(':checked')) {\r\n\t\t\t\t\t$('#id_'+key+'_1').val(round5(node[key])).prop('selected', true);\r\n\t\t\t\t} else {\r\n\t\t\t\t\t$('#id_'+key+'_0').val(node[key]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\ttry {\r\n\t\t$('#person_details').find('form').valid();\r\n\t} catch(err) {\r\n\t\tconsole.warn('valid() not found');\r\n\t}\r\n}\r\n\r\nfunction update_ashkn(newdataset) {\r\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\tif($('#orig_ashk').is(':checked')) {\r\n\t\t$.each(newdataset, function(_i, p) {\r\n\t\t\tif(p.proband)\r\n\t\t\t\tp.ashkenazi = 1;\r\n\t\t});\r\n\t} else {\r\n\t\t$.each(newdataset, function(_i, p) {\r\n\t\t\tdelete p.ashkenazi;\r\n\t\t});\r\n\t}\r\n}\r\n\r\n// Save Ashkenazi status\r\nexport function save_ashkn(opts) {\r\n\tlet dataset = pedcache_current(opts);\r\n\tlet newdataset = copy_dataset(dataset);\r\n\tupdate_ashkn(newdataset);\r\n\topts.dataset = newdataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function save(opts) {\r\n\tlet dataset = pedcache_current(opts);\r\n\tlet name = $('#id_name').val();\r\n\tlet newdataset = copy_dataset(dataset);\r\n\tlet person = getNodeByName(newdataset, name);\r\n\tif(!person) {\r\n\t\tconsole.warn('person not found when saving details');\r\n\t\treturn;\r\n\t}\r\n\t$(\"#\"+opts.targetDiv).empty();\r\n\r\n\t// individual's personal and clinical details\r\n\tlet yob = $('#id_yob_0').val();\r\n\tif(yob && yob !== '') {\r\n\t\tperson.yob = yob;\r\n\t} else {\r\n\t\tdelete person.yob;\r\n\t}\r\n\r\n\t// current status: 0 = alive, 1 = dead\r\n\tlet status = $('#id_status').find(\"input[type='radio']:checked\");\r\n\tif(status.length > 0){\r\n\t\tperson.status = status.val();\r\n\t}\r\n\r\n\t// booleans switches\r\n\tlet switches = [\"miscarriage\", \"adopted_in\", \"adopted_out\", \"termination\", \"stillbirth\"];\r\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\r\n\t\tlet attr = switches[iswitch];\r\n\t\tlet s = $('#id_'+attr);\r\n\t\tif(s.length > 0){\r\n\t\t\tconsole.log(s.is(\":checked\"));\r\n\t\t\tif(s.is(\":checked\"))\r\n\t\t\t\tperson[attr] = true;\r\n\t\t\telse\r\n\t\t\t\tdelete person[attr];\r\n\t\t}\r\n\t}\r\n\r\n\t// current sex\r\n\tlet sex = $('#id_sex').find(\"input[type='radio']:checked\");\r\n\tif(sex.length > 0){\r\n\t\tperson.sex = sex.val();\r\n\t\tupdate_cancer_by_sex(person);\r\n\t}\r\n\r\n\t// Ashkenazi status, 0 = not Ashkenazi, 1 = Ashkenazi\r\n\tupdate_ashkn(newdataset);\r\n\r\n\tif($('#id_approx').is(':checked')) // approximate diagnosis age\r\n\t\tperson.approx_diagnosis_age = true;\r\n\telse\r\n\t\tdelete person.approx_diagnosis_age;\r\n\r\n\t$(\"#person_details select[name*='_diagnosis_age']:visible, #person_details input[type=text]:visible, #person_details input[type=number]:visible\").each(function() {\r\n\t\tlet name = (this.name.indexOf(\"_diagnosis_age\")>-1 ? this.name.substring(0, this.name.length-2): this.name);\r\n\r\n\t\tif($(this).val()) {\r\n\t\t\tlet val = $(this).val();\r\n\t\t\tif(name.indexOf(\"_diagnosis_age\") > -1 && $(\"#id_approx\").is(':checked'))\r\n\t\t\t\tval = round5(val);\r\n\t\t\tperson[name] = val;\r\n\t\t} else {\r\n\t\t\tdelete person[name];\r\n\t\t}\r\n\t});\r\n\r\n\t// cancer checkboxes\r\n\t$('#person_details input[type=\"checkbox\"][name$=\"cancer\"],input[type=\"checkbox\"][name$=\"cancer2\"]').each(function() {\r\n\t\tif(this.checked)\r\n\t\t\tperson[$(this).attr('name')] = true;\r\n\t\telse\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t});\r\n\r\n\t// pathology tests\r\n\t$('#person_details select[name$=\"_bc_pathology\"]').each(function() {\r\n\t\tif($(this).val() !== '-') {\r\n\t\t\tperson[$(this).attr('name')] = $(this).val();\r\n\t\t} else {\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t\t}\r\n\t});\r\n\r\n\t// genetic tests\r\n\t$('#person_details select[name$=\"_gene_test\"]').each(function() {\r\n\t\tif($(this).val() !== '-') {\r\n\t\t\tlet tres = $('select[name=\"'+$(this).attr('name')+'_result\"]');\r\n\t\t\tperson[$(this).attr('name')] = {'type': $(this).val(), 'result': $(tres).val()};\r\n\t\t} else {\r\n\t\t\tdelete person[$(this).attr('name')];\r\n\t\t}\r\n\t});\r\n\r\n\t// record HOXB13 genetic test\r\n\tlet hoxb13_result = $('#person_details select[name=\"hoxb13_gene_test_result\"]').val();\r\n\tif(hoxb13_result !== undefined && hoxb13_result !== '-') {\r\n\t\tperson[\"hoxb13_gene_test\"] = {'type': 'T', 'result': hoxb13_result};\t// assume direct test\r\n\t} else {\r\n\t\tdelete person[\"hoxb13_gene_test\"];\r\n\t}\r\n\r\n\ttry {\r\n\t\t$('#person_details').find('form').valid();\r\n\t} catch(err) {\r\n\t\tconsole.warn('valid() not found');\r\n\t}\r\n\r\n\tsyncTwins(newdataset, person);\r\n\topts.dataset = newdataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\nexport function update_diagnosis_age_widget() {\r\n\tif($(\"#id_approx\").is(':checked')) {\r\n\t\t$(\"[id$='_diagnosis_age_0']\").each(function( _i ) {\r\n\t\t\tif($(this).val() !== '') {\r\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\r\n\t\t\t\t$(\"#id_\"+name+\"_1\").val(round5($(this).val())).prop('selected', true);\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id$='_diagnosis_age_0']\").hide();\r\n\t\t$(\"[id$='_diagnosis_age_1']\").show();\r\n\t} else {\r\n\t\t$(\"[id$='_diagnosis_age_1']\").each(function( _i ) {\r\n\t\t\tif($(this).val() !== '') {\r\n\t\t\t\tlet name = this.name.substring(0, this.name.length-2);\r\n\t\t\t\t$(\"#id_\"+name+\"_0\").val($(this).val());\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t$(\"[id$='_diagnosis_age_0']\").show();\r\n\t\t$(\"[id$='_diagnosis_age_1']\").hide();\r\n\t}\r\n}\r\n\r\n// males should not have ovarian cancer and females should not have prostate cancer\r\nfunction update_cancer_by_sex(node) {\r\n\t$('#cancer .row').show();\r\n\tif(node.sex === 'M') {\r\n\t\tdelete node.ovarian_cancer_diagnosis_age;\r\n\t\t$(\"[id^='id_ovarian_cancer_diagnosis_age']\").closest('.row').hide();\r\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', true);\r\n\t} else if(node.sex === 'F') {\r\n\t\tdelete node.prostate_cancer_diagnosis_age;\r\n\t\t$(\"[id^='id_prostate_cancer_diagnosis_age']\").closest('.row').hide();\r\n\t\t$(\"[id^='id_breast_cancer2_diagnosis_age']\").prop('disabled', false);\r\n\t}\r\n}\r\n\r\n// round to 5, 15, 25, 35 ....\r\nfunction round5(x1) {\r\n\tlet x2 = (Math.round((x1-1) / 10) * 10);\r\n\treturn (x1 < x2 ? x2 - 5 : x2 + 5);\r\n}\r\n\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// pedigree widgets\r\nimport * as utils from './utils.js';\r\nimport {save} from './popup_form.js';\r\nimport {current as pedcache_current} from './pedcache.js';\r\nimport {getUniqueTwinID, setMzTwin, checkTwins} from './twins.js';\r\n\r\n\r\nlet dragging;\r\nlet last_mouseover;\r\n//\r\n// Add widgets to nodes and bind events\r\nexport function addWidgets(opts, node) {\r\n\r\n\t// popup gender selection box\r\n\tlet font_size = parseInt($(\"body\").css('font-size'));\r\n\tlet popup_selection = d3.select('.diagram');\r\n\tpopup_selection.append(\"rect\").attr(\"class\", \"popup_selection\")\r\n\t\t\t\t\t\t\t.attr(\"rx\", 6)\r\n\t\t\t\t\t\t\t.attr(\"ry\", 6)\r\n\t\t\t\t\t\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t\t\t\t\t\t.style(\"opacity\", 0)\r\n\t\t\t\t\t\t\t.attr(\"width\",  font_size*7.9)\r\n\t\t\t\t\t\t\t.attr(\"height\", font_size*2)\r\n\t\t\t\t\t\t\t.style(\"stroke\", \"darkgrey\")\r\n\t\t\t\t\t\t\t.attr(\"fill\", \"white\");\r\n\r\n\tlet square = popup_selection.append(\"text\")  // male\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"class\", \"popup_selection fa-square persontype\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size/3)\r\n\t\t.attr(\"y\", font_size*1.5)\r\n\t\t.text(\"\\uf096 \");\r\n\tlet square_title = square.append(\"svg:title\").text(\"add male\");\r\n\r\n\tlet circle = popup_selection.append(\"text\")  // female\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"class\", \"popup_selection fa-circle persontype\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size*1.71)\r\n\t\t.attr(\"y\", font_size*1.5)\r\n\t\t.text(\"\\uf10c \");\r\n\tlet circle_title = circle.append(\"svg:title\").text(\"add female\");\r\n\r\n\tlet unspecified = popup_selection.append(\"text\")  // unspecified\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.1em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"x\", font_size*0.065)\r\n\t\t.attr(\"y\", -font_size*0.065)\r\n\t\t.attr(\"class\", \"popup_selection fa-unspecified popup_selection_rotate45 persontype\")\r\n\t\t.text(\"\\uf096 \");\r\n\tunspecified.append(\"svg:title\").text(\"add unspecified\");\r\n\r\n\tlet dztwin = popup_selection.append(\"text\")  // dizygotic twins\r\n\t\t.attr('font-family', 'FontAwesome')\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.style(\"font-size\", \"1.6em\")\r\n\t\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t\t.attr(\"class\", \"popup_selection fa-angle-up persontype dztwin\")\r\n\t\t.attr(\"x\", font_size*4.62)\r\n\t\t.attr(\"y\", font_size*1.5)\r\n\t\t.text(\"\\uf106 \");\r\n\tdztwin.append(\"svg:title\").text(\"add dizygotic/fraternal twins\");\r\n\r\n\tlet mztwin = popup_selection.append(\"text\")  // monozygotic twins\r\n\t.attr('font-family', 'FontAwesome')\r\n\t.style(\"opacity\", 0)\r\n\t.style(\"font-size\", \"1.6em\")\r\n\t.attr(\"transform\", \"translate(-1000,-100)\")\r\n\t.attr(\"class\", \"popup_selection fa-caret-up persontype mztwin\")\r\n\t.attr(\"x\", font_size*6.4)\r\n\t.attr(\"y\", font_size*1.5)\r\n\t.text(\"\\uf0d8 \");\r\n\tmztwin.append(\"svg:title\").text(\"add monozygotic/identical twins\");\r\n\r\n\tlet add_person = {};\r\n\t// click the person type selection\r\n\td3.selectAll(\".persontype\")\r\n\t  .on(\"click\", function () {\r\n\t\tlet newdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\tlet mztwin = d3.select(this).classed(\"mztwin\");\r\n\t\tlet dztwin = d3.select(this).classed(\"dztwin\");\r\n\t\tlet twin_type;\r\n\t\tlet sex;\r\n\t\tif(mztwin || dztwin) {\r\n\t\t\tsex = add_person.node.datum().data.sex;\r\n\t\t\ttwin_type = (mztwin ? \"mztwin\" : \"dztwin\");\r\n\t\t} else {\r\n\t\t\tsex = d3.select(this).classed(\"fa-square\") ? 'M' : (d3.select(this).classed(\"fa-circle\") ? 'F' : 'U');\r\n\t\t}\r\n\r\n\t\tif(add_person.type === 'addsibling')\r\n\t\t\taddsibling(newdataset, add_person.node.datum().data, sex, false, twin_type);\r\n\t\telse if(add_person.type === 'addchild')\r\n\t\t\taddchild(newdataset, add_person.node.datum().data, (twin_type ? 'U' : sex), (twin_type ? 2 : 1), twin_type);\r\n\t\telse\r\n\t\t\treturn;\r\n\t\topts.dataset = newdataset;\r\n\t\t$(document).trigger('rebuild', [opts]);\r\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\r\n\t\tadd_person = {};\r\n\t  })\r\n\t  .on(\"mouseover\", function() {\r\n\t\t  if(add_person.node)\r\n\t\t\t  add_person.node.select('rect').style(\"opacity\", 0.2);\r\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\r\n\t\t  // add tooltips to font awesome widgets\r\n\t\t  if(add_person.type === 'addsibling'){\r\n\t\t\t if(d3.select(this).classed(\"fa-square\"))\r\n\t\t\t\t  square_title.text(\"add brother\");\r\n\t\t\t  else\r\n\t\t\t\t  circle_title.text(\"add sister\");\r\n\t\t  } else if(add_person.type === 'addchild'){\r\n\t\t\t  if(d3.select(this).classed(\"fa-square\"))\r\n\t\t\t\t  square_title.text(\"add son\");\r\n\t\t\t  else\r\n\t\t\t\t  circle_title.text(\"add daughter\");\r\n\t\t  }\r\n\t  });\r\n\r\n\t// handle mouse out of popup selection\r\n\td3.selectAll(\".popup_selection\").on(\"mouseout\", function () {\r\n\t\t// hide rect and popup selection\r\n\t\tif(add_person.node !== undefined && highlight.indexOf(add_person.node.datum()) === -1)\r\n\t\t\tadd_person.node.select('rect').style(\"opacity\", 0);\r\n\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\r\n\t});\r\n\r\n\r\n\t// drag line between nodes to create partners\r\n\tdrag_handle(opts);\r\n\r\n\t// rectangle used to highlight on mouse over\r\n\tnode.filter(function (d) {\r\n\t\t    return d.data.hidden && !opts.DEBUG ? false : true;\r\n\t\t})\r\n\t\t.append(\"rect\")\r\n\t\t.attr(\"class\", 'indi_rect')\r\n\t\t.attr(\"rx\", 6)\r\n\t\t.attr(\"ry\", 6)\r\n\t\t.attr(\"x\", function(_d) { return - 0.75*opts.symbol_size; })\r\n\t\t.attr(\"y\", function(_d) { return - opts.symbol_size; })\r\n\t\t.attr(\"width\",  (1.5 * opts.symbol_size)+'px')\r\n\t\t.attr(\"height\", (2 * opts.symbol_size)+'px')\r\n\t\t.style(\"stroke\", \"black\")\r\n\t\t.style(\"stroke-width\", 0.7)\r\n\t\t.style(\"opacity\", 0)\r\n\t\t.attr(\"fill\", \"lightgrey\");\r\n\r\n\t// widgets\r\n\tlet fx = function(_d) {return off - (0.75*opts.symbol_size);};\r\n\tlet fy = opts.symbol_size -2;\r\n\tlet off = 0;\r\n\tlet widgets = {\r\n\t\t'addchild':   {'text': '\\uf063', 'title': 'add child',   'fx': fx, 'fy': fy},\r\n\t\t'addsibling': {'text': '\\uf234', 'title': 'add sibling', 'fx': fx, 'fy': fy},\r\n\t\t'addpartner': {'text': '\\uf0c1', 'title': 'add partner', 'fx': fx, 'fy': fy},\r\n\t\t'addparents': {\r\n\t\t\t'text': '\\uf062', 'title': 'add parents',\r\n\t\t\t'fx': - 0.75*opts.symbol_size,\r\n\t\t\t'fy': - opts.symbol_size + 11\r\n\t\t},\r\n\t\t'delete': {\r\n\t\t\t'text': 'X', 'title': 'delete',\r\n\t\t\t'fx': (opts.symbol_size/2) - 1,\r\n\t\t\t'fy': - opts.symbol_size + 12,\r\n\t\t\t'styles': {\"font-weight\": \"bold\", \"fill\": \"darkred\", \"font-family\": \"monospace\"}\r\n\t\t}\r\n\t};\r\n\r\n\tif(opts.edit) {\r\n\t\twidgets.settings = {'text': '\\uf013', 'title': 'settings', 'fx': (-font_size/2)+2, 'fy': -opts.symbol_size + 11};\r\n\t}\r\n\r\n\tfor(let key in widgets) {\r\n\t\tlet widget = node.filter(function (d) {\r\n\t\t\t\treturn  (d.data.hidden && !opts.DEBUG ? false : true) &&\r\n\t\t\t\t\t\t!((d.data.mother === undefined || d.data.noparents) && key === 'addsibling') &&\r\n\t\t\t\t\t\t!(d.data.parent_node !== undefined && d.data.parent_node.length > 1 && key === 'addpartner') &&\r\n\t\t\t\t\t\t!(d.data.parent_node === undefined && key === 'addchild') &&\r\n\t\t\t\t\t\t!((d.data.noparents === undefined && d.data.top_level === undefined) && key === 'addparents');\r\n\t\t\t})\r\n\t\t\t.append(\"text\")\r\n\t\t\t.attr(\"class\", key)\r\n\t\t\t.style(\"opacity\", 0)\r\n\t\t\t.attr('font-family', 'FontAwesome')\r\n\t\t\t.attr(\"xx\", function(d){return d.x;})\r\n\t\t\t.attr(\"yy\", function(d){return d.y;})\r\n\t\t\t.attr(\"x\", widgets[key].fx)\r\n\t\t\t.attr(\"y\", widgets[key].fy)\r\n\t\t\t.attr('font-size', '0.85em' )\r\n\t\t\t.text(widgets[key].text);\r\n\r\n\t\tif('styles' in widgets[key])\r\n\t\t\tfor(let style in widgets[key].styles){\r\n\t\t\t\twidget.attr(style, widgets[key].styles[style]);\r\n\t\t\t}\r\n\r\n\t\twidget.append(\"svg:title\").text(widgets[key].title);\r\n\t\toff += 17;\r\n\t}\r\n\r\n\t// add sibling or child\r\n\td3.selectAll(\".addsibling, .addchild\")\r\n\t  .on(\"mouseover\", function () {\r\n\t\t  let type = d3.select(this).attr('class');\r\n\t\t  d3.selectAll('.popup_selection').style(\"opacity\", 1);\r\n\t\t  add_person = {'node': d3.select(this.parentNode), 'type': type};\r\n\r\n\t\t  //let translate = getTranslation(d3.select('.diagram').attr(\"transform\"));\r\n\t\t  let x = parseInt(d3.select(this).attr(\"xx\")) + parseInt(d3.select(this).attr(\"x\"));\r\n\t\t  let y = parseInt(d3.select(this).attr(\"yy\")) + parseInt(d3.select(this).attr(\"y\"));\r\n\t\t  d3.selectAll('.popup_selection').attr(\"transform\", \"translate(\"+x+\",\"+(y+2)+\")\");\r\n\t\t  d3.selectAll('.popup_selection_rotate45')\r\n\t\t\t.attr(\"transform\", \"translate(\"+(x+(3*font_size))+\",\"+(y+(font_size*1.2))+\") rotate(45)\");\r\n\t  });\r\n\r\n\t// handle widget clicks\r\n\td3.selectAll(\".addchild, .addpartner, .addparents, .delete, .settings\")\r\n\t  .on(\"click\", function (e) {\r\n\t\t  e.stopPropagation();\r\n\t\tlet opt = d3.select(this).attr('class');\r\n\t\tlet d = d3.select(this.parentNode).datum();\r\n\t\tif(opts.DEBUG) {\r\n\t\t\tconsole.log(opt);\r\n\t\t}\r\n\r\n\t\tlet newdataset;\r\n\t\tif(opt === 'settings') {\r\n\t\t\tif(typeof opts.edit === 'function') {\r\n\t\t\t\topts.edit(opts, d);\r\n\t\t\t} else {\r\n\t\t\t\topenEditDialog(opts, d);\r\n\t\t\t}\r\n\t\t} else if(opt === 'delete') {\r\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\tdelete_node_dataset(newdataset, d.data, opts, onDone);\r\n\t\t} else if(opt === 'addparents') {\r\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\topts.dataset = newdataset;\r\n\t\t\taddparents(opts, newdataset, d.data.name);\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t} else if(opt === 'addpartner') {\r\n\t\t\tnewdataset = utils.copy_dataset(pedcache_current(opts));\r\n\t\t\taddpartner(opts, newdataset, d.data.name);\r\n\t\t\topts.dataset = newdataset;\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t}\r\n\t\t// trigger fhChange event\r\n\t\t$(document).trigger('fhChange', [opts]);\r\n\t});\r\n\r\n\t// other mouse events\r\n\tlet highlight = [];\r\n\r\n\tnode.filter(function (d) { return !d.data.hidden; })\r\n\t.on(\"click\", function (e, d) {\r\n\t\tif (e.ctrlKey) {\r\n\t\t\tif(highlight.indexOf(d) === -1)\r\n\t\t\t\thighlight.push(d);\r\n\t\t\telse\r\n\t\t\t\thighlight.splice(highlight.indexOf(d), 1);\r\n\t\t} else\r\n\t\t\thighlight = [d];\r\n\r\n\t\tif('nodeclick' in opts) {\r\n\t\t\topts.nodeclick(d.data);\r\n\t\t\td3.selectAll(\".indi_rect\").style(\"opacity\", 0);\r\n\t\t\td3.selectAll('.indi_rect').filter(function(d) {return highlight.indexOf(d) !== -1;}).style(\"opacity\", 0.5);\r\n\t\t}\r\n\t})\r\n\t.on(\"mouseover\", function(e, d){\r\n\t\te.stopPropagation();\r\n\t\tlast_mouseover = d;\r\n\t\tif(dragging) {\r\n\t\t\tif(dragging.data.name !== last_mouseover.data.name &&\r\n\t\t\t   dragging.data.sex !== last_mouseover.data.sex) {\r\n\t\t\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\t\td3.select(this).select('rect').style(\"opacity\", 0.2);\r\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 1);\r\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 0);\r\n\r\n\t\tsetLineDragPosition(opts.symbol_size-10, 0, opts.symbol_size-2, 0, d.x+\",\"+(d.y+2));\r\n\t})\r\n\t.on(\"mouseout\", function(d){\r\n\t\tif(dragging)\r\n\t\t\treturn;\r\n\r\n\t\td3.select(this).selectAll('.addchild, .addsibling, .addpartner, .addparents, .delete, .settings').style(\"opacity\", 0);\r\n\t\tif(highlight.indexOf(d) === -1)\r\n\t\t\td3.select(this).select('rect').style(\"opacity\", 0);\r\n\t\td3.select(this).selectAll('.indi_details').style(\"opacity\", 1);\r\n\t\t// hide popup if it looks like the mouse is moving north\r\n\t\tlet xcoord = d3.pointer(d)[0];\r\n\t\tlet ycoord = d3.pointer(d)[1];\r\n\t\tif(ycoord < 0.8*opts.symbol_size)\r\n\t\t\td3.selectAll('.popup_selection').style(\"opacity\", 0);\r\n\t\tif(!dragging) {\r\n\t\t\t// hide popup if it looks like the mouse is moving north, south or west\r\n\t\t\tif( Math.abs(ycoord) > 0.25*opts.symbol_size ||\r\n\t\t\t\tMath.abs(ycoord) < -0.25*opts.symbol_size ||\r\n\t\t\t\txcoord < 0.2*opts.symbol_size){\r\n\t\t\t\t\tsetLineDragPosition(0, 0, 0, 0);\r\n\t\t\t}\r\n        }\r\n\t});\r\n}\r\n\r\nfunction onDone(opts, dataset) {\r\n\t// assign new dataset and rebuild pedigree\r\n\topts.dataset = dataset;\r\n\t$(document).trigger('rebuild', [opts]);\r\n}\r\n\r\n// drag line between nodes to create partners\r\nfunction drag_handle(opts) {\r\n\tlet line_drag_selection = d3.select('.diagram');\r\n\tlet dline = line_drag_selection.append(\"line\").attr(\"class\", 'line_drag_selection')\r\n        .attr(\"stroke-width\", 6)\r\n        .style(\"stroke-dasharray\", (\"2, 1\"))\r\n        .attr(\"stroke\",\"black\")\r\n        .call(d3.drag()\r\n                .on(\"start\", dragstart)\r\n                .on(\"drag\", drag)\r\n                .on(\"end\", dragstop));\r\n\tdline.append(\"svg:title\").text(\"drag to create consanguineous partners\");\r\n\r\n\tsetLineDragPosition(0, 0, 0, 0);\r\n\r\n\tfunction dragstart() {\r\n\t\tdragging = last_mouseover;\r\n\t\td3.selectAll('.line_drag_selection')\r\n\t\t\t.attr(\"stroke\",\"darkred\");\r\n\t}\r\n\r\n\tfunction dragstop(_d) {\r\n\t\tif(last_mouseover &&\r\n\t\t   dragging.data.name !== last_mouseover.data.name &&\r\n\t\t   dragging.data.sex  !== last_mouseover.data.sex) {\r\n\t\t\t// make partners\r\n\t\t\tlet child = {\"name\": utils.makeid(4), \"sex\": 'U',\r\n\t\t\t\t     \"mother\": (dragging.data.sex === 'F' ? dragging.data.name : last_mouseover.data.name),\r\n\t\t\t         \"father\": (dragging.data.sex === 'F' ? last_mouseover.data.name : dragging.data.name)};\r\n\t\t\tlet newdataset = utils.copy_dataset(opts.dataset);\r\n\t\t\topts.dataset = newdataset;\r\n\r\n\t\t\tlet idx = utils.getIdxByName(opts.dataset, dragging.data.name)+1;\r\n\t\t\topts.dataset.splice(idx, 0, child);\r\n\t\t\t$(document).trigger('rebuild', [opts]);\r\n\t\t}\r\n\t\tsetLineDragPosition(0, 0, 0, 0);\r\n\t\td3.selectAll('.line_drag_selection')\r\n\t\t\t.attr(\"stroke\",\"black\");\r\n\t\tdragging = undefined;\r\n\t\treturn;\r\n\t}\r\n\r\n\tfunction drag(e) {\r\n\t\te.sourceEvent.stopPropagation();\r\n\t\tlet dx = e.dx;\r\n\t\tlet dy = e.dy;\r\n\t\tlet xnew = parseFloat(d3.select(this).attr('x2'))+ dx;\r\n        let ynew = parseFloat(d3.select(this).attr('y2'))+ dy;\r\n        setLineDragPosition(opts.symbol_size-10, 0, xnew, ynew);\r\n\t}\r\n}\r\n\r\n/**\r\n * Set the position and start and end of consanguineous widget.\r\n */\r\nfunction setLineDragPosition(x1, y1, x2, y2, translate) {\r\n\tif(translate) {\r\n\t\td3.selectAll('.line_drag_selection').attr(\"transform\", \"translate(\"+translate+\")\");\r\n\t}\r\n\td3.selectAll('.line_drag_selection')\r\n\t\t.attr(\"x1\", x1)\r\n\t\t.attr(\"y1\", y1)\r\n\t\t.attr(\"x2\", x2)\r\n\t\t.attr(\"y2\", y2);\r\n}\r\n\r\nfunction capitaliseFirstLetter(string) {\r\n    return string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n\r\n// if opt.edit is set true (rather than given a function) this is called to edit node attributes\r\nfunction openEditDialog(opts, d) {\r\n\t$('#node_properties').dialog({\r\n\t    autoOpen: false,\r\n\t    title: d.data.display_name,\r\n\t    width: ($(window).width() > 400 ? 450 : $(window).width()- 30)\r\n\t});\r\n\r\n\tlet current_year = new Date().getFullYear();\r\n\tlet table = \"<table id='person_details' class='table'>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>ID Unico</td><td><input class='form-control' type='text' id='id_name' name='name' value=\"+\r\n\t(d.data.name ? d.data.name : \"\")+\" disabled></td></tr>\";\r\n\ttable += \"<tr><td style='text-align:right'>Nome</td><td><input class='form-control' type='text' id='id_display_name' name='display_name' value=\"+\r\n\t\t\t(d.data.display_name ? d.data.display_name : \"\")+\"></td></tr>\";\r\n\r\n\ttable += \"<tr><td style='text-align:right'>Età</td><td><input class='form-control' type='number' id='id_age' min='0' max='120' name='age' style='width:7em' value=\"+\r\n\t\t\t(d.data.age ? d.data.age : \"\")+\"></td></tr>\";\r\n\r\n\ttable += `<tr><td style='text-align:right'>Anno di nascita</td><td><input class='form-control' type='number' id='id_yob' min='1900' max='${current_year}' name='yob' style='width:7em' value=`+\r\n\t\t(d.data.yob ? d.data.yob : \"\")+\"></td></tr>\";\r\n\t// table += '<tr><td colspan=\"2\" id=\"id_sex\">' + '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" ' + (d.data.sex === 'M' ? \"checked\" : \"\") + '>Maschio</label>' + '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" ' + (d.data.sex === 'F' ? \"checked\" : \"\") + '>Femmina</label>' + '<label class=\"radio-inline\" style=\"display: none;\"><input type=\"radio\" name=\"sex\" value=\"U\" style=\"display: none;\">Ignoto</label>' + '</td></tr>';\r\n\ttable += `<tr><td colspan=\"2\" id=\"id_sex\"> <label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" ${d.data.sex === 'M' ? \"checked\" : \"\"}>Maschio</label> <label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" ${d.data.sex === 'F' ? \"checked\" : \"\"}>Femmina</label> <label class=\"radio-inline\" style=\"display: none;\"><input type=\"radio\" name=\"sex\" value=\"U\" style=\"display: none;\">Ignoto</label> </td></tr>`;\r\n\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_sex\">' +\r\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"M\" '+(d.data.sex === 'M' ? \"checked\" : \"\")+'>Maschio</label>' +\r\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"F\" '+(d.data.sex === 'F' ? \"checked\" : \"\")+'>Femmina</label>' +\r\n\t\t\t '<label class=\"radio-inline\"><input type=\"radio\" name=\"sex\" value=\"U\">Unknown</label>' +\r\n\t\t\t '</td></tr>';\r\n\r\n\t// alive status = 0; dead status = 1\r\n\ttable += '<tr><td colspan=\"2\" id=\"id_status\">' +\r\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"0\" '+(parseInt(d.data.status) === 0 ? \"checked\" : \"\")+'>&thinsp;Vivo</label>' +\r\n\t\t\t '<label class=\"checkbox-inline\"><input type=\"radio\" name=\"status\" value=\"1\" '+(parseInt(d.data.status) === 1 ? \"checked\" : \"\")+'>&thinsp;Deceduto</label>' +\r\n\t\t\t '</td></tr>';\r\n\t$(\"#id_status input[value='\"+d.data.status+\"']\").prop('checked', true);\r\n\r\n\t// switches\r\n\tlet switches = [\"adopted_in\", \"adopted_out\", \"miscarriage\", \"stillbirth\", \"termination\"];\r\n\ttable += '<tr><td colspan=\"2\"><strong>Riproduzione:</strong></td></tr>';\r\n\ttable += '<tr><td colspan=\"2\">';\r\n\tfor(let iswitch=0; iswitch<switches.length; iswitch++){\r\n\t\tlet attr = switches[iswitch];\r\n\t\tif(iswitch === 2)\r\n\t\t\ttable += '</td></tr><tr><td colspan=\"2\">';\r\n\t\ttable +=\r\n\t\t '<label class=\"checkbox-inline\"><input type=\"checkbox\" id=\"id_'+attr +\r\n\t\t    '\" name=\"'+attr+'\" value=\"0\" '+(d.data[attr] ? \"checked\" : \"\")+'>&thinsp;' +\r\n\t\t    capitaliseFirstLetter(attr.replace('_', ' '))+'</label>'\r\n\t}\r\n\ttable += '</td></tr>';\r\n\r\n\t//\r\n\tlet exclude = [\"children\", \"name\", \"parent_node\", \"top_level\", \"id\", \"noparents\",\r\n\t\t           \"level\", \"age\", \"sex\", \"status\", \"display_name\", \"mother\", \"father\",\r\n\t\t           \"yob\", \"mztwin\", \"dztwin\"];\r\n\t$.merge(exclude, switches);\r\n\ttable += '<tr><td colspan=\"2\"><strong>Età alla diagnosi:</strong></td></tr>';\r\n\t$.each(opts.diseases, function(k, v) {\r\n\t\texclude.push(v.type+\"_diagnosis_age\");\r\n\r\n\t\tlet disease_colour = '&thinsp;<span style=\"padding-left:5px;background:'+opts.diseases[k].colour+'\"></span>';\r\n\t\tlet diagnosis_age = d.data[v.type + \"_diagnosis_age\"];\r\n\r\n\t\ttable += \"<tr><td style='text-align:right'>\"+capitaliseFirstLetter(v.type.replace(\"_\", \" \"))+\r\n\t\t\t\t\tdisease_colour+\"&nbsp;</td><td>\" +\r\n\t\t\t\t\t\"<input class='form-control' id='id_\" +\r\n\t\t\t\t\tv.type + \"_diagnosis_age_0' max='110' min='0' name='\" +\r\n\t\t\t\t\tv.type + \"_diagnosis_age_0' style='width:5em' type='number' value='\" +\r\n\t\t\t\t\t(diagnosis_age !== undefined ? diagnosis_age : \"\") +\"'></td></tr>\";\r\n\t});\r\n\r\n\ttable += '<tr><td colspan=\"2\" style=\"line-height:1px;\"></td></tr>';\r\n\t$.each(d.data, function(k, v) {\r\n\t\tif($.inArray(k, exclude) === -1) {\r\n\t\t\tlet kk = capitaliseFirstLetter(k);\r\n\t\t\tif(v === true || v === false) {\r\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='checkbox' id='id_\" + k + \"' name='\" +\r\n\t\t\t\t\t\tk+\"' value=\"+v+\" \"+(v ? \"checked\" : \"\")+\"></td></tr>\";\r\n\t\t\t} else if(k.length > 0){\r\n\t\t\t\ttable += \"<tr><td style='text-align:right'>\"+kk+\"&nbsp;</td><td><input type='text' id='id_\" +\r\n\t\t\t\t\t\tk+\"' name='\"+k+\"' value=\"+v+\"></td></tr>\";\r\n\t\t\t}\r\n\t\t}\r\n    });\r\n\ttable += \"</table>\";\r\n\r\n\t$('#node_properties').html(table);\r\n\t$('#node_properties').dialog('open');\r\n\r\n\t$('#node_properties input[type=radio], #node_properties input[type=checkbox], #node_properties input[type=text], #node_properties input[type=number]').change(function() {\r\n\t\tsave(opts);\r\n    });\r\n\treturn;\r\n}\r\n\r\n\r\n\r\n// add children to a given node\r\nexport function addchild(dataset, node, sex, nchild, twin_type) {\r\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\r\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\r\n\r\n\tif (typeof nchild === typeof undefined)\r\n\t\tnchild = 1;\r\n\tlet children = utils.getAllChildren(dataset, node);\r\n\tlet ptr_name, idx;\r\n\tif (children.length === 0) {\r\n\t\tlet partner = addsibling(dataset, node, node.sex === 'F' ? 'M': 'F', node.sex === 'F');\r\n\t\tpartner.noparents = true;\r\n\t\tptr_name = partner.name;\r\n\t\tidx = utils.getIdxByName(dataset, node.name)+1;\r\n\t} else {\r\n\t\tlet c = children[0];\r\n\t\tptr_name = (c.father === node.name ? c.mother : c.father);\r\n\t\tidx = utils.getIdxByName(dataset, c.name);\r\n\t}\r\n\r\n\tlet twin_id;\r\n\tif(twin_type)\r\n\t\ttwin_id = getUniqueTwinID(dataset, twin_type);\r\n\tlet newchildren = [];\r\n\tfor (let i = 0; i < nchild; i++) {\r\n\t\tlet child = {\"name\": utils.makeid(4), \"sex\": sex,\r\n\t\t\t\t\t \"mother\": (node.sex === 'F' ? node.name : ptr_name),\r\n\t\t\t\t\t \"father\": (node.sex === 'F' ? ptr_name : node.name)};\r\n\t\tdataset.splice(idx, 0, child);\r\n\r\n\t\tif(twin_type)\r\n\t\t\tchild[twin_type] = twin_id;\r\n\t\tnewchildren.push(child);\r\n\t}\r\n\treturn newchildren;\r\n}\r\n\r\n//\r\nexport function addsibling(dataset, node, sex, add_lhs, twin_type) {\r\n\tif(twin_type && $.inArray(twin_type, [ \"mztwin\", \"dztwin\" ] ) === -1)\r\n\t\treturn new Error(\"INVALID TWIN TYPE SET: \"+twin_type);\r\n\r\n\tlet newbie = {\"name\": utils.makeid(4), \"sex\": sex};\r\n\tif(node.top_level) {\r\n\t\tnewbie.top_level = true;\r\n\t} else {\r\n\t\tnewbie.mother = node.mother;\r\n\t\tnewbie.father = node.father;\r\n\t}\r\n\tlet idx = utils.getIdxByName(dataset, node.name);\r\n\r\n\tif(twin_type) {\r\n\t\tsetMzTwin(dataset, dataset[idx], newbie, twin_type);\r\n\t}\r\n\r\n\tif(add_lhs) { // add to LHS\r\n\t\tif(idx > 0) idx--;\r\n\t} else\r\n\t\tidx++;\r\n\tdataset.splice(idx, 0, newbie);\r\n\treturn newbie;\r\n}\r\n\r\n// add parents to the 'node'\r\nexport function addparents(opts, dataset, name) {\r\n\tlet mother, father;\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flat_tree = utils.flatten(root);\r\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\r\n\tlet node  = tree_node.data;\r\n\tlet depth = tree_node.depth;   // depth of the node in relation to the root (depth = 1 is a top_level node)\r\n\r\n\tlet pid = -101;\r\n\tlet ptr_name;\r\n\tlet children = utils.getAllChildren(dataset, node);\r\n\tif(children.length > 0){\r\n\t\tptr_name = children[0].mother === node.name ? children[0].father : children[0].mother;\r\n\t\tpid = utils.getNodeByName(flat_tree, ptr_name).data.id;\r\n\t}\r\n\r\n\tlet i;\r\n\tif(depth === 1) {\r\n\t\tmother = {\"name\": utils.makeid(4), \"sex\": \"F\", \"top_level\": true};\r\n\t\tfather = {\"name\": utils.makeid(4), \"sex\": \"M\", \"top_level\": true};\r\n\t\tdataset.splice(0, 0, mother);\r\n\t\tdataset.splice(0, 0, father);\r\n\r\n\t\tfor(i=0; i<dataset.length; i++){\r\n\t\t\tif( (dataset[i].top_level || utils.getDepth(dataset, dataset[i].name) === 2) && \r\n\t\t\t     dataset[i].name !== mother.name && dataset[i].name !== father.name){\r\n\t\t\t\tdelete dataset[i].top_level;\r\n\t\t\t\tdataset[i].noparents = true;\r\n\t\t\t\tdataset[i].mother = mother.name;\r\n\t\t\t\tdataset[i].father = father.name;\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tlet node_mother = utils.getNodeByName(flat_tree, tree_node.data.mother);\r\n\t\tlet node_father = utils.getNodeByName(flat_tree, tree_node.data.father);\r\n\t\tlet node_sibs = utils.getAllSiblings(dataset, node);\r\n\r\n\t\t// lhs & rhs id's for siblings of this node\r\n\t\tlet rid = 10000;\r\n\t\tlet lid = tree_node.data.id;\r\n\t\tfor(i=0; i<node_sibs.length; i++){\r\n\t\t\tlet sid = utils.getNodeByName(flat_tree, node_sibs[i].name).data.id;\r\n\t\t\tif(sid < rid && sid > tree_node.data.id)\r\n\t\t\t\trid = sid;\r\n\t\t\tif(sid < lid)\r\n\t\t\t\tlid = sid;\r\n\t\t}\r\n\t\tlet add_lhs = (lid >= tree_node.data.id || (pid === lid && rid < 10000));\r\n\t\tif(opts.DEBUG)\r\n\t\t\tconsole.log('lid='+lid+' rid='+rid+' nid='+tree_node.data.id+' ADD_LHS='+add_lhs);\r\n\t\tlet midx;\r\n\t\tif( (!add_lhs && node_father.data.id > node_mother.data.id) ||\r\n\t\t\t(add_lhs && node_father.data.id < node_mother.data.id) )\r\n\t\t\tmidx = utils.getIdxByName(dataset, node.father);\r\n\t\telse\r\n\t\t\tmidx = utils.getIdxByName(dataset, node.mother);\r\n\r\n\t\tlet parent = dataset[midx];\r\n\t\tfather = addsibling(dataset, parent, 'M', add_lhs);\r\n\t\tmother = addsibling(dataset, parent, 'F', add_lhs);\r\n\r\n\t\tlet faidx = utils.getIdxByName(dataset, father.name);\r\n\t\tlet moidx = utils.getIdxByName(dataset, mother.name);\r\n\t\tif(faidx > moidx) {\t\t\t\t   // switch to ensure father on lhs of mother\r\n\t\t\tlet tmpfa = dataset[faidx];\r\n\t\t\tdataset[faidx] = dataset[moidx];\r\n\t\t\tdataset[moidx] = tmpfa;\r\n\t\t}\r\n\r\n\t\tlet orphans = utils.getAdoptedSiblings(dataset, node);\r\n\t\tlet nid = tree_node.data.id;\r\n\t\tfor(i=0; i<orphans.length; i++){\r\n\t\t\tlet oid = utils.getNodeByName(flat_tree, orphans[i].name).data.id;\r\n\t\t\tif(opts.DEBUG)\r\n\t\t\t\tconsole.log('ORPHAN='+i+' '+orphans[i].name+' '+(nid < oid && oid < rid)+' nid='+nid+' oid='+oid+' rid='+rid);\r\n\t\t\tif((add_lhs || nid < oid) && oid < rid){\r\n\t\t\t\tlet oidx = utils.getIdxByName(dataset, orphans[i].name);\r\n\t\t\t\tdataset[oidx].mother = mother.name;\r\n\t\t\t\tdataset[oidx].father = father.name;\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif(depth === 2) {\r\n\t\tmother.top_level = true;\r\n\t\tfather.top_level = true;\r\n\t} else if(depth > 2) {\r\n\t\tmother.noparents = true;\r\n\t\tfather.noparents = true;\r\n\t}\r\n\tlet idx = utils.getIdxByName(dataset, node.name);\r\n\tdataset[idx].mother = mother.name;\r\n\tdataset[idx].father = father.name;\r\n\tdelete dataset[idx].noparents;\r\n\r\n\tif('parent_node' in node) {\r\n\t\tlet ptr_node = dataset[utils.getIdxByName(dataset, ptr_name)];\r\n\t\tif('noparents' in ptr_node) {\r\n\t\t\tptr_node.mother = mother.name;\r\n\t\t\tptr_node.father = father.name;\r\n\t\t}\r\n\t}\r\n}\r\n\r\n// add partner\r\nexport function addpartner(opts, dataset, name) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flat_tree = utils.flatten(root);\r\n\tlet tree_node = utils.getNodeByName(flat_tree, name);\r\n\r\n\tlet partner = addsibling(dataset, tree_node.data, tree_node.data.sex === 'F' ? 'M' : 'F', tree_node.data.sex === 'F');\r\n\tpartner.noparents = true;\r\n\r\n\tlet child = {\"name\": utils.makeid(4), \"sex\": \"M\"};\r\n\tchild.mother = (tree_node.data.sex === 'F' ? tree_node.data.name : partner.name);\r\n\tchild.father = (tree_node.data.sex === 'F' ? partner.name : tree_node.data.name);\r\n\r\n\tlet idx = utils.getIdxByName(dataset, tree_node.data.name)+2;\r\n\tdataset.splice(idx, 0, child);\r\n}\r\n\r\n// get adjacent nodes at the same depth\r\nfunction adjacent_nodes(root, node, excludes) {\r\n\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), node.depth, excludes);\r\n\tlet lhs_node, rhs_node;\r\n\tfor(let i=0; i<dnodes.length; i++) {\r\n\t\tif(dnodes[i].x < node.x)\r\n\t\t\tlhs_node = dnodes[i];\r\n\t\tif(!rhs_node && dnodes[i].x > node.x)\r\n\t\t\trhs_node = dnodes[i];\r\n\t}\r\n\treturn [lhs_node, rhs_node];\r\n}\r\n\r\n// delete a node and descendants\r\nexport function delete_node_dataset(dataset, node, opts, onDone) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet fnodes = utils.flatten(root);\r\n\tlet deletes = [];\r\n\tlet i, j;\r\n\r\n\t// get d3 data node\r\n\tif(node.id === undefined) {\r\n\t\tlet d3node = utils.getNodeByName(fnodes, node.name);\r\n\t\tif(d3node !== undefined)\r\n\t\t\tnode = d3node.data;\r\n\t}\r\n\r\n\tif(node.parent_node) {\r\n\t\tfor(i=0; i<node.parent_node.length; i++){\r\n\t\t\tlet parent = node.parent_node[i];\r\n\t\t\tlet ps = [utils.getNodeByName(dataset, parent.mother.name),\r\n\t\t\t\t\t  utils.getNodeByName(dataset, parent.father.name)];\r\n\t\t\t// delete parents\r\n\t\t\tfor(j=0; j<ps.length; j++) {\r\n\t\t\t\tif(ps[j].name === node.name || ps[j].noparents !== undefined || ps[j].top_level) {\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ps[j].name), 1);\r\n\t\t\t\t\tdeletes.push(ps[j]);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tlet children = parent.children;\r\n\t\t\tlet children_names = $.map(children, function(p, _i){return p.name;});\r\n\t\t\tfor(j=0; j<children.length; j++) {\r\n\t\t\t\tlet child = utils.getNodeByName(dataset, children[j].name);\r\n\t\t\t\tif(child){\r\n\t\t\t\t\tchild.noparents = true;\r\n\t\t\t\t\tlet ptrs = utils.get_partners(dataset, child);\r\n\t\t\t\t\tlet ptr;\r\n\t\t\t\t\tif(ptrs.length > 0)\r\n\t\t\t\t\t\tptr = utils.getNodeByName(dataset, ptrs[0]);\r\n\t\t\t\t\tif(ptr && ptr.mother !== child.mother) {\r\n\t\t\t\t\t\tchild.mother = ptr.mother;\r\n\t\t\t\t\t\tchild.father = ptr.father;\r\n\t\t\t\t\t} else if(ptr) {\r\n\t\t\t\t\t\tlet child_node  = utils.getNodeByName(fnodes, child.name);\r\n\t\t\t\t\t\tlet adj = adjacent_nodes(root, child_node, children_names);\r\n\t\t\t\t\t\tchild.mother = adj[0] ? adj[0].data.mother : (adj[1] ? adj[1].data.mother : null);\r\n\t\t\t\t\t\tchild.father = adj[0] ? adj[0].data.father : (adj[1] ? adj[1].data.father : null);\r\n\t\t\t\t\t} else {\r\n\t\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, child.name), 1);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t} else {\r\n\t\tdataset.splice(utils.getIdxByName(dataset, node.name), 1);\r\n\t}\r\n\r\n\t// delete ancestors\r\n\tconsole.log(deletes);\r\n\tfor(i=0; i<deletes.length; i++) {\r\n\t\tlet del = deletes[i];\r\n\t\tlet sibs = utils.getAllSiblings(dataset, del);\r\n\t\tconsole.log('DEL', del.name, sibs);\r\n\t\tif(sibs.length < 1) {\r\n\t\t\tconsole.log('del sibs', del.name, sibs);\r\n\t\t\tlet data_node  = utils.getNodeByName(fnodes, del.name);\r\n\t\t\tlet ancestors = data_node.ancestors();\r\n\t\t\tfor(j=0; j<ancestors.length; j++) {\r\n\t\t\t\tconsole.log(ancestors[i]);\r\n\t\t\t\tif(ancestors[j].data.mother){\r\n\t\t\t\t\tconsole.log('DELETE ', ancestors[j].data.mother, ancestors[j].data.father);\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.mother.name), 1);\r\n\t\t\t\t\tdataset.splice(utils.getIdxByName(dataset, ancestors[j].data.father.name), 1);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\t// check integrity of mztwins settings\r\n\tcheckTwins(dataset);\r\n\r\n\tlet uc;\r\n\ttry\t{\r\n\t\t// validate new pedigree dataset\r\n\t\tlet newopts = $.extend({}, opts);\r\n\t\tnewopts.dataset = utils.copy_dataset(dataset);\r\n\t\tutils.validate_pedigree(newopts);\r\n\t\t// check if pedigree is split\r\n\t\tuc = utils.unconnected(dataset);\r\n\t} catch(err) {\r\n\t\tutils.messages('Warning', 'Deletion of this pedigree member is disallowed.')\r\n\t\tthrow err;\r\n\t}\r\n\tif(uc.length > 0) {\r\n\t\t// check & warn only if this is a new split\r\n\t\tif(utils.unconnected(opts.dataset).length === 0) {\r\n\t\t\tconsole.error(\"individuals unconnected to pedigree \", uc);\r\n\t\t\tutils.messages(\"Warning\", \"Deleting this will split the pedigree. Continue?\", onDone, opts, dataset);\r\n\t\t\treturn;\r\n\t\t}\r\n\t}\r\n\r\n\tif(onDone) {\r\n\t\tonDone(opts, dataset);\r\n\t}\r\n\treturn dataset;\r\n}\r\n\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {prefixInObj} from './utils.js';\r\n\r\nexport function addLabels(opts, node) {\r\n\t// names of individuals\r\n\taddLabel(opts, node, -(0.4 * opts.symbol_size), -(0.1 * opts.symbol_size),\r\n\t\t\tfunction(d) {\r\n\t\t\t\tif(opts.DEBUG)\r\n\t\t\t\t\treturn ('display_name' in d.data ? d.data.display_name : d.data.name) + '  ' + d.data.id;\r\n\t\t\t\treturn 'display_name' in d.data ? d.data.display_name : '';}, undefined, ['display_name']);\r\n\r\n\tlet font_size = parseInt(getPx(opts)) + 4;\r\n\t// display age/yob label first\r\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\r\n\t\tlet label = opts.labels[ilab];\r\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\r\n\t\tif(arr.indexOf('age') > -1 || arr.indexOf('yob') > -1) {\r\n\t\t\taddLabel(opts, node, -opts.symbol_size,\r\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\r\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\r\n\t\t}\r\n\t}\r\n\r\n\t// individuals disease details\r\n\tfor(let i=0;i<opts.diseases.length; i++) {\r\n\t\tlet disease = opts.diseases[i].type;\r\n\t\taddLabel(opts, node, -opts.symbol_size,\r\n\t\t\t\tfunction(d) { return ypos(d, [disease], font_size); },\r\n\t\t\t\tfunction(d) {\r\n\t\t\t\t\tlet dis = disease.replace('_', ' ').replace('cancer', 'ca.');\r\n\t\t\t\t\treturn disease+'_diagnosis_age' in d.data ? dis +\": \"+ d.data[disease+'_diagnosis_age'] : '';\r\n\t\t\t\t}, 'indi_details', [disease]);\r\n\t}\r\n\r\n\t// display other labels defined in opts.labels e.g. alleles/genotype data\r\n\tfor(let ilab=0; ilab<opts.labels.length; ilab++) {\r\n\t\tlet label = opts.labels[ilab];\r\n\t\tlet arr = (Array.isArray(label) ? label : [label]);\r\n\t\tif(arr.indexOf('age') === -1 && arr.indexOf('yob') === -1) {\r\n\t\t\taddLabel(opts, node, -opts.symbol_size,\r\n\t\t\t\tfunction(d) { return ypos(d, arr, font_size); },\r\n\t\t\t\tfunction(d) { return get_text(d, arr); }, 'indi_details', arr);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nfunction get_text(d, arr) {\r\n\tlet txt = \"\";\r\n\tfor(let l=0; l<arr.length; l++) {\r\n\t\tlet this_label = arr[l];\r\n\t\tif(d.data[this_label]) {\r\n\t\t\tif(this_label === 'alleles') {\r\n\t\t\t\tlet vars = d.data.alleles.split(';');\r\n\t\t\t\tfor(let ivar = 0;ivar < vars.length;ivar++) {\r\n\t\t\t\t\tif(vars[ivar] !== \"\") txt += vars[ivar] + ';';\r\n\t\t\t\t}\r\n\t\t\t} else if(this_label === 'age') {\r\n\t\t\t\ttxt += d.data[this_label] +'y ';\r\n\t\t\t} else if(this_label === 'stillbirth') {\r\n\t\t\t\ttxt += \"SB\";\r\n\t\t\t} else if(this_label.match(\"_gene_test$\") && 'result' in d.data[this_label]) {\r\n\t\t\t\tlet r = d.data[this_label]['result'].toUpperCase();\r\n\t\t\t\t//let t = d.data[this_label]['type'];\r\n\t\t\t\tif(r !== \"-\") {\r\n\t\t\t\t\ttxt += this_label.replace('_gene_test', '').toUpperCase()\r\n\t\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\r\n\t\t\t\t}\r\n\t\t\t} else if(this_label.match(\"_bc_pathology$\")) {\r\n\t\t\t\tlet r = d.data[this_label].toUpperCase();\r\n\t\t\t\ttxt += this_label.replace('_bc_pathology', '').toUpperCase()\r\n\t\t\t\ttxt += (r === 'P' ? '+ ' : (r === 'N' ? '- ' : ' '));\r\n\t\t\t} else {\r\n\t\t\t  txt += d.data[this_label];\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\tif(txt !== \"\") return txt;\r\n}\r\n\r\nfunction ypos(d, arr, font_size) {\r\n\tif(!node_has_label(d, arr)) return;\r\n\td.y_offset = (!d.y_offset ? font_size*2.35 : d.y_offset+font_size);\r\n\treturn d.y_offset;\r\n}\r\n\r\nfunction node_has_label(d, labels) {\r\n\tfor(let l=0; l<labels.length; l++) {\r\n\t\tif(prefixInObj(labels[l], d.data)) return true;\r\n\t}\r\n\treturn false;\r\n}\r\n\r\n// add label to node\r\nfunction addLabel(opts, node, fx, fy, ftext, class_label, labels) {\r\n\tnode.filter(function (d) {\r\n\t\treturn !d.data.hidden && (!labels || node_has_label(d, labels));\r\n\t}).append(\"text\")\r\n\t.attr(\"class\", (class_label ? class_label + ' ped_label' : 'ped_label'))\r\n\t.attr(\"x\", fx)\r\n\t.attr(\"y\", fy)\r\n\t.attr(\"font-family\", opts.font_family)\r\n\t.attr(\"font-size\", opts.font_size)\r\n\t.attr(\"font-weight\", opts.font_weight)\r\n\t.text(ftext);\r\n}\r\n\r\n// get height in pixels\r\nfunction getPx(opts){\r\n\tlet emVal = opts.font_size;\r\n\tif (emVal === parseInt(emVal, 10)) // test if integer\r\n\t\treturn emVal;\r\n\r\n\tif(emVal.indexOf(\"px\") > -1)\r\n\t\treturn emVal.replace('px', '');\r\n\telse if(emVal.indexOf(\"em\") === -1)\r\n\t\treturn emVal;\r\n\temVal = parseFloat(emVal.replace('em', ''));\r\n\treturn (parseFloat(getComputedStyle($('#'+opts.targetDiv).get(0)).fontSize)*emVal)-1.0;\r\n}\r\n","import  * as utils from './utils.js';\r\nimport {current as pedcache_current} from './pedcache.js';\r\n\r\n\r\n// initialise node dragging - SHIFT + DRAG\r\nexport function init_dragging(opts, node) {\r\n\t// add drag\r\n\tnode.filter(function (d) {return !d.data.hidden;})\r\n\t    .call(d3.drag()\r\n\t\t\t\t.filter(function filter(event) {\r\n\t\t\t\t\treturn !event.ctrlKey && !event.button && event.shiftKey; \t// shift and drag\r\n\t\t\t\t})\r\n                .on(\"start\", dragstart)\r\n                .on(\"drag\", drag)\r\n                .on(\"end\", dragstop));\r\n\r\n\tlet xstart;\r\n\tlet xnew;\r\n\r\n    function dragstart() {\r\n\t\txstart = d3.select(this).select('.indi_rect').attr('x');\r\n\t}\r\n\t\r\n\tfunction drag(e) {\r\n\t\te.sourceEvent.stopPropagation();\r\n\t\tlet dx = e.dx;\r\n\t\tlet indir = d3.select(this).select('.indi_rect');\r\n\t\txnew = parseFloat(indir.attr('x'))+ dx;\r\n        indir.attr(\"x\", xnew);\r\n\t}\r\n\t\r\n\tfunction dragstop(_d) {\r\n\t\tlet me = d3.select(this).datum().data;\r\n\t\tlet pnrs = utils.get_partners(opts.dataset, me);\r\n\t\tlet pnrName = (pnrs.length === 1 ? utils.get_partners(opts.dataset, me)[0] : -1);\r\n\r\n\t\t// reset individuals rectangle\r\n\t\tlet indir = d3.select(this).select('.indi_rect');\r\n\t\tindir.attr(\"x\", xstart);\r\n\r\n\t\tconst isMovingRight = (xnew>xstart);\r\n\t\t\r\n\t\t// get depth of node being dragged\r\n\t\tlet root = utils.roots[opts.targetDiv];\r\n\t\tlet flat_tree = utils.flatten(root);\r\n\t\tlet meNode = utils.getNodeByName(flat_tree, me.name);\r\n\t\t\r\n\t\t// nodes at same depth\r\n\t\tlet dnodes = utils.getNodesAtDepth(utils.flatten(root), meNode.depth);\r\n\r\n\t\t// locate adjacent nodes\r\n\t\tlet lft_node, rgt_node, adj_node;\r\n\t\txnew += meNode.x;\r\n\t\tlet xlft = -Number.MAX_VALUE;\r\n\t\tlet xrgt =  Number.MAX_VALUE;\r\n\t\tfor(let i=0; i<dnodes.length; i++) {\r\n\t\t\tif(dnodes[i].x < xnew && dnodes[i].x > xlft) {\r\n\t\t\t\tlft_node = dnodes[i];\r\n\t\t\t\txlft = dnodes[i].x;\r\n\t\t\t} else if(dnodes[i].x > xnew && dnodes[i].x < xrgt) {\r\n\t\t\t\trgt_node = dnodes[i];\r\n\t\t\t\txrgt = dnodes[i].x;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(lft_node === undefined && rgt_node === undefined) return;\r\n\t\tlet adjIdx;\r\n\t\tif(isMovingRight) {\r\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, lft_node.data.name);\r\n\t\t\tadj_node = lft_node;\r\n\t\t} else {\r\n\t\t\tadjIdx = utils.getIdxByName(opts.dataset, rgt_node.data.name);\r\n\t\t\tadj_node = rgt_node;\r\n\t\t}\r\n\r\n\t\t// move node to new location in dataset\r\n        let newdataset = utils.copy_dataset(pedcache_current(opts));\r\n        let idx = utils.getIdxByName(opts.dataset, me.name);\r\n        el_move(newdataset, idx, adjIdx);\r\n        if(pnrName !== -1 && pnrName !== adj_node.data.name) {\r\n\t\t\tidx = utils.getIdxByName(newdataset, pnrName);\r\n\t\t\tel_move(newdataset, idx, adjIdx);\r\n        }\r\n        opts.dataset = newdataset;\r\n        $(document).trigger('rebuild', [opts]);\r\n\t}\r\n}\r\n\r\n// move element in array\r\nfunction el_move(arr, old_index, new_index) {\r\n    if (new_index >= arr.length) {\r\n        var k = new_index - arr.length + 1;\r\n        while (k--) {\r\n            arr.push(undefined);\r\n        }\r\n    }\r\n    arr.splice(new_index, 0, arr.splice(old_index, 1)[0]);\r\n    return arr;\r\n}\r\n","/**\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\n// Pedigree Tree Builder\r\nimport  * as utils from './utils.js';\r\nimport * as pbuttons from './pbuttons.js';\r\nimport * as pedcache from './pedcache.js';\r\nimport * as io from './io.js';\r\nimport {addWidgets} from './widgets.js';\r\nimport {init_zoom} from './zoom.js';\r\nimport {addLabels} from './labels.js';\r\nimport {init_dragging} from './dragging.js';\r\n\r\n\r\nexport function build(options) {\r\n\tlet opts = $.extend({ // defaults\r\n\t\ttargetDiv: 'pedigree_edit',\r\n\t\tdataset: [ {\"name\": \"m21\", \"sex\": \"M\", \"top_level\": true},\r\n\t\t\t\t   {\"name\": \"f21\", \"sex\": \"F\", \"top_level\": true},\r\n\t\t\t\t   {\"name\": \"ch1\", \"display_name\": \"Probando\", \"sex\": \"F\", \"mother\": \"f21\", \"father\": \"m21\", \"proband\": true}],\r\n\t\twidth: 600,\r\n\t\theight: 400,\r\n\t\tsymbol_size: 35,\r\n\t\tzoomSrc: ['wheel', 'button'],\r\n\t\tzoomIn: 1.0,\r\n\t\tzoomOut: 1.0,\r\n\t\tdragNode: true,\r\n\t\tshowWidgets: true,\r\n\t\tdiseases: [\t{'type': 'breast_cancer', 'colour': '#F68F35'},\r\n\t\t\t\t\t{'type': 'breast_cancer2', 'colour': 'pink'},\r\n\t\t\t\t\t{'type': 'ovarian_cancer', 'colour': '#306430'},\r\n\t\t\t\t\t{'type': 'pancreatic_cancer', 'colour': '#4289BA'},\r\n\t\t\t\t\t{'type': 'prostate_cancer', 'colour': '#D5494A'}],\r\n\t\tlabels: ['stillbirth', ['age', 'yob'], 'alleles',\r\n\t\t\t\t\t\t\t   ['brca1_gene_test', 'brca2_gene_test', 'palb2_gene_test', 'chek2_gene_test', 'atm_gene_test'],\r\n\t\t\t\t\t\t\t   ['rad51d_gene_test', 'rad51c_gene_test', 'brip1_gene_test', 'hoxb13_gene_test'],\r\n\t\t\t\t\t\t\t   ['er_bc_pathology', 'pr_bc_pathology', 'her2_bc_pathology', 'ck14_bc_pathology', 'ck56_bc_pathology']],\r\n\t\tkeep_proband_on_reset: false,\r\n\t\tfont_size: '.75em',\r\n\t\tfont_family: 'Helvetica',\r\n\t\tfont_weight: 700,\r\n\t\tbackground: \"#FAFAFA\",\r\n\t\tnode_background: '#fdfdfd',\r\n\t\tvalidate: true,\r\n\t\tDEBUG: false}, options );\r\n\r\n\tif ( $( \"#fullscreen\" ).length === 0 ) {\r\n\t\t// add undo, redo, fullscreen buttons and event listeners once\r\n\t\tpbuttons.addButtons(opts, rebuild, build);\r\n\t\tio.addIO(opts);\r\n\t}\r\n\r\n\tif(pedcache.nstore(opts) === -1)\r\n\t\tpedcache.init_cache(opts);\r\n\r\n\tpbuttons.updateButtons(opts);\r\n\r\n\t// validate pedigree data\r\n\tutils.validate_pedigree(opts);\r\n\t// group top level nodes by partners\r\n\topts.dataset = group_top_level(opts.dataset);\r\n\r\n\tif(opts.DEBUG)\r\n\t\tutils.print_opts(opts);\r\n\tlet svg_dimensions = utils.get_svg_dimensions(opts);\r\n\tlet svg = d3.select(\"#\"+opts.targetDiv)\r\n\t\t\t\t .append(\"svg:svg\")\r\n\t\t\t\t .attr(\"width\", svg_dimensions.width)\r\n\t\t\t\t .attr(\"height\", svg_dimensions.height);\r\n\r\n\tsvg.append(\"rect\")\r\n\t\t.attr(\"width\", \"100%\")\r\n\t\t.attr(\"height\", \"100%\")\r\n\t\t.attr(\"rx\", 6)\r\n\t\t.attr(\"ry\", 6)\r\n\t\t.style(\"stroke\", \"darkgrey\")\r\n\t\t.style(\"fill\", opts.background) // or none\r\n\t\t.style(\"stroke-width\", 1);\r\n\r\n\tlet ped = svg.append(\"g\")\r\n\t\t\t .attr(\"class\", \"diagram\");\r\n\r\n\tlet top_level = $.map(opts.dataset, function(val, _i){return 'top_level' in val && val.top_level ? val : null;});\r\n\tlet hidden_root = {\r\n\t\tname : 'hidden_root',\r\n\t\tid : 0,\r\n\t\thidden : true,\r\n\t\tchildren : top_level\r\n\t};\r\n\r\n\tlet partners = utils.buildTree(opts, hidden_root, hidden_root)[0];\r\n\tlet root = d3.hierarchy(hidden_root);\r\n\tutils.roots[opts.targetDiv] = root;\r\n\r\n\t// / get score at each depth used to adjust node separation\r\n\tlet tree_dimensions = utils.get_tree_dimensions(opts);\r\n\tif(opts.DEBUG)\r\n\t\tconsole.log('opts.width='+svg_dimensions.width+' width='+tree_dimensions.width+\r\n\t\t\t\t\t' opts.height='+svg_dimensions.height+' height='+tree_dimensions.height);\r\n\r\n\tlet treemap = d3.tree().separation(function(a, b) {\r\n\t\treturn a.parent === b.parent || a.data.hidden || b.data.hidden ? 1.2 : 2.2;\r\n\t}).size([tree_dimensions.width, tree_dimensions.height]);\r\n\r\n\tlet nodes = treemap(root.sort(function(a, b) { return a.data.id - b.data.id; }));\r\n\tlet flattenNodes = nodes.descendants();\r\n\r\n\t// check the number of visible nodes equals the size of the pedigree dataset\r\n\tlet vis_nodes = $.map(opts.dataset, function(p, _i){return p.hidden ? null : p;});\r\n\tif(vis_nodes.length !== opts.dataset.length) {\r\n\t\tthrow utils.create_err('NUMBER OF VISIBLE NODES DIFFERENT TO NUMBER IN THE DATASET');\r\n\t}\r\n\r\n\tutils.adjust_coords(opts, nodes, flattenNodes);\r\n\r\n\tlet ptrLinkNodes = utils.linkNodes(flattenNodes, partners);\r\n\tcheck_ptr_links(opts, ptrLinkNodes);   // check for crossing of partner lines\r\n\r\n\tlet node = ped.selectAll(\".node\")\r\n\t\t\t\t  .data(nodes.descendants())\r\n\t\t\t\t  .enter()\r\n\t\t\t\t  .append(\"g\")\r\n\t\t\t\t\t.attr(\"transform\", function(d, _i) {\r\n\t\t\t\t\t\treturn \"translate(\" + d.x + \",\" + d.y + \")\";\r\n\t\t\t\t\t});\r\n\r\n\t// provide a border to the node\r\n\tnode.filter(function (d) {return !d.data.hidden;})\r\n\t\t.append(\"path\")\r\n\t\t.attr(\"shape-rendering\", \"geometricPrecision\")\r\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\r\n\t\t.attr(\"d\", d3.symbol().size(function(_d) { return (opts.symbol_size * opts.symbol_size) + 2;})\r\n\t\t\t\t.type(function(d) {\r\n\t\t\t\t\tif(d.data.miscarriage || d.data.termination)\r\n\t\t\t\t\t\treturn d3.symbolTriangle;\r\n\t\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle : d3.symbolSquare;}))\r\n\t\t.style(\"stroke\", function (d) {\r\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\r\n\t\t})\r\n\t\t.style(\"stroke-width\", function (d) {\r\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \".3em\" : \".1em\";\r\n\t\t})\r\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\r\n\t\t.style(\"fill\", \"none\");\r\n\r\n\t// set a clippath\r\n\tnode.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);})\r\n\t\t.append(\"clipPath\")\r\n\t\t.attr(\"id\", function (d) {return d.data.name;}).append(\"path\")\r\n\t\t.attr(\"class\", \"node\")\r\n\t\t.attr(\"transform\", function(d) {return !has_gender(d.data.sex) && !(d.data.miscarriage || d.data.termination) ? \"rotate(45)\" : \"\";})\r\n\t\t.attr(\"d\", d3.symbol().size(function(d) {\r\n\t\t\t\tif (d.data.hidden)\r\n\t\t\t\t\treturn opts.symbol_size * opts.symbol_size / 5;\r\n\t\t\t\treturn opts.symbol_size * opts.symbol_size;\r\n\t\t\t})\r\n\t\t\t.type(function(d) {\r\n\t\t\t\tif(d.data.miscarriage || d.data.termination)\r\n\t\t\t\t\treturn d3.symbolTriangle;\r\n\t\t\t\treturn d.data.sex === \"F\" ? d3.symbolCircle :d3.symbolSquare;}));\r\n\r\n\t// pie plots for disease colours\r\n\tlet pienode = node.filter(function (d) {return !(d.data.hidden && !opts.DEBUG);}).selectAll(\"pienode\")\r\n\t   .data(function(d) {\t \t\t// set the disease data for the pie plot\r\n\t\t   let ncancers = 0;\r\n\t\t   let cancers = $.map(opts.diseases, function(_val, i){\r\n\t\t\t   if(utils.prefixInObj(opts.diseases[i].type, d.data)) {ncancers++; return 1;} else return 0;\r\n\t\t   });\r\n\t\t   if(ncancers === 0) cancers = [1];\r\n\t\t   return [$.map(cancers, function(val, _i){\r\n\t\t\t   return {'cancer': val, 'ncancers': ncancers, 'id': d.data.name,\r\n\t\t\t\t\t\t'sex': d.data.sex, 'proband': d.data.proband, 'hidden': d.data.hidden,\r\n\t\t\t\t\t\t'affected': d.data.affected,\r\n\t\t\t\t\t\t'exclude': d.data.exclude};})];\r\n\t   })\r\n\t   .enter()\r\n\t\t.append(\"g\");\r\n\r\n\tpienode.selectAll(\"path\")\r\n\t\t.data(d3.pie().value(function(d) {return d.cancer;}))\r\n\t\t.enter().append(\"path\")\r\n\t\t\t.attr(\"clip-path\", function(d) {return \"url(#\"+d.data.id+\")\";}) // clip the rectangle\r\n\t\t\t.attr(\"class\", \"pienode\")\r\n\t\t\t.attr(\"d\", d3.arc().innerRadius(0).outerRadius(opts.symbol_size))\r\n\t\t\t.style(\"fill\", function(d, i) {\r\n\t\t\t\tif(d.data.exclude)\r\n\t\t\t\t\treturn 'lightgrey';\r\n\t\t\t\tif(d.data.ncancers === 0) {\r\n\t\t\t\t\tif(d.data.affected)\r\n\t\t\t\t\t\treturn 'darkgrey';\r\n\t\t\t\t\treturn opts.node_background;\r\n\t\t\t\t}\r\n\t\t\t\treturn opts.diseases[i].colour;\r\n\t\t\t});\r\n\r\n\t// adopted in/out brackets\r\n\tnode.filter(function (d) {return !d.data.hidden && (d.data.adopted_in || d.data.adopted_out);})\r\n\t\t.append(\"path\")\r\n\t\t.attr(\"d\", function(_d) {\r\n\t\t\tlet dx = -(opts.symbol_size * 0.66);\r\n\t\t\tlet dy = -(opts.symbol_size * 0.64);\r\n\t\t\tlet indent = opts.symbol_size/4;\r\n\t\t\treturn get_bracket(dx, dy, indent, opts)+get_bracket(-dx, dy, -indent, opts);\r\n\t\t\t})\r\n\t\t.style(\"stroke\", function (d) {\r\n\t\t\treturn d.data.age && d.data.yob && !d.data.exclude ? \"#303030\" : \"grey\";\r\n\t\t})\r\n\t\t.style(\"stroke-width\", function (_d) {\r\n\t\t\treturn \".1em\";\r\n\t\t})\r\n\t\t.style(\"stroke-dasharray\", function (d) {return !d.data.exclude ? null : (\"3, 3\");})\r\n\t\t.style(\"fill\", \"none\");\r\n\r\n\r\n\t// alive status = 0; dead status = 1\r\n\tnode.filter(function (d) {return d.data.status === \"1\" || d.data.status === 1;})\r\n\t\t.append('line')\r\n\t\t\t.style(\"stroke\", \"black\")\r\n\t\t\t.attr(\"x1\", function(_d, _i) {return -0.6*opts.symbol_size;})\r\n\t\t\t.attr(\"y1\", function(_d, _i) {return 0.6*opts.symbol_size;})\r\n\t\t\t.attr(\"x2\", function(_d, _i) {return 0.6*opts.symbol_size;})\r\n\t\t\t.attr(\"y2\", function(_d, _i) {return -0.6*opts.symbol_size;});\r\n\r\n/*\r\n * let warn = node.filter(function (d) { return (!d.data.age || !d.data.yob) && !d.data.hidden; }).append(\"text\") .attr('font-family', 'FontAwesome')\r\n * .attr(\"x\", \".25em\") .attr(\"y\", -(0.4 * opts.symbol_size), -(0.2 * opts.symbol_size)) .html(\"\\uf071\"); warn.append(\"svg:title\").text(\"incomplete\");\r\n */\r\n\t// add display names and labels defined by opts.labels\r\n\taddLabels(opts, node);\r\n\r\n\t//\r\n\tif(opts.showWidgets) addWidgets(opts, node);\r\n\r\n\t// links between partners\r\n\tlet clash_depth = {};\r\n\r\n\t// get path looping over node(s)\r\n\tlet draw_path = function(clash, dx, dy1, dy2, parent_node, cshift) {\r\n\t\tlet extend = function(i, l) {\r\n\t\t\tif(i+1 < l)   // && Math.abs(clash[i] - clash[i+1]) < (opts.symbol_size*1.25)\r\n\t\t\t\treturn extend(++i);\r\n\t\t\treturn i;\r\n\t\t};\r\n\t\tlet path = \"\";\r\n\t\tfor(let j=0; j<clash.length; j++) {\r\n\t\t\tlet k = extend(j, clash.length);\r\n\t\t\tlet dx1 = clash[j] - dx - cshift;\r\n\t\t\tlet dx2 = clash[k] + dx + cshift;\r\n\t\t\tif(parent_node.x > dx1 && parent_node.x < dx2)\r\n\t\t\t\tparent_node.y = dy2;\r\n\r\n\t\t\tpath += \"L\" + dx1 + \",\" +  (dy1 - cshift) +\r\n\t\t\t\t\t\"L\" + dx1 + \",\" +  (dy2 - cshift) +\r\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy2 - cshift) +\r\n\t\t\t\t\t\"L\" + dx2 + \",\" +  (dy1 - cshift);\r\n\t\t\tj = k;\r\n\t\t}\r\n\t\treturn path;\r\n\t}\r\n\r\n\r\n\tpartners = ped.selectAll(\".partner\")\r\n\t\t.data(ptrLinkNodes)\r\n\t\t.enter()\r\n\t\t\t.insert(\"path\", \"g\")\r\n\t\t\t.attr(\"fill\", \"none\")\r\n\t\t\t.attr(\"stroke\", \"#000\")\r\n\t\t\t.attr(\"shape-rendering\", \"auto\")\r\n\t\t\t.attr('d', function(d, _i) {\r\n\t\t\t\tlet node1 = utils.getNodeByName(flattenNodes, d.mother.data.name);\r\n\t\t\t\tlet node2 = utils.getNodeByName(flattenNodes, d.father.data.name);\r\n\t\t\t\tlet consanguity = utils.consanguity(node1, node2, opts);\r\n\t\t\t\tlet divorced = (d.mother.data.divorced &&  d.mother.data.divorced === d.father.data.name);\r\n\r\n\t\t\t\tlet x1 = (d.mother.x < d.father.x ? d.mother.x : d.father.x);\r\n\t\t\t\tlet x2 = (d.mother.x < d.father.x ? d.father.x : d.mother.x);\r\n\t\t\t\tlet dy1 = d.mother.y;\r\n\t\t\t\tlet dy2, dx, parent_node;\r\n\r\n\t\t\t\t// identify clashes with other nodes at the same depth\r\n\t\t\t\tlet clash = check_ptr_link_clashes(opts, d);\r\n\t\t\t\tlet path = \"\";\r\n\t\t\t\tif(clash) {\r\n\t\t\t\t\tif(d.mother.depth in clash_depth)\r\n\t\t\t\t\t\tclash_depth[d.mother.depth] += 4;\r\n\t\t\t\t\telse\r\n\t\t\t\t\t\tclash_depth[d.mother.depth] = 4;\r\n\r\n\t\t\t\t\tdy1 -= clash_depth[d.mother.depth];\r\n\t\t\t\t\tdx = clash_depth[d.mother.depth] + (opts.symbol_size/2) + 2;\r\n\r\n\t\t\t\t\tlet parent_nodes = d.mother.data.parent_node;\r\n\t\t\t\t\tlet parent_node_name = parent_nodes[0];\r\n\t\t\t\t\tfor(let ii=0; ii<parent_nodes.length; ii++) {\r\n\t\t\t\t\t\tif(parent_nodes[ii].father.name === d.father.data.name &&\r\n\t\t\t\t\t\t   parent_nodes[ii].mother.name === d.mother.data.name)\r\n\t\t\t\t\t\t\tparent_node_name = parent_nodes[ii].name;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tparent_node = utils.getNodeByName(flattenNodes, parent_node_name);\r\n\t\t\t\t\tparent_node.y = dy1; // adjust hgt of parent node\r\n\t\t\t\t\tclash.sort(function (a,b) {return a - b;});\r\n\r\n\t\t\t\t\tdy2 = (dy1-(opts.symbol_size/2)-3);\r\n\t\t\t\t\tpath = draw_path(clash, dx, dy1, dy2, parent_node, 0);\r\n\t\t\t\t}\r\n\r\n\t\t\t\tlet divorce_path = \"\";\r\n\t\t\t\tif(divorced && !clash)\r\n\t\t\t\t\tdivorce_path = \"M\" + (x1+((x2-x1)*.66)+6) + \",\" + (dy1-6) +\r\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-6) + \",\" + (dy1+6) +\r\n\t\t\t\t\t\t\t\t   \"M\" + (x1+((x2-x1)*.66)+10) + \",\" + (dy1-6) +\r\n\t\t\t\t\t\t\t\t   \"L\"+  (x1+((x2-x1)*.66)-2)  + \",\" + (dy1+6);\r\n\t\t\t\tif(consanguity) {  // consanguinous, draw double line between partners\r\n\t\t\t\t\tdy1 = (d.mother.x < d.father.x ? d.mother.y : d.father.y);\r\n\t\t\t\t\tdy2 = (d.mother.x < d.father.x ? d.father.y : d.mother.y);\r\n\r\n\t\t\t\t\tlet cshift = 3;\r\n\t\t\t\t\tif(Math.abs(dy1-dy2) > 0.1) {\t  // DIFFERENT LEVEL\r\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + \"L\" + x2 + \",\" + dy2 +\r\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + \"L\" + x2 + \",\" + (dy2 - cshift);\r\n\t\t\t\t\t} else {\t\t\t\t\t\t   // SAME LEVEL\r\n\t\t\t\t\t\tlet path2 = (clash ? draw_path(clash, dx, dy1, dy2, parent_node, cshift) : \"\");\r\n\t\t\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 +\r\n\t\t\t\t\t\t\t\t\"M\" + x1 + \",\" + (dy1 - cshift) + path2 + \"L\" + x2 + \",\" + (dy1 - cshift) + divorce_path;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\treturn\t\"M\" + x1 + \",\" + dy1 + path + \"L\" + x2 + \",\" + dy1 + divorce_path;\r\n\t\t\t});\r\n\r\n\t// links to children\r\n\tped.selectAll(\".link\")\r\n\t\t.data(root.links(nodes.descendants()))\r\n\t\t.enter()\r\n\t\t\t.filter(function (d) {\r\n\t\t\t\t// filter unless debug is set\r\n\t\t\t\treturn (opts.DEBUG ||\r\n\t\t\t\t\t\t(d.target.data.noparents === undefined && d.source.parent !== null && !d.target.data.hidden));\r\n\t\t\t})\r\n\t\t\t.insert(\"path\", \"g\")\r\n\t\t\t.attr(\"fill\", \"none\")\r\n\t\t\t.attr(\"stroke-width\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\r\n\t\t\t\t\treturn 1;\r\n\t\t\t\treturn (opts.DEBUG ? 2 : 1);\r\n\t\t\t})\r\n\t\t\t.attr(\"stroke\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.noparents !== undefined || d.source.parent === null || d.target.data.hidden)\r\n\t\t\t\t\treturn 'pink';\r\n\t\t\t\treturn \"#000\";\r\n\t\t\t})\r\n\t\t\t.attr(\"stroke-dasharray\", function(d, _i) {\r\n\t\t\t\tif(!d.target.data.adopted_in) return null;\r\n\t\t\t\tlet dash_len = Math.abs(d.source.y-((d.source.y + d.target.y) / 2));\r\n\t\t\t\tlet dash_array = [dash_len, 0, Math.abs(d.source.x-d.target.x), 0];\r\n\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\r\n\t\t\t\tif(twins.length >= 1) dash_len = dash_len * 3;\r\n\t\t\t\tfor(let usedlen = 0; usedlen < dash_len; usedlen += 10)\r\n\t\t\t\t\t$.merge(dash_array, [5, 5]);\r\n\t\t\t\treturn dash_array;\r\n\t\t\t})\r\n\t\t\t.attr(\"shape-rendering\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin)\r\n\t\t\t\t\treturn \"geometricPrecision\";\r\n\t\t\t\treturn \"auto\";\r\n\t\t\t})\r\n\t\t\t.attr(\"d\", function(d, _i) {\r\n\t\t\t\tif(d.target.data.mztwin || d.target.data.dztwin) {\r\n\t\t\t\t\t// get twin position\r\n\t\t\t\t\tlet twins = utils.getTwins(opts.dataset, d.target.data);\r\n\t\t\t\t\tif(twins.length >= 1) {\r\n\t\t\t\t\t\tlet twinx = 0;\r\n\t\t\t\t\t\tlet xmin = d.target.x;\r\n\t\t\t\t\t\t//let xmax = d.target.x;\r\n\t\t\t\t\t\tfor(let t=0; t<twins.length; t++) {\r\n\t\t\t\t\t\t\tlet thisx = utils.getNodeByName(flattenNodes, twins[t].name).x;\r\n\t\t\t\t\t\t\tif(xmin > thisx) xmin = thisx;\r\n\t\t\t\t\t\t\t//if(xmax < thisx) xmax = thisx;\r\n\t\t\t\t\t\t\ttwinx += thisx;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\tlet xmid = ((d.target.x + twinx) / (twins.length+1));\r\n\t\t\t\t\t\tlet ymid = ((d.source.y + d.target.y) / 2);\r\n\r\n\t\t\t\t\t\tlet xhbar = \"\";\r\n\t\t\t\t\t\tif(xmin === d.target.x && d.target.data.mztwin) {\r\n\t\t\t\t\t\t\t// horizontal bar for mztwins\r\n\t\t\t\t\t\t\tlet xx = (xmid + d.target.x)/2;\r\n\t\t\t\t\t\t\tlet yy = (ymid + (d.target.y-(opts.symbol_size/2)))/2;\r\n\t\t\t\t\t\t\txhbar = \"M\" + xx + \",\" + yy +\r\n\t\t\t\t\t\t\t\t\t\"L\" + (xmid + (xmid-xx)) + \" \" + yy;\r\n\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\r\n\t\t\t\t\t\t\t   \"V\" + ymid +\r\n\t\t\t\t\t\t\t   \"H\" + xmid +\r\n\t\t\t\t\t\t\t   \"L\" + (d.target.x) + \" \" + (d.target.y-(opts.symbol_size/2)) +\r\n\t\t\t\t\t\t\t   xhbar;\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(d.source.data.mother) {   // check parents depth to see if they are at the same level in the tree\r\n\t\t\t\t\tlet ma = utils.getNodeByName(flattenNodes, d.source.data.mother.name);\r\n\t\t\t\t\tlet pa = utils.getNodeByName(flattenNodes, d.source.data.father.name);\r\n\r\n\t\t\t\t\tif(ma.depth !== pa.depth) {\r\n\t\t\t\t\t\treturn \"M\" + (d.source.x) + \",\" + ((ma.y + pa.y) / 2) +\r\n\t\t\t\t\t\t\t   \"H\" + (d.target.x) +\r\n\t\t\t\t\t\t\t   \"V\" + (d.target.y);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\r\n\t\t\t\treturn \"M\" + (d.source.x) + \",\" + (d.source.y ) +\r\n\t\t\t\t\t   \"V\" + ((d.source.y + d.target.y) / 2) +\r\n\t\t\t\t\t   \"H\" + (d.target.x) +\r\n\t\t\t\t\t   \"V\" + (d.target.y);\r\n\t\t\t});\r\n\r\n\t// draw proband arrow\r\n\tlet probandIdx  = utils.getProbandIndex(opts.dataset);\r\n\tif(typeof probandIdx !== 'undefined') {\r\n\t\tlet probandNode = utils.getNodeByName(flattenNodes, opts.dataset[probandIdx].name);\r\n\t\tlet triid = \"triangle\"+utils.makeid(3);\r\n\t\tped.append(\"svg:defs\").append(\"svg:marker\")\t// arrow head\r\n\t\t\t.attr(\"id\", triid)\r\n\t\t\t.attr(\"refX\", 6)\r\n\t\t\t.attr(\"refY\", 6)\r\n\t\t\t.attr(\"markerWidth\", 20)\r\n\t\t\t.attr(\"markerHeight\", 20)\r\n\t\t\t.attr(\"orient\", \"auto\")\r\n\t\t\t.append(\"path\")\r\n\t\t\t.attr(\"d\", \"M 0 0 12 6 0 12 3 6\")\r\n\t\t\t.style(\"fill\", \"black\");\r\n\r\n\t\tped.append(\"line\")\r\n\t\t\t.attr(\"x1\", probandNode.x-(opts.symbol_size/0.7))\r\n\t\t\t.attr(\"y1\", probandNode.y+(opts.symbol_size/1.4))\r\n\t\t\t.attr(\"x2\", probandNode.x-(opts.symbol_size/1.4))\r\n\t\t\t.attr(\"y2\", probandNode.y+(opts.symbol_size/4))\r\n\t\t\t.attr(\"stroke-width\", 1)\r\n\t\t\t.attr(\"stroke\", \"black\")\r\n\t\t\t.attr(\"marker-end\", \"url(#\"+triid+\")\");\r\n\t}\r\n\r\n\t// drag and zoom\r\n\tinit_zoom(opts, svg);\r\n\t// drag nodes\r\n\tif(opts.dragNode) init_dragging(opts, node);\r\n\treturn opts;\r\n}\r\n\r\nfunction has_gender(sex) {\r\n\treturn sex === \"M\" || sex === \"F\";\r\n}\r\n\r\n//adopted in/out brackets\r\nfunction get_bracket(dx, dy, indent, opts) {\r\n\treturn \t\"M\" + (dx+indent) + \",\" + dy +\r\n\t\t\t\"L\" + dx + \" \" + dy +\r\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\r\n\t\t\t\"L\" + dx + \" \" + (dy+(opts.symbol_size *  1.28)) +\r\n\t\t\t\"L\" + (dx+indent) + \",\" + (dy+(opts.symbol_size *  1.28))\r\n}\r\n\r\n// check for crossing of partner lines\r\nfunction check_ptr_links(opts, ptrLinkNodes){\r\n\tfor(let a=0; a<ptrLinkNodes.length; a++) {\r\n\t\tlet clash = check_ptr_link_clashes(opts, ptrLinkNodes[a]);\r\n\t\tif(clash)\r\n\t\t\tconsole.log(\"CLASH :: \"+ptrLinkNodes[a].mother.data.name+\" \"+ptrLinkNodes[a].father.data.name, clash);\r\n\t}\r\n}\r\n\r\nexport function check_ptr_link_clashes(opts, anode) {\r\n\tlet root = utils.roots[opts.targetDiv];\r\n\tlet flattenNodes = utils.flatten(root);\r\n\tlet mother, father;\r\n\tif('name' in anode) {\r\n\t\tanode = utils.getNodeByName(flattenNodes, anode.name);\r\n\t\tif(!('mother' in anode.data))\r\n\t\t\treturn null;\r\n\t\tmother = utils.getNodeByName(flattenNodes, anode.data.mother);\r\n\t\tfather = utils.getNodeByName(flattenNodes, anode.data.father);\r\n\t} else {\r\n\t\tmother = anode.mother;\r\n\t\tfather = anode.father;\r\n\t}\r\n\r\n\tlet x1 = (mother.x < father.x ? mother.x : father.x);\r\n\tlet x2 = (mother.x < father.x ? father.x : mother.x);\r\n\tlet dy = mother.y;\r\n\r\n\t// identify clashes with other nodes at the same depth\r\n\tlet clash = $.map(flattenNodes, function(bnode, _i){\r\n\t\treturn !bnode.data.hidden &&\r\n\t\t\t\tbnode.data.name !== mother.data.name &&  bnode.data.name !== father.data.name &&\r\n\t\t\t\tbnode.y === dy && bnode.x > x1 && bnode.x < x2 ? bnode.x : null;\r\n\t});\r\n\treturn clash.length > 0 ? clash : null;\r\n}\r\n\r\n// group top_level nodes by their partners\r\nfunction group_top_level(dataset) {\r\n\t// let top_level = $.map(dataset, function(val, i){return 'top_level' in val && val.top_level ? val : null;});\r\n\t// calculate top_level nodes\r\n\tfor(let i=0;i<dataset.length;i++) {\r\n\t\tif(utils.getDepth(dataset, dataset[i].name) === 2)\r\n\t\t\tdataset[i].top_level = true;\r\n\t}\r\n\r\n\tlet top_level = [];\r\n\tlet top_level_seen = [];\r\n\tfor(let i=0;i<dataset.length;i++) {\r\n\t\tlet node = dataset[i];\r\n\t\tif('top_level' in node && $.inArray(node.name, top_level_seen) === -1){\r\n\t\t\ttop_level_seen.push(node.name);\r\n\t\t\ttop_level.push(node);\r\n\t\t\tlet ptrs = utils.get_partners(dataset, node);\r\n\t\t\tfor(let j=0; j<ptrs.length; j++){\r\n\t\t\t\tif($.inArray(ptrs[j], top_level_seen) === -1) {\r\n\t\t\t\t\ttop_level_seen.push(ptrs[j]);\r\n\t\t\t\t\ttop_level.push(utils.getNodeByName(dataset, ptrs[j]));\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tlet newdataset = $.map(dataset, function(val, _i){return 'top_level' in val && val.top_level ? null : val;});\r\n\tfor (let i = top_level.length; i > 0; --i)\r\n\t\tnewdataset.unshift(top_level[i-1]);\r\n\treturn newdataset;\r\n}\r\n\r\nexport function rebuild(opts) {\r\n\t$(\"#\"+opts.targetDiv).empty();\r\n\tpedcache.init_cache(opts);\r\n\ttry {\r\n\t\tbuild(opts);\r\n\t} catch(e) {\r\n\t\tconsole.error(e);\r\n\t\tthrow e;\r\n\t}\r\n\r\n\ttry {\r\n\t\ttemplates.update(opts);\t\t// eslint-disable-line no-undef\r\n\t} catch(e) {\r\n\t\t// templates not declared\r\n\t}\r\n}\r\n\r\n$(document).on('rebuild', function(_e, opts){\r\n\trebuild(opts);\r\n})\r\n\r\n$(document).on('build', function(_e, opts){\r\n\tbuild(opts);\r\n})\r\n","/**\r\n/* Functions used by 3rd party apps\r\n/*\r\n/* © 2023 University of Cambridge\r\n/* SPDX-FileCopyrightText: 2023 University of Cambridge\r\n/* SPDX-License-Identifier: GPL-3.0-or-later\r\n**/\r\n\r\nimport {copy_dataset, getNodeByName, getProbandIndex} from './utils.js';\r\nimport {rebuild} from './pedigree.js';\r\nimport {delete_node_dataset} from './widgets.js';\r\nimport {addchild} from './widgets.js';\r\nimport {syncTwins} from './twins.js';\r\nimport * as pedcache from './pedcache.js';\r\n\r\n\r\n// Set or remove node attributes.\r\n// If a value is not provided the attribute is removed.\r\n// 'key' can be a list of keys or a single key.\r\nexport function node_attr(opts, name, keys, value){\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet node = getNodeByName(newdataset, name);\r\n\tif(!node){\r\n\t\tconsole.warn(\"No person defined\");\r\n\t\treturn;\r\n\t}\r\n\r\n\tif(!Array.isArray(keys)) {\r\n\t\tkeys = [keys];\r\n\t}\r\n\r\n\tif(value) {\r\n\t\tfor(let i=0; i<keys.length; i++) {\r\n\t\t\tlet k = keys[i];\r\n\t\t\t//console.log('VALUE PROVIDED', k, value, (k in node));\r\n\t\t\tif(k in node && keys.length === 1) {\r\n\t\t\t\tif(node[k] === value)\r\n\t\t\t\t\treturn;\r\n\t\t\t\ttry {\r\n\t\t\t\t   if(JSON.stringify(node[k]) === JSON.stringify(value))\r\n\t\t\t\t\t   return;\r\n\t\t\t\t} catch(e){\r\n\t\t\t\t\t// continue regardless of error\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tnode[k] = value;\r\n\t\t}\r\n\t} else {\r\n\t\tlet found = false;\r\n\t\tfor(let i=0; i<keys.length; i++) {\r\n\t\t\tlet k = keys[i];\r\n\t\t\t//console.log('NO VALUE PROVIDED', k, (k in node));\r\n\t\t\tif(k in node) {\r\n\t\t\t\tdelete node[k];\r\n\t\t\t\tfound = true;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif(!found)\r\n\t\t\treturn;\r\n\t}\r\n\tsyncTwins(newdataset, node);\r\n\topts.dataset = newdataset;\r\n\trebuild(opts);\r\n}\r\n\r\n// Set or remove proband attributes.\r\n// If a value is not provided the attribute is removed from the proband.\r\n// 'key' can be a list of keys or a single key.\r\nexport function proband_attr(opts, keys, value){\r\n\tlet proband = opts.dataset[ getProbandIndex(opts.dataset) ];\r\n\tnode_attr(opts, proband.name, keys, value);\r\n}\r\n\r\n// add a child to the proband; giveb sex, age, yob and breastfeeding months (optional)\r\nexport function proband_add_child(opts, sex, age, yob, breastfeeding){\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet proband = newdataset[ getProbandIndex(newdataset) ];\r\n\tif(!proband){\r\n\t\tconsole.warn(\"No proband defined\");\r\n\t\treturn;\r\n\t}\r\n\tlet newchild = addchild(newdataset, proband, sex, 1)[0];\r\n\tnewchild.age = age;\r\n\tnewchild.yob = yob;\r\n\tif(breastfeeding !== undefined)\r\n\t\tnewchild.breastfeeding = breastfeeding;\r\n\topts.dataset = newdataset;\r\n\trebuild(opts);\r\n\treturn newchild.name;\r\n}\r\n\r\n// delete node using the name\r\nexport function delete_node_by_name(opts, name){\r\n\tfunction onDone(opts, dataset) {\r\n\t\t// assign new dataset and rebuild pedigree\r\n\t\topts.dataset = dataset;\r\n\t\trebuild(opts);\r\n\t}\r\n\tlet newdataset = copy_dataset(pedcache.current(opts));\r\n\tlet node = getNodeByName(pedcache.current(opts), name);\r\n\tif(!node){\r\n\t\tconsole.warn(\"No node defined\");\r\n\t\treturn;\r\n\t}\r\n\tdelete_node_dataset(newdataset, node, opts, onDone);\r\n}\r\n"],"names":["max_limit","dict_cache","has_browser_storage","opts","store_type","undefined","mod","localStorage","setItem","removeItem","e","get_prefix","btn_target","get_arr","get_browser_store","item","getItem","sessionStorage","set_browser_store","name","clear_pedigree_data","prefix","store","items","i","length","key","indexOf","push","get_count","count","set_count","init_cache","dataset","JSON","stringify","console","warn","nstore","current","parse","previous","nst","next","parseInt","clear","clear_browser_store","setposition","x","y","zoom","zoomName","getposition","pos","parseFloat","it","arr","roots","isIE","ua","navigator","userAgent","isEdge","match","create_err","err","error","Error","validate_pedigree","validate","DEBUG","log","call","this","display_name","uniquenames","famids","p","hidden","mother","father","midx","getIdxByName","fidx","sex","$","inArray","famid","join","uc","unconnected","copy_dataset","id","sort","a","b","disallowed","newdataset","obj","prefixInObj","found","each","k","_n","messages","title","msg","onConfirm","dialog","modal","width","buttons","No","text","click","errModalEl","document","getElementById","modalTitle","querySelector","modalBodyInput","removeClass","on","off","cancelBtn","hasClass","addClass","textContent","showDialog","makeid","len","possible","charAt","Math","floor","random","buildTree","person","root","partnerLinks","children","getChildren","nodes","flatten","partners","_i","child","_j","m","getNodeByName","f","contains_parent","merge","ptr","parent","setChildrenId","gp","gmidx","gfidx","get_grandparents_idx","updateParent","parent_node","mztwin","dztwins","twins","getTwins","twin","dztwin","isProband","attr","combineArrays","arr1","arr2","include_children","connected","get_partners","getAllChildren","_child_idx","anode","ptrs","bnode","target","getProbandIndex","change","ii","nconnect","_idx","has_parent","noparents","names","map","val","proband","sibs","getSiblings","twin_type","getAllSiblings","getAdoptedSiblings","getDepth","idx","depth","top_level","getNodesAtDepth","fnodes","exclude_names","data","linkNodes","flattenNodes","links","ancestors","node","recurse","consanguity","node1","node2","ancestors1","ancestors2","names1","ancestor","names2","_index","flat","forEach","adjust_coords","xmid","overlap","descendants","diff","child1","child2","descendantsNames","descendant","nodesOverlap","xnew","n","abs","symbol_size","print_opts","remove","append","is_fullscreen","fullscreenElement","mozFullScreenElement","webkitFullscreenElement","msFullscreenElement","get_svg_dimensions","window","innerWidth","height","innerHeight","get_tree_dimensions","svg_dimensions","maxscore","generation","score","max_depth","Object","keys","string","toUpperCase","slice","pedcache","time","d","Date","getHours","getMinutes","getSeconds","getFullYear","getMonth","getDate","is_proband","results","RegExp","exec","location","href","age","yob","status","year","sum","zm","init_zoom","svg","xi","yi","d3","scaleExtent","zoomIn","zoomOut","filter","zoomSrc","type","button","transform","t","ped","select","targetDiv","zooming","xyk","zoomIdentity","scale","translate","btn_zoom","transition","duration","scaleBy","scale_to_fit","get_bounds","wid","xmax","xmin","hgt","ymax","ymin","get_dimensions","size","w","clientWidth","h","clientHeight","get_svg_size","max","get_pedigree_center","translateTo","setTimeout","scaleTo","Number","MAX_VALUE","sym","selectAll","g_elm","dg","getBBox","text_elements","_groups","txtsize","getTextSize","firstChild","nodeValue","font_family","font_size","getNodeSize","txt","font","fontSize","o","css","position","float","visibility","appendTo","s","addButtons","options","extend","btns","fa","lis","_e","local_dataset","trigger","exitFullscreen","msExitFullscreen","mozCancelFullScreen","webkitExitFullscreen","requestFullscreen","documentElement","mozRequestFullScreen","webkitRequestFullscreen","Element","ALLOW_KEYBOARD_INPUT","msRequestFullscreen","timeoutId","setInterval","clearInterval","stopPropagation","empty","reset","addPbuttonEvents","keep_proband_on_reset","selected","updateButtons","cancers","breast_cancer","breast_cancer2","ovarian_cancer","prostate_cancer","pancreatic_cancer","genetic_test1","genetic_test2","genetic_test4","pathology_tests","RISK_FACTOR_STORE","hasInput","v","trim","isEmpty","myObj","prototype","hasOwnProperty","get_prs_values","prs","alpha","zscore","percent","getGeneticTest","version","readCanRisk","boadicea_lines","lines","split","hdr","regexp","gt","ncol","ln","ops","j","replace","delim","indi","cancer","diagnosis_age","ashkenazi","gene_test","result","path_test","localeCompare","get_mdensity","mdensity","test","get_pedigree","meta","isanon","arguments","ethnicity","isInteger","toString","excl","exclude","probandIdx","pedigree_util","menarche","get_risk_factor","parity","first_birth","oc_use","mht_use","bmi","alcohol","menopause","tl","endo","cmsg","risk_factor_name","store_name","pathname","el","pop","get_surgical_ops","breast_cancer_prs","ovarian_cancer_prs","prostate_cancer_prs","addIO","files","reader","FileReader","onload","load_data","onerror","utils","readAsText","value","load","content","save_file","save","print","get_printable_svg","svg_download","img_download","copyStylesInline","destinationNode","sourceNode","containerElements","destChildNodes","childNodes","srcChildNodes","cd","tagName","style","currentStyle","getComputedStyle","styleLength","childStyle","st","mySt","setProperty","getPropertyValue","resolution","img_type","deferred","svg2img","find","when","apply","done","grep","html","img","open","write","createElement","download","body","appendChild","removeChild","get_svg_as_data_url","svgCopy","get","cloneNode","svgStr","XMLSerializer","serializeToString","btoa","unescape","encodeURIComponent","deferred_name","defaults","iscanvg","Deferred","imgsrc","canvas","context","getContext","fillStyle","fillRect","drawImage","resolve","toDataURL","clearRect","src","promise","unique_urls","svg_html","matches","str","myRegexp","c","lastIndex","index","getMatches","quote","m1","m2","newval","svg_div","clone","a4","constructor","Array","cssFiles","printWindow","headContent","close","focus","filename","file","Blob","msSaveOrOpenBlob","url","URL","createObjectURL","revokeObjectURL","canrisk_validation","risk_factors","readBoadiceaV4","canrisk_data","readCanRiskFile","to_process","process_ped","readLinkage","err1","message","acc_FamHist_ticked","acc_FamHist_Leave","RESULT","FLAG_FAMILY_MODAL","err3","err2","affected","alleles","unshift","_cancer","getLevel","updated","l","prt_lvl","level","fix_n_balance_levels","max_level","pidx","getPartnerIdx","update_parents_level","parents","ma","pa","svg_node","getUniqueTwinID","mz","splice","syncTwins","d1","d2","updateStatus","update_ashkn","is","pedcache_current","switches","iswitch","update_cancer_by_sex","approx_diagnosis_age","substring","round5","checked","tres","hoxb13_result","valid","update_diagnosis_age_widget","prop","hide","show","ovarian_cancer_diagnosis_age","closest","prostate_cancer_diagnosis_age","x1","x2","round","dragging","last_mouseover","addWidgets","popup_selection","square_title","circle_title","add_person","classed","datum","addsibling","addchild","highlight","dragstart","dragstop","_d","setLineDragPosition","drag","sourceEvent","dx","dy","ynew","drag_handle","fx","fy","widgets","addpartner","addparents","delete","styles","fill","edit","settings","widget","parentNode","opt","autoOpen","current_year","table","capitaliseFirstLetter","diseases","disease_colour","colour","kk","openEditDialog","delete_node_dataset","onDone","ctrlKey","nodeclick","xcoord","pointer","ycoord","y1","y2","nchild","ptr_name","twin_id","partner","newchildren","add_lhs","newbie","setMzTwin","flat_tree","tree_node","pid","node_mother","node_father","node_sibs","rid","lid","sid","faidx","moidx","tmpfa","orphans","nid","oid","oidx","ptr_node","adjacent_nodes","excludes","lhs_node","rhs_node","dnodes","deletes","d3node","ps","children_names","adj","del","twin_types","checkTwins","newopts","addLabels","addLabel","emVal","getPx","ilab","labels","label","isArray","ypos","get_text","disease","dis","this_label","vars","ivar","r","node_has_label","y_offset","ftext","class_label","font_weight","el_move","old_index","new_index","build","dragNode","showWidgets","background","node_background","pbuttons","io","top_level_seen","group_top_level","hidden_root","hierarchy","tree_dimensions","tree","separation","treemap","ptrLinkNodes","clash","check_ptr_link_clashes","check_ptr_links","enter","has_gender","miscarriage","termination","symbol","symbolTriangle","symbolCircle","symbolSquare","pienode","ncancers","_val","pie","arc","innerRadius","outerRadius","adopted_in","adopted_out","indent","get_bracket","clash_depth","draw_path","dy1","dy2","cshift","path","dx1","dx2","insert","divorced","parent_nodes","parent_node_name","divorce_path","source","dash_len","dash_array","usedlen","twinx","thisx","ymid","xhbar","xx","yy","probandNode","triid","xstart","event","shiftKey","indir","me","pnrName","isMovingRight","lft_node","rgt_node","adj_node","meNode","adjIdx","xlft","xrgt","init_dragging","rebuild","templates","update","node_attr","breastfeeding","newchild"],"mappings":"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"}